<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCAAB – Benchmarks</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
</head>
<body>
  <div class="container">
    <div class="row header">
      <h1>Benchmarks</h1>
      <div class="spacer"></div>
      <nav class="nav-links">
        <a href="/">Cards</a>
        <a href="/home">Dashboard</a>
      </nav>
      <button id="toggleContrast" class="pill" title="Toggle high contrast">High Contrast</button>
    </div>
    {% if note %}<div class="card mb8"><div class="muted">{{ note }}</div></div>{% endif %}
    {% if summary %}
      <div class="card mb8">
        <details open>
          <summary class="pill">Summary</summary>
          <div class="muted m4v8">Range: {{ summary.start }} → {{ summary.end }} · Bets: {{ summary.total_bets }} · Hit: {{ '%.1f' % (summary.hit_rate * 100) }}% · PnL: {{ '%.2f' % summary.total_pnl }}{% if summary.mae_total is defined and summary.mae_total is not none %} · MAE Total: {{ '%.2f' % summary.mae_total }}{% endif %}{% if summary.brier_ats is defined and summary.brier_ats is not none %} · Brier ATS: {{ '%.3f' % summary.brier_ats }}{% endif %}{% if summary.brier_ou is defined and summary.brier_ou is not none %} · Brier OU: {{ '%.3f' % summary.brier_ou }}{% endif %}{% if summary.auc_ats is defined and summary.auc_ats is not none %} · AUC ATS: {{ '%.3f' % summary.auc_ats }}{% endif %}{% if summary.auc_ou is defined and summary.auc_ou is not none %} · AUC OU: {{ '%.3f' % summary.auc_ou }}{% endif %}{% if summary.crps_total is defined and summary.crps_total is not none %} · CRPS Total: {{ '%.3f' % summary.crps_total }}{% endif %}</div>
        </details>
      </div>
    {% endif %}
    {% if daily_rows %}
      <div class="card">
        <details open>
          <summary class="pill">Daily</summary>
          <div class="diag-grid flex-row-wrap" aria-label="Daily metrics sparkline">
            {% for r in daily_rows %}
              <div class="pill small" tabindex="0">{{ r.date }} · Bets {{ r.ou_bets or 0 }}+{{ r.ats_bets or 0 }} · Hits {{ r.ou_hits or 0 }}+{{ r.ats_hits or 0 }} · PnL {{ '%.2f' % (r.total_pnl or 0) }}{% if r.mae_total_mean is defined and r.mae_total_mean is not none %} · MAE {{ '%.2f' % r.mae_total_mean }}{% endif %}</div>
            {% endfor %}
          </div>
          {% if daily_rows|length > 1 %}
            <div class="mt4">
              <div class="muted">PnL Trend</div>
              <svg id="pnlSpark" width="520" height="80" role="img" aria-label="PnL sparkline"></svg>
            </div>
            <div class="mt4">
              <div class="muted">Hit Rate Trend</div>
              <svg id="hitSpark" width="520" height="80" role="img" aria-label="Hit rate sparkline"></svg>
            </div>
            <div class="mt4">
              <div class="muted">MAE Total Trend</div>
              <svg id="maeSpark" width="520" height="80" role="img" aria-label="MAE total sparkline"></svg>
            </div>
            <script>
              (function(){
                var rows = {{ daily_rows|tojson }};
                var svg = document.getElementById('pnlSpark'); if(!svg||!rows||rows.length<2) return;
                var w=520,h=80,p=8;
                var xs = rows.map(function(r){ return r.total_pnl||0; });
                var min = Math.min.apply(null, xs), max = Math.max.apply(null, xs);
                var scaleX = function(i){ return p + i * ((w - 2*p) / (rows.length - 1)); };
                var scaleY = function(v){ if(max===min){ return h/2; } var t=(v-min)/(max-min); return h - (p + t*(h - 2*p)); };
                var path = '';
                rows.forEach(function(r,i){ var x=scaleX(i), y=scaleY(r.total_pnl||0); path += (i===0? 'M':'L') + x + ',' + y + ' '; });
                var line = document.createElementNS('http://www.w3.org/2000/svg','path');
                line.setAttribute('d', path.trim()); line.setAttribute('fill','none'); line.setAttribute('stroke','#1c7ed6'); line.setAttribute('stroke-width','2');
                svg.appendChild(line);
                // zero line
                var zeroY = scaleY(0);
                var z = document.createElementNS('http://www.w3.org/2000/svg','line');
                z.setAttribute('x1', p); z.setAttribute('x2', w-p); z.setAttribute('y1', zeroY); z.setAttribute('y2', zeroY);
                z.setAttribute('stroke','#555'); z.setAttribute('stroke-width','1'); z.setAttribute('stroke-dasharray','4,4');
                svg.appendChild(z);

                // Hit rate sparkline (ou+ats hits over bets)
                var svgH = document.getElementById('hitSpark'); if(svgH){
                  var hs = rows.map(function(r){ var b=(r.ou_bets||0)+(r.ats_bets||0); var h=(r.ou_hits||0)+(r.ats_hits||0); return b>0? (h/b) : null; }).filter(function(v){ return v!==null; });
                  if(hs.length>=2){
                    var minH = Math.min.apply(null, hs), maxH = Math.max.apply(null, hs);
                    var scaleYH = function(v){ if(maxH===minH){ return h/2; } var t=(v-minH)/(maxH-minH); return h - (p + t*(h - 2*p)); };
                    var pathH=''; var j=0;
                    rows.forEach(function(r,i){ var b=(r.ou_bets||0)+(r.ats_bets||0); var hts=(r.ou_hits||0)+(r.ats_hits||0); if(b>0){ var x=scaleX(j), y=scaleYH(hts/b); pathH += (j===0? 'M':'L') + x + ',' + y + ' '; j++; } });
                    var lh = document.createElementNS('http://www.w3.org/2000/svg','path'); lh.setAttribute('d', pathH.trim()); lh.setAttribute('fill','none'); lh.setAttribute('stroke','#2f9e44'); lh.setAttribute('stroke-width','2'); svgH.appendChild(lh);
                    // reference 0.5 line
                    var y50 = scaleYH(0.5); var l50 = document.createElementNS('http://www.w3.org/2000/svg','line'); l50.setAttribute('x1', p); l50.setAttribute('x2', w-p); l50.setAttribute('y1', y50); l50.setAttribute('y2', y50); l50.setAttribute('stroke','#555'); l50.setAttribute('stroke-width','1'); l50.setAttribute('stroke-dasharray','4,4'); svgH.appendChild(l50);
                  }
                }

                // MAE sparkline
                var svgM = document.getElementById('maeSpark'); if(svgM){
                  var ms = rows.map(function(r){ return (r.mae_total_mean!=null)? r.mae_total_mean : null; }).filter(function(v){ return v!==null; });
                  if(ms.length>=2){
                    var minM = Math.min.apply(null, ms), maxM = Math.max.apply(null, ms);
                    var scaleYM = function(v){ if(maxM===minM){ return h/2; } var t=(v-minM)/(maxM-minM); return h - (p + t*(h - 2*p)); };
                    var pathM=''; var k=0;
                    rows.forEach(function(r,i){ var v=(r.mae_total_mean!=null)? r.mae_total_mean : null; if(v!=null){ var x=scaleX(k), y=scaleYM(v); pathM += (k===0? 'M':'L') + x + ',' + y + ' '; k++; } });
                    var lm = document.createElementNS('http://www.w3.org/2000/svg','path'); lm.setAttribute('d', pathM.trim()); lm.setAttribute('fill','none'); lm.setAttribute('stroke','#e8590c'); lm.setAttribute('stroke-width','2'); svgM.appendChild(lm);
                    // threshold line at 10
                    var y10 = scaleYM(10.0); var l10 = document.createElementNS('http://www.w3.org/2000/svg','line'); l10.setAttribute('x1', p); l10.setAttribute('x2', w-p); l10.setAttribute('y1', y10); l10.setAttribute('y2', y10); l10.setAttribute('stroke','#555'); l10.setAttribute('stroke-width','1'); l10.setAttribute('stroke-dasharray','4,4'); svgM.appendChild(l10);
                  }
                }
              })();
            </script>
          {% endif %}
          {% if summary %}
            <div class="mt4">
              <a class="pill" href="/static/../outputs/backtest_daily.csv" download>Download CSV</a>
            </div>
          {% endif %}
        </details>
      </div>
    {% else %}
      <div class="card"><div class="muted">No backtest artifacts found.</div></div>
    {% endif %}
  </div>
  <script>
    (function(){
      var btn = document.getElementById('toggleContrast');
      if(btn){
        btn.addEventListener('click', function(){
          document.documentElement.classList.toggle('high-contrast');
          try{ localStorage.setItem('highContrast', document.documentElement.classList.contains('high-contrast')?'1':'0'); }catch(e){}
        });
        try{ if(localStorage.getItem('highContrast')==='1'){ document.documentElement.classList.add('high-contrast'); } }catch(e){}
      }
    })();
  </script>
</body>
</html>
