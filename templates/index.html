<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCAAB Betting – Cards</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
  <style>
    .basis-badge{display:inline-block;padding:0 4px;margin-left:4px;border-radius:3px;font-size:10px;line-height:14px;vertical-align:middle;}
    .basis-derived{background:#663399;color:#fff;}
    .basis-provider{background:#1b6d85;color:#fff;}
    .badge{display:inline-block;padding:0 4px;margin-left:4px;border-radius:3px;font-size:10px;line-height:14px;background:#444;color:#fff;vertical-align:middle;cursor:default;}
    .badge.cal{background:#0b7285;}
    .badge.raw{background:#5c940d;}
    .badge.adj{background:#d9480f;}
    .badge.toggle-raw{background:#495057;cursor:pointer;}
    .badge.toggle-raw:hover,.badge:hover{opacity:0.85;}
    /* Time pill styling: base + rollover emphasis */
    .pill.time-local{background:#12324e;border-color:#1d4d75;color:#f6f8ff;}
    .pill.time-local.rollover{background:#53257c;border-color:#6d36a5;color:#fff;}
    .pill.time-local.rollover::after{content:' • rollover';font-size:10px;margin-left:4px;opacity:0.85;}
    /* Ensure pill text is white for readability */
    .pill{color:#fff !important;}
    /* Compact card mode: reduces spacing, font sizes, and enables grid layout */
    .compact-card .card { padding: 8px; margin: 8px 0; }
    .compact-card .card h3, .compact-card .card h4 { margin: 4px 0; font-size: 0.95rem; }
    .compact-card .pill { padding: 2px 6px; font-size: 0.8rem; }
    .compact-card .section { margin: 6px 0; }
    .compact-card .kpi-row { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 6px; align-items: center; }
    .compact-card .kpi { background: rgba(255,255,255,0.06); border-radius: 6px; padding: 6px; font-size: 0.82rem; }
    .compact-card .bar { height: 8px; border-radius: 4px; }
    .compact-card .row-inline { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
    .compact-card .row-inline-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
    .compact-card .tiny { font-size: 0.75rem; opacity: 0.9; }
    .compact-card .wrap { display: flex; flex-wrap: wrap; gap: 6px; }
    .compact-card .nowrap { white-space: nowrap; }
    .compact-card .collapse-pad { padding: 4px 0; }
    /* Reduce large sliders width if present */
    .compact-card .slider { max-width: 100%; }
    /* Prevent vertical overflow by allowing content to wrap inline */
    .compact-card .stack { display: contents; }
  </style>
</head>
<body>
  <div id="notifyHost" aria-live="polite" class="notify-host"></div>
  {# Dynamic CSS removed; will apply colors via data attributes and a script to avoid template/CSS lint conflicts #}
  <div class="container {% if compact_mode %}compact-card{% endif %}">
    {# Removed top picks and season summary for declutter #}
    <div class="row header">
      <h1>NCAAB – Cards</h1>
      <div class="spacer"></div>
      <nav class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/finals">Final Scores</a>
        <a href="/recommendations">Recommendations</a>
        <a href="/stake-sheet">Stake Sheet</a>
        <a href="/coverage">Coverage</a>
        <a href="/calibration">Calibration</a>
        <button id="toggleContrast" class="pill" title="Toggle high contrast">High Contrast</button>
      </nav>
    </div>
    {% if status %}
      <div class="mb8 flex-row-wrap" id="statusStrip">
        {% if status.finalize %}
          {% if status.finalize.ready %}
            <span class="pill ok" title="All games finalized for {{ status.finalize.date }}">Finalize Ready</span>
            <a class="pill accent" href="/finalize?date={{ status.finalize.date }}" title="Trigger finalize for this date">Trigger Finalize</a>
          {% else %}
            <span class="pill warn" title="Finalized {{ status.finalize.final }} of {{ status.finalize.rows }}; {{ status.finalize.pending }} pending">Finalize: {{ status.finalize.final }}/{{ status.finalize.rows }}</span>
          {% endif %}
        {% endif %}
        {% if status.results_latest %}
          <a class="pill" title="Open results for date" href="/finals?date={{ status.results_latest }}">Results: {{ status.results_latest }}</a>
        {% endif %}
        {% if status.stake_latest %}
          <a class="pill" title="Open stake sheet for date" href="/stake-sheet?date={{ status.stake_latest }}">Stake: {{ status.stake_latest }}</a>
        {% endif %}
        {% if status.display_hash %}
          <span class="pill" title="Display hash present; alignment verified">Display Hash ✓</span>
        {% endif %}
        {% if status.providers %}
          <span class="pill provider-pill" title="ONNX providers available (click for details)">Providers: {{ status.ep_hint or 'n/a' }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.basis_share_total_cal is defined %}
          <span class="pill" title="Calibrated basis share (totals)">Cal%T {{ '%.0f' % (pipeline_stats.basis_share_total_cal * 100) }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.drift_total_delta_vs_median is defined %}
          <span class="pill" title="Delta vs 7-day median calibrated share (totals)">ΔCal7T {{ '%.1f' % (pipeline_stats.drift_total_delta_vs_median * 100) }}%</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.basis_share_margin_cal is defined %}
          <span class="pill" title="Calibrated basis share (margin)">Cal%M {{ '%.0f' % (pipeline_stats.basis_share_margin_cal * 100) }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.drift_margin_delta_vs_median is defined %}
          <span class="pill" title="Delta vs 7-day median calibrated share (margin)">ΔCal7M {{ '%.1f' % (pipeline_stats.drift_margin_delta_vs_median * 100) }}%</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.ece_total_roll7 is defined %}
          <span class="pill" title="7-day mean ECE total">ECE7T {{ '%.3f' % pipeline_stats.ece_total_roll7 }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.ece_margin_roll7 is defined %}
          <span class="pill" title="7-day mean ECE margin">ECE7M {{ '%.3f' % pipeline_stats.ece_margin_roll7 }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.sharpness_total_roll7 is defined %}
          <span class="pill" title="7-day sharpness total">Sharp7T {{ '%.2f' % pipeline_stats.sharpness_total_roll7 }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.sharpness_margin_roll7 is defined %}
          <span class="pill" title="7-day sharpness margin">Sharp7M {{ '%.2f' % pipeline_stats.sharpness_margin_roll7 }}</span>
        {% endif %}
        <button type="button" id="btnCopyProviders" class="pill">Copy Providers</button>
        <button type="button" id="btnExportStatus" class="pill">Export Status</button>
      </div>
    {% endif %}
    <div class="card mb8" id="filtersBar" aria-label="Quick Filters" role="region">
      <div class="flex-row-wrap m4v8">
        <label class="pill"><span>Edges ≥</span>
          <input type="number" id="edgeMinInput" min="0" max="100" step="1" value="5" class="filter-num" aria-label="Minimum edge percent">
          <span>%</span>
        </label>
        <label class="pill"><span>Confidence ≥</span>
          <input type="number" id="confMinInput" min="0" max="100" step="1" value="50" class="filter-num" aria-label="Minimum confidence percent">
          <span>%</span>
        </label>
        <label class="pill"><span>Over%_emp ≥</span>
          <input type="number" id="overEmpMinInput" min="0" max="100" step="1" value="0" class="filter-num" aria-label="Minimum empirical Over percent">
          <span>%</span>
        </label>
        <label class="pill"><span>ATS%_emp ≥</span>
          <input type="number" id="atsEmpMinInput" min="0" max="100" step="1" value="0" class="filter-num" aria-label="Minimum empirical ATS percent">
          <span>%</span>
        </label>
        <label class="pill"><input type="checkbox" id="onlyMarketAvail" aria-label="Only market available"> Market Available</label>
        <button id="applyFiltersBtn" class="pill accent">Apply Filters</button>
        <button id="clearFiltersBtn" class="pill">Clear</button>
        <div class="flex-row-wrap">
          <button id="presetStrongEdges" class="pill" title="Show edges ≥5%">Strong Edges</button>
          <button id="presetModEdges" class="pill" title="Show edges ≥3%">Moderate Edges</button>
          <button id="presetHighConf" class="pill" title="Show confidence ≥60%">High Confidence</button>
          <button id="presetMarketAvail" class="pill" title="Require market availability">Market Only</button>
        </div>
      </div>
      <div class="muted m4v8" id="filterSummary" aria-live="polite" role="status">Filtered: <span id="filteredCount">0</span> hidden · <span id="visibleCount">0</span> visible</div>
    </div>
    <div class="card mb8" id="sortBar" aria-label="Quick Sort" role="region">
      <div class="flex-row-wrap m4v8">
        <button id="sortByEdge" class="pill" title="Sort by Edge (desc)">Sort: Edge</button>
        <button id="sortByConf" class="pill" title="Sort by Confidence (desc)">Sort: Confidence</button>
        <button id="sortByFairDelta" class="pill" title="Sort by Fair vs Market delta (desc)">Sort: ΔFair-Mkt</button>
        <div class="spacer"></div>
        <label class="pill" title="Group cards by market"><input type="checkbox" id="groupByMarket"> Group by Market</label>
        <label class="pill" title="Group cards by book"><input type="checkbox" id="groupByBook"> Group by Book</label>
        <div class="spacer"></div>
        <label class="pill" title="Pin top-N by confidence"><span>Pin top</span> <input type="number" id="pinTopNConf" min="0" step="1" value="0" class="filter-num" aria-label="Pin top N by confidence"><span> by Conf</span></label>
        <label class="pill" title="Search teams/market"><span>Search</span> <input type="text" id="cardsSearch" placeholder="Team or market" class="archive-search" aria-label="Search cards"></label>
        <div class="spacer"></div>
        <label class="pill" title="Density">
          <span>Density</span>
          <select id="densityMode" aria-label="Card density">
            <option value="compact">Compact</option>
            <option value="standard" selected>Standard</option>
            <option value="detailed">Detailed</option>
          </select>
        </label>
        <button id="toggleRollover" class="pill" title="Show only rollover games (UTC spill)" aria-pressed="false">Show Rollover Only</button>
        <button id="shortcutsHelp" class="pill" title="Show keyboard shortcuts">Shortcuts</button>
        <button id="exportVisible" class="pill" title="Export visible cards to CSV">Export Visible</button>
        <button id="exportVisibleJson" class="pill" title="Export visible cards to JSON">Export JSON</button>
      </div>
    </div>
    <div id="providersModal" class="modal providers-modal hidden">
      <div class="modal-content providers-modal-content" role="dialog" aria-modal="true" aria-labelledby="providersTitle">
        <h3 id="providersTitle" class="providers-modal-title">ONNX Runtime Providers</h3>
        <div id="providersList" class="muted providers-modal-list">Loading...</div>
        <div class="mt12"><button id="closeProvidersModal" class="pill">Close</button><div class="close-hint">Press Esc to close</div></div>
      </div>
    </div>
    <script>
      (function(){
        // Lightweight notification system replacing missing external Noty
        const notifyHost = document.getElementById('notifyHost');
        function notify(type, text, opts){
          opts = opts || {};
          if(!notifyHost){ console.warn('notifyHost missing'); return; }
          const div = document.createElement('div');
          div.className = 'notify-item notify-' + (type||'info');
          div.innerHTML = '<span class="notify-text"></span><button class="notify-close" aria-label="Close">×</button>';
          div.querySelector('.notify-text').textContent = text;
          const ttl = typeof opts.ttl === 'number' ? opts.ttl : (type==='error'?8000:4000);
          let closed = false;
          function close(){ if(closed) return; closed = true; div.classList.add('hide'); setTimeout(()=>div.remove(),250); }
          div.querySelector('.notify-close').addEventListener('click', close);
          notifyHost.appendChild(div);
          if(ttl>0) setTimeout(close, ttl);
          return { close, el: div };
        }
        window.notify = notify;
        window.notifySuccess = (t,o)=>notify('success',t,o);
        window.notifyWarn = (t,o)=>notify('warn',t,o);
        window.notifyError = (t,o)=>notify('error',t,o);
        const _fetchErrKeys = new Set();
        window.reportFetchError = (key, err)=>{ if(_fetchErrKeys.has(key)) return; _fetchErrKeys.add(key); notifyError(key+': '+(err&&err.message?err.message:String(err))); };
        const chk = document.getElementById('autoRefreshChk');
        let timer = null;
        const modal = document.getElementById('providersModal');
        const modalList = document.getElementById('providersList');
        const closeBtn = document.getElementById('closeProvidersModal');
        const toggleContrastBtn = document.getElementById('toggleContrast');
        if(toggleContrastBtn){
          toggleContrastBtn.addEventListener('click', ()=>{
            document.documentElement.classList.toggle('high-contrast');
            try{ localStorage.setItem('highContrast', document.documentElement.classList.contains('high-contrast') ? '1':'0'); }catch(e){}
          });
          try{ if(localStorage.getItem('highContrast')==='1'){ document.documentElement.classList.add('high-contrast'); } }catch(e){}
        }
        function renderStatus(data){
          const el = document.getElementById('statusStrip');
          if(!el||!data) return;
          const parts = [];
          if(data.finalize){
            if(data.finalize.ready){ parts.push('<span class="pill ok" title="All games finalized for '+data.finalize.date+'">Finalize Ready</span>'); parts.push('<a class="pill accent" href="/finalize?date='+data.finalize.date+'" title="Trigger finalize for this date">Trigger Finalize</a>'); }
            else { parts.push('<span class="pill warn" title="Finalized '+data.finalize.final+' of '+data.finalize.rows+'; '+data.finalize.pending+' pending">Finalize: '+data.finalize.final+'/'+data.finalize.rows+'</span>'); }
          }
          if(data.results_latest){ parts.push('<a class="pill" title="Open results for date" href="/finals?date='+data.results_latest+'">Results: '+data.results_latest+'</a>'); }
          if(data.stake_latest){ parts.push('<a class="pill" title="Open stake sheet for date" href="/stake-sheet?date='+data.stake_latest+'">Stake: '+data.stake_latest+'</a>'); }
          if(data.display_hash){ parts.push('<span class="pill" title="Display hash present; alignment verified">Display Hash ✓</span>'); }
          if(Array.isArray(data.providers) && data.providers.length){
            const hint = (data.ep_hint||'n/a');
            parts.push('<span class="pill provider-pill" title="ONNX providers available (click for details)">Providers: '+hint+'</span>');
          }
          if(typeof data.basis_share_total_cal === 'number'){ parts.push('<span class="pill" title="Calibrated basis share (totals)">Cal%T '+Math.round(data.basis_share_total_cal*100)+'</span>'); }
          if(typeof data.drift_total_delta_vs_median === 'number'){ parts.push('<span class="pill" title="Delta vs 7-day median calibrated share (totals)">ΔCal7T '+(data.drift_total_delta_vs_median*100).toFixed(1)+'%</span>'); }
          if(typeof data.basis_share_margin_cal === 'number'){ parts.push('<span class="pill" title="Calibrated basis share (margin)">Cal%M '+Math.round(data.basis_share_margin_cal*100)+'</span>'); }
          if(typeof data.drift_margin_delta_vs_median === 'number'){ parts.push('<span class="pill" title="Delta vs 7-day median calibrated share (margin)">ΔCal7M '+(data.drift_margin_delta_vs_median*100).toFixed(1)+'%</span>'); }
          if(typeof data.ece_total_roll7 === 'number'){ parts.push('<span class="pill" title="7-day mean ECE total">ECE7T '+data.ece_total_roll7.toFixed(3)+'</span>'); }
          if(typeof data.ece_margin_roll7 === 'number'){ parts.push('<span class="pill" title="7-day mean ECE margin">ECE7M '+data.ece_margin_roll7.toFixed(3)+'</span>'); }
          if(typeof data.sharpness_total_roll7 === 'number'){ parts.push('<span class="pill" title="7-day sharpness total">Sharp7T '+data.sharpness_total_roll7.toFixed(2)+'</span>'); }
          if(typeof data.sharpness_margin_roll7 === 'number'){ parts.push('<span class="pill" title="7-day sharpness margin">Sharp7M '+data.sharpness_margin_roll7.toFixed(2)+'</span>'); }
          // Risk control pills (optional fields from /api/status)
          if(data.risk){
            var r = data.risk;
            if(typeof r.daily_loss_cap === 'number'){
              var used = (typeof r.daily_loss_used === 'number') ? r.daily_loss_used : null;
              var txt = 'LossCap '+r.daily_loss_cap.toFixed(1)+'u';
              if(used!==null) txt += ' ('+used.toFixed(1)+' used)';
              parts.push('<span class="pill" title="Daily loss cap">'+txt+'</span>');
            }
            if(typeof r.kelly_cap === 'number'){
              parts.push('<span class="pill" title="Kelly fraction cap">KellyCap '+(r.kelly_cap*100).toFixed(0)+'%</span>');
            }
            if(typeof r.exposure_cap_units === 'number'){
              parts.push('<span class="pill" title="Per-market exposure cap">Exposure '+r.exposure_cap_units.toFixed(1)+'u</span>');
            }
          }
          el.innerHTML = parts.join(' ');
          const provPill = el.querySelector('.provider-pill');
          if(provPill){
            provPill.addEventListener('click', async ()=>{
              if(modal){
                modal.style.display='block';
                // focus trap basic: move focus to close button
                if(closeBtn){ closeBtn.focus(); }
                if(modalList) modalList.textContent='Loading...';
                try {
                  const r = await fetch('/api/ort-providers');
                  const j = await r.json();
                  if(modalList) modalList.textContent = JSON.stringify(j, null, 2);
                } catch(e){ if(modalList) modalList.textContent='Error loading providers'; }
              }
            });
          }
        }
        async function poll(){
          try{
            const r = await fetch('/api/status');
            const j = await r.json();
            renderStatus(j);
            window.__lastStatusPayload = j;
            // Adjust polling cadence based on server timestamp proximity
            try {
              const ts = j && j.server_timestamp ? Date.parse(j.server_timestamp) : null;
              if(ts){
                const now = Date.now();
                const skewMs = Math.abs(now - ts);
                // If skew is high or finalize suggested, poll faster
                const base = (j.finalize_suggested || (j.finalize && j.finalize.ready)) ? 15000 : 30000;
                const fast = (skewMs > 120000) ? 15000 : base;
                if(timer){ clearInterval(timer); }
                      notifySuccess('Providers loaded ('+j.length+')');
                timer = setInterval(poll, fast);
              }
                      notifyWarn('No providers reported');
            } catch(e){}
                  } catch(e){ if(modalList) modalList.textContent='Error loading providers'; reportFetchError('Providers', e); }
        function sortCards(attr){
          var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
          if(!grid) return;
          var cards = Array.from(grid.querySelectorAll('.game-card'));
          cards.sort(function(a,b){
            var av = parseFloat(a.getAttribute('data-'+attr) || 'NaN');
            var bv = parseFloat(b.getAttribute('data-'+attr) || 'NaN');
            if(isNaN(av) && isNaN(bv)) return 0;
            if(isNaN(av)) return 1;
            if(isNaN(bv)) return -1;
            return bv - av;
          });
          // Micro-performance: chunk DOM moves to avoid long reflow
          var i = 0;
          function chunk(){
            var end = Math.min(i+50, cards.length);
            for(; i<end; i++){ grid.appendChild(cards[i]); }
            if(i < cards.length){ requestAnimationFrame(chunk); } else {
              try { window.updateFilterSummary && window.updateFilterSummary(); } catch(e){}
            }
          }
          requestAnimationFrame(chunk);
          showToast('Sorted by '+attr, 'neutral');
            }catch(e){ reportFetchError('Status Poll', e); }
        function groupCards(by){
          var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
          if(!grid) return;
          var cards = Array.from(grid.querySelectorAll('.game-card'));
          var groups = new Map();
          cards.forEach(function(card){
            var key = card.getAttribute('data-'+by) || '';
            if(!key){ key = 'Other'; }
            if(!groups.has(key)) groups.set(key, []);
            groups.get(key).push(card);
          });
          // Clear grid and reinsert with simple headers
          var frag = document.createDocumentFragment();
          groups.forEach(function(list, key){
            var header = document.createElement('div');
            header.className = 'card mb4';
            header.setAttribute('role','heading');
            var label = key;
            if(by === 'market'){ label = 'Market: ' + key; }
            header.innerHTML = '<div class="title-sm">'+label+'</div>';
            frag.appendChild(header);
            list.forEach(function(c){ frag.appendChild(c); });
          });
          grid.innerHTML = '';
          grid.appendChild(frag);
          try { window.updateFilterSummary && window.updateFilterSummary(); } catch(e){}
          showToast('Grouped by '+by, 'neutral');
        }
        function ungroupCards(){
          var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
          if(!grid) return;
          // remove headers, keep cards order
          var items = Array.from(grid.children);
          var cards = items.filter(function(el){ return el.classList && el.classList.contains('game-card'); });
          grid.innerHTML = '';
          cards.forEach(function(c){ grid.appendChild(c); });
          try { window.updateFilterSummary && window.updateFilterSummary(); } catch(e){}
          showToast('Ungrouped', 'neutral');
        }
        function enhanceComparePanels(){
          var cards = document.querySelectorAll('.game-card');
          cards.forEach(function(card){
            // Avoid double init
            if(card.__compareInit) return; card.__compareInit = true;
            var fair = parseFloat(card.getAttribute('data-fair-price') || 'NaN');
            var mkt = parseFloat(card.getAttribute('data-market-price') || 'NaN');
            if(isNaN(fair) && isNaN(mkt)) return;
            var panel = document.createElement('div');
            panel.className = 'muted m4v8 compare-panel';
            var deltaTxt = '';
            if(!isNaN(fair) && !isNaN(mkt)){
              var d = fair - mkt;
              deltaTxt = 'ΔFair-Mkt: '+d.toFixed(2)+' ('+fair.toFixed(2)+' vs '+mkt.toFixed(2)+')';
            } else if(!isNaN(fair)) {
              deltaTxt = 'Fair: '+fair.toFixed(2);
            } else if(!isNaN(mkt)) {
              deltaTxt = 'Market: '+mkt.toFixed(2);
            }
            panel.textContent = deltaTxt;
            var toggle = document.createElement('button');
            toggle.className = 'pill';
            toggle.textContent = 'Compare';
            toggle.addEventListener('click', function(){
              panel.style.display = (panel.style.display==='none' || !panel.style.display) ? 'block' : 'none';
            });
            // Insert at footer area if present else append
            card.appendChild(toggle);
            card.appendChild(panel);
            panel.style.display = 'none';
          });
        }
        function addActionStrip(card){
          if(card.__actionStripInit) return; card.__actionStripInit = true;
          var edge = parseFloat(card.getAttribute('data-edge')||'NaN');
          var conf = parseFloat(card.getAttribute('data-confidence')||'NaN');
          var fair = parseFloat(card.getAttribute('data-fair-price')||'NaN');
          var mkt = parseFloat(card.getAttribute('data-market-price')||'NaN');
          var ev = parseFloat(card.getAttribute('data-ev')||'NaN');
          var parts = [];
          if(!isNaN(edge)) parts.push('<span class="kpi-item kpi-edge" title="Edge">▲ '+edge.toFixed(1)+'%</span>');
          if(!isNaN(conf)) parts.push('<span class="kpi-item kpi-conf" title="Confidence">✓ '+conf.toFixed(0)+'%</span>');
          if(!isNaN(fair) && !isNaN(mkt)){
            var d = fair - mkt; parts.push('<span class="kpi-item kpi-delta" title="Fair minus Market">⇄ '+d.toFixed(2)+'</span>');
          }
          if(!isNaN(ev)) parts.push('<span class="kpi-item kpi-ev" title="Expected Value">∑ '+ev.toFixed(3)+'</span>');
          if(!parts.length) return;
          var strip = document.createElement('div');
          strip.className = 'muted m4v8';
          strip.setAttribute('aria-label','Action summary');
          strip.innerHTML = parts.join(' · ');
          card.appendChild(strip);
        }
        function lazyHydrate(){
          var observer = new IntersectionObserver(function(entries){
            entries.forEach(function(entry){
              if(entry.isIntersecting){
                var card = entry.target;
                addActionStrip(card);
                // Badge enhancement for EV/implied prob
                if(!card.__badgesInit){
                  card.__badgesInit = true;
                  var ev = card.getAttribute('data-ev');
                  var imp = card.getAttribute('data-implied-prob');
                  var container = card.querySelector('.kpi') || card;
                  if(ev && !isNaN(parseFloat(ev))){
                    var evBadge = document.createElement('div');
                    evBadge.className = 'pill ev-pill';
                    evBadge.title = 'Expected value';
                    evBadge.textContent = 'EV: '+parseFloat(ev).toFixed(3);
                    container.appendChild(evBadge);
                  }
                  if(imp && !isNaN(parseFloat(imp))){
                    var ipBadge = document.createElement('div');
                    ipBadge.className = 'pill prob-pill';
                    ipBadge.title = 'Implied probability';
                    ipBadge.textContent = 'Imp: '+(parseFloat(imp)*100).toFixed(1)+'%';
                    container.appendChild(ipBadge);
                  }
                }
                observer.unobserve(card);
              }
            });
          }, { rootMargin: '100px' });
          document.querySelectorAll('.game-card').forEach(function(card){ observer.observe(card); });
        }
        // Wire sort buttons
        document.addEventListener('DOMContentLoaded', function(){
          var btnE = document.getElementById('sortByEdge');
          var btnC = document.getElementById('sortByConf');
          var btnD = document.getElementById('sortByFairDelta');
          var btnRollover = document.getElementById('toggleRollover');
          if(btnE) btnE.addEventListener('click', function(){ sortCards('edge'); });
          if(btnC) btnC.addEventListener('click', function(){ sortCards('confidence'); });
          if(btnD) btnD.addEventListener('click', function(){ sortCards('fair-delta'); });
          if(btnRollover){
            btnRollover.addEventListener('click', function(){
              var active = btnRollover.getAttribute('aria-pressed') === 'true';
              if(!active){
                // Activate rollover filter: hide all cards whose time-local pill data-rollover != 1
                var cards = document.querySelectorAll('.game-card');
                var hidden = 0; var visible = 0;
                cards.forEach(function(card){
                  var pill = card.querySelector('.time-local');
                  var isRoll = pill && pill.getAttribute('data-rollover') === '1';
                  if(!isRoll){ card.style.display='none'; hidden++; } else { card.style.display=''; visible++; }
                });
                btnRollover.textContent='Show All Games';
                btnRollover.setAttribute('aria-pressed','true');
                showToast('Filtered rollover games', 'neutral');
              } else {
                // Deactivate: show all
                document.querySelectorAll('.game-card').forEach(function(card){ card.style.display=''; });
                btnRollover.textContent='Show Rollover Only';
                btnRollover.setAttribute('aria-pressed','false');
                showToast('Cleared rollover filter', 'neutral');
              }
              try{ window.updateFilterSummary && window.updateFilterSummary(); }catch(e){}
            });
          }
          var chkM = document.getElementById('groupByMarket');
          var chkB = document.getElementById('groupByBook');
          if(chkM){ chkM.addEventListener('change', function(){ if(chkM.checked){ groupCards('market'); if(chkB) chkB.checked=false; try{ localStorage.setItem('groupPref','market'); }catch(e){} } else { ungroupCards(); try{ localStorage.removeItem('groupPref'); }catch(e){} } }); }
          if(chkB){ chkB.addEventListener('change', function(){ if(chkB.checked){ groupCards('book'); if(chkM) chkM.checked=false; try{ localStorage.setItem('groupPref','book'); }catch(e){} } else { ungroupCards(); try{ localStorage.removeItem('groupPref'); }catch(e){} } }); }
          enhanceComparePanels();
          lazyHydrate();
          // Enhance badges: add EV / implied prob badges if attributes available
          (function(){
            var cards = document.querySelectorAll('.game-card');
            cards.forEach(function(card){
              if(card.__badgesInit) return; card.__badgesInit = true;
              var ev = card.getAttribute('data-ev');
              var imp = card.getAttribute('data-implied-prob');
              var container = card.querySelector('.kpi') || card;
              if(ev && !isNaN(parseFloat(ev))){
                var evBadge = document.createElement('div');
                evBadge.className = 'pill ev-pill';
                evBadge.title = 'Expected value';
                evBadge.textContent = 'EV: '+parseFloat(ev).toFixed(3);
                container.appendChild(evBadge);
              }
              if(imp && !isNaN(parseFloat(imp))){
                var ipBadge = document.createElement('div');
                ipBadge.className = 'pill prob-pill';
                ipBadge.title = 'Implied probability';
                ipBadge.textContent = 'Imp: '+(parseFloat(imp)*100).toFixed(1)+'%';
                container.appendChild(ipBadge);
              }
            });
          })();
          // Restore grouping preference
          try{
            var pref = localStorage.getItem('groupPref');
            if(pref==='market' && chkM){ chkM.checked=true; groupCards('market'); }
            if(pref==='book' && chkB){ chkB.checked=true; groupCards('book'); }
          }catch(e){}
          // Sticky shadow on scroll
          (function(){
            var fb = document.getElementById('filtersBar');
            var sb = document.getElementById('sortBar');
            function updateShadow(){
              var y = window.scrollY||document.documentElement.scrollTop||0;
              if(fb && y>4){ fb.classList.add('sticky-shadow'); } else if(fb){ fb.classList.remove('sticky-shadow'); }
              if(sb && y>4){ sb.classList.add('sticky-shadow'); } else if(sb){ sb.classList.remove('sticky-shadow'); }
            }
            updateShadow();
            window.addEventListener('scroll', updateShadow, {passive:true});
          })();
          // Pin top-N by edge
          (function(){
            var input = document.getElementById('pinTopN');
            function applyPin(){
              var n = parseInt(input && input.value || '0');
              var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
              if(!grid) return;
              var cards = Array.from(grid.querySelectorAll('.game-card'));
              cards.forEach(function(c){ c.classList.remove('pinned'); });
              if(!n || n<=0) return;
              cards.sort(function(a,b){
                var av = parseFloat(a.getAttribute('data-edge')||'NaN');
                var bv = parseFloat(b.getAttribute('data-edge')||'NaN');
                if(isNaN(av) && isNaN(bv)) return 0;
                if(isNaN(av)) return 1;
                if(isNaN(bv)) return -1;
                return bv - av;
              });
              cards.slice(0, Math.min(n, cards.length)).forEach(function(c){ c.classList.add('pinned'); });
            }
            if(input){ input.addEventListener('change', applyPin); applyPin(); }
          })();
          // Pin top-N by confidence
          (function(){
            var input = document.getElementById('pinTopNConf');
            function applyPin(){
              var n = parseInt(input && input.value || '0');
              var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
              if(!grid) return;
              var cards = Array.from(grid.querySelectorAll('.game-card'));
              // Do not clear .pinned from edge pin; allow overlap
              if(!n || n<=0) return;
              cards.sort(function(a,b){
                var av = parseFloat(a.getAttribute('data-confidence')||'NaN');
                var bv = parseFloat(b.getAttribute('data-confidence')||'NaN');
                if(isNaN(av) && isNaN(bv)) return 0;
                if(isNaN(av)) return 1;
                if(isNaN(bv)) return -1;
                return bv - av;
              });
              cards.slice(0, Math.min(n, cards.length)).forEach(function(c){ c.classList.add('pinned'); });
            }
            if(input){ input.addEventListener('change', applyPin); }
          })();
          // Micro search
          (function(){
            var input = document.getElementById('cardsSearch');
            function applySearch(){
              var q = (input && input.value || '').toLowerCase();
              try{ localStorage.setItem('cardsSearch', q); }catch(e){}
              var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
              if(!grid) return;
              var cards = Array.from(grid.querySelectorAll('.game-card'));
              cards.forEach(function(card){
                var txt = (card.textContent || '').toLowerCase();
                card.style.display = q && !txt.includes(q) ? 'none' : '';
              });
              try { window.updateFilterSummary && window.updateFilterSummary(); } catch(e){}
            }
            if(input){
              try{ var saved = localStorage.getItem('cardsSearch'); if(saved){ input.value = saved; } }catch(e){}
              input.addEventListener('input', applySearch);
              applySearch();
            }
          })();
          // Keyboard shortcuts
          (function(){
            document.addEventListener('keydown', function(e){
              if(!e.altKey) return;
              if(e.key==='1'){ sortCards('edge'); }
              if(e.key==='2'){ sortCards('confidence'); }
              if(e.key==='3'){ sortCards('fair-delta'); }
              if(e.key==='m'){ var chk = document.getElementById('groupByMarket'); if(chk){ chk.checked=!chk.checked; chk.dispatchEvent(new Event('change')); } }
              if(e.key==='b'){ var chk = document.getElementById('groupByBook'); if(chk){ chk.checked=!chk.checked; chk.dispatchEvent(new Event('change')); } }
              if(e.key==='g'){ var cm=document.getElementById('groupByMarket'); var cb=document.getElementById('groupByBook'); if(cm) cm.checked=false; if(cb) cb.checked=false; ungroupCards(); }
              if(e.key==='d'){ var sel=document.getElementById('densityMode'); if(sel){ var idx=Math.max(0, sel.selectedIndex); sel.selectedIndex=(idx+1)%sel.options.length; sel.dispatchEvent(new Event('change')); } }
              if(e.key==='e'){ var btn=document.getElementById('exportVisible'); if(btn){ btn.click(); } }
              if(e.key==='j'){ var btnJ=document.getElementById('exportVisibleJson'); if(btnJ){ btnJ.click(); } }
            });
          })();
          // Shortcuts help
          (function(){
            var btn = document.getElementById('shortcutsHelp');
            if(!btn) return;
            btn.addEventListener('click', function(){
              var lines = [
                'Alt+1: Sort by Edge',
                'Alt+2: Sort by Confidence',
                'Alt+3: Sort by ΔFair-Mkt',
                'Alt+M: Group by Market',
                'Alt+B: Group by Book',
                'Alt+G: Ungroup',
                'Alt+D: Cycle Density',
                'Alt+E: Export CSV',
                'Alt+J: Export JSON'
              ];
              showToast('Shortcuts:\n'+lines.join('\n'), 'neutral');
            });
          })();
          // Density toggle
          (function(){
            var sel = document.getElementById('densityMode');
            function apply(mode){
              var m = mode || (sel ? sel.value : 'standard');
              document.body.classList.toggle('cards-compact', m==='compact');
              // Toggle detailed-only visibility
              document.querySelectorAll('.detailed-only').forEach(function(el){
                el.style.display = (m==='detailed') ? '' : 'none';
              });
              try{ localStorage.setItem('cardsDensity', m); }catch(e){}
            }
            if(sel){
              try{ var saved = localStorage.getItem('cardsDensity'); if(saved){ sel.value = saved; } }catch(e){}
              apply(sel.value);
              sel.addEventListener('change', function(){ apply(sel.value); });
            } else {
              apply('standard');
            }
          })();
          // Export visible cards to CSV
          (function(){
            var btn = document.getElementById('exportVisible');
            function exportCSV(){
              var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
              if(!grid) return;
              var cards = Array.from(grid.querySelectorAll('.game-card'));
              var rows = [];
              cards.forEach(function(card){
                if(card.style.display==='none') return;
                var row = {
                  game: (card.querySelector('.title-sm') ? card.querySelector('.title-sm').textContent.trim() : ''),
                  edge: card.getAttribute('data-edge')||'',
                  confidence: card.getAttribute('data-confidence')||'',
                  market_available: card.getAttribute('data-market-available')||'',
                  fair_price: card.getAttribute('data-fair-price')||'',
                  market_price: card.getAttribute('data-market-price')||'',
                  ev: card.getAttribute('data-ev')||'',
                  implied_prob: card.getAttribute('data-implied-prob')||'',
                  p_over_emp: card.getAttribute('data-p-over-emp')||'',
                  p_home_cover_emp: card.getAttribute('data-p-home-cover-emp')||''
                };

                // Post-render cleanup: hide empty Odds/Actuals/Derivatives blocks and clean time headers
                function cleanupCards(){
                  const cards = document.querySelectorAll('.game-card');
                  cards.forEach(card=>{
                    // Hide sections where all values are "–" or contain "nan"
                    ['.section-odds','.section-actuals','.section-derivatives'].forEach(sel=>{
                      const sec = card.querySelector(sel);
                      if(!sec) return;
                      const txt = sec.textContent.trim().toLowerCase();
                      if(!txt || txt === '-' || txt.indexOf('nan')>=0 || txt.indexOf('—')>=0){
                        sec.classList.add('hidden');
                      }
                    });
                    // Ensure predictions section visible
                    const pred = card.querySelector('.section-predictions');
                    if(pred){ pred.classList.remove('hidden'); }
                    // Clean time header: prefer data attributes if present
                    const timePill = card.querySelector('.pill.time-local');
                    if(timePill){
                      const disp = timePill.getAttribute('data-display');
                      const tz = timePill.getAttribute('data-tz');
                      if(disp){
                        timePill.textContent = disp + (tz?(' '+tz):'');
                      }
                    }
                  });
                }
                document.addEventListener('DOMContentLoaded', cleanupCards);
                rows.push(row);
              });
              if(!rows.length){ showToast('No visible cards', 'warn'); return; }
              var headers = Object.keys(rows[0]);
              var csv = headers.join(',')+'\n'+rows.map(function(r){ return headers.map(function(h){ var v = (r[h]||''); if(String(v).includes(',')){ return '"'+String(v).replace(/"/g,'""')+'"'; } return v; }).join(','); }).join('\n');
              var blob = new Blob([csv], {type:'text/csv'});
              var url = URL.createObjectURL(blob);
              var a = document.createElement('a');
              a.href = url; a.download = 'cards_visible.csv'; a.click();
              setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
              showToast('Exported visible cards', 'ok');
            }
            if(btn){ btn.addEventListener('click', exportCSV); }
          })();
          // Export visible cards to JSON (full payload)
          (function(){
            var btn = document.getElementById('exportVisibleJson');
            function exportJSON(){
              var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
              // Fallback to overall cards container
              var container = grid || document.querySelector('.cards');
              if(!container) return;
              var cards = Array.from(container.querySelectorAll('.game-card'));
              var rows = [];
              cards.forEach(function(card){
                if(card.style.display==='none') return;
                var obj = {};
                // Include all data-* attributes
                Array.from(card.attributes).forEach(function(attr){
                  if(attr && attr.name && attr.name.startsWith('data-')){
                    var key = attr.name.substring(5);
                    obj[key] = attr.value;
                  }
                });
                // Basic text fields
                var header = card.querySelector('.game-header .teams-row');
                obj.home_team = (card.querySelector('.badge-team.home .name') || {}).textContent || '';
                obj.away_team = (card.querySelector('.badge-team.away .name') || {}).textContent || '';
                obj.title = (card.querySelector('.title') || card.querySelector('.title-sm') || {}).textContent || '';
                // KPI snippets
                obj.kpi = Array.from(card.querySelectorAll('.kpi .pill')).map(function(p){ return (p.textContent||'').trim(); });
                // Derivatives presence flags
                obj.has_1h = !!card.querySelector('.deriv-group .group-title') && !!Array.from(card.querySelectorAll('.deriv-group .group-title')).find(function(x){ return (x.textContent||'').includes('1st'); });
                obj.has_2h = !!card.querySelector('.deriv-group .group-title') && !!Array.from(card.querySelectorAll('.deriv-group .group-title')).find(function(x){ return (x.textContent||'').includes('2nd'); });
                rows.push(obj);
              });
              if(!rows.length){ showToast('No visible cards', 'warn'); return; }
              var blob = new Blob([JSON.stringify(rows, null, 2)], {type:'application/json'});
              var url = URL.createObjectURL(blob);
              var a = document.createElement('a');
              a.href = url; a.download = 'cards_visible.json'; a.click();
              setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
              showToast('Exported visible cards (JSON)', 'ok');
            }
            if(btn){ btn.addEventListener('click', exportJSON); }
          })();
        });
        // Toast helper
        function showToast(msg, variant){
          try{
            var t = document.createElement('div');
            t.className = 'toast '+(variant||'');
            t.textContent = msg;
            document.body.appendChild(t);
            requestAnimationFrame(function(){ t.classList.add('show'); });
            setTimeout(function(){ t.classList.remove('show'); setTimeout(function(){ t.remove(); }, 150); }, 1500);
          }catch(e){}
        }
                // Diagnostics controls: copy providers, export status JSON
                (function(){
                  const copyBtn = document.getElementById('btnCopyProviders');
                  const exportBtn = document.getElementById('btnExportStatus');
                  if(copyBtn){
                    copyBtn.addEventListener('click', async ()=>{
                      try{
                        const r = await fetch('/api/ort-providers');
                        const j = await r.json();
                        const txt = JSON.stringify(j, null, 2);
                        await navigator.clipboard.writeText(txt);
                        showToast('Providers copied', 'ok');
                      }catch(e){ showToast('Copy failed', 'bad'); }
                    });
                  }
                  if(exportBtn){
                    exportBtn.addEventListener('click', ()=>{
                      const data = (window.__lastStatusPayload || {});
                      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      const dt = (data && data.server_timestamp) ? String(data.server_timestamp).replace(/[:]/g,'-') : 'status';
                      a.href = url; a.download = `status_${dt}.json`; a.click();
                      setTimeout(()=>URL.revokeObjectURL(url), 500);
                    });
                  }
                })();
        // Filters logic: filter cards by data attributes if present
        (function(){
          const applyBtn = document.getElementById('applyFiltersBtn');
          const clearBtn = document.getElementById('clearFiltersBtn');
          const edgeMin = document.getElementById('edgeMinInput');
          const confMin = document.getElementById('confMinInput');
          const overEmpMin = document.getElementById('overEmpMinInput');
          const atsEmpMin = document.getElementById('atsEmpMinInput');
          const onlyMarket = document.getElementById('onlyMarketAvail');
          const presetStrongEdges = document.getElementById('presetStrongEdges');
          const presetModEdges = document.getElementById('presetModEdges');
          const presetHighConf = document.getElementById('presetHighConf');
          const presetMarketAvail = document.getElementById('presetMarketAvail');
          function apply(){
            const eMin = parseFloat(edgeMin && edgeMin.value || '0');
            const cMin = parseFloat(confMin && confMin.value || '0');
            const oMin = parseFloat(overEmpMin && overEmpMin.value || '0');
            const aMin = parseFloat(atsEmpMin && atsEmpMin.value || '0');
            const oThr = isNaN(oMin) ? 0 : (oMin/100.0);
            const aThr = isNaN(aMin) ? 0 : (aMin/100.0);
            const mOnly = !!(onlyMarket && onlyMarket.checked);
            const cards = document.querySelectorAll('.card-item, .game-card');
            if(!cards || !cards.length) return;
            let hidden = 0;
            cards.forEach(function(card){
              const e = parseFloat(card.getAttribute('data-edge') || 'NaN');
              const c = parseFloat(card.getAttribute('data-confidence') || 'NaN');
              const pOverEmp = parseFloat(card.getAttribute('data-p-over-emp') || 'NaN');
              const pATSEmp = parseFloat(card.getAttribute('data-p-home-cover-emp') || 'NaN');
              const m = card.getAttribute('data-market-available');
              const mAvail = (m === '1' || m === 'true');
              let show = true;
              if(!isNaN(e) && eMin>0) show = show && (e >= eMin);
              if(!isNaN(c) && cMin>0) show = show && (c >= cMin);
              if(oThr>0) show = show && (!isNaN(pOverEmp) && (pOverEmp >= oThr));
              if(aThr>0) show = show && (!isNaN(pATSEmp) && (pATSEmp >= aThr));
              if(mOnly) show = show && mAvail;
              card.style.display = show ? '' : 'none';
              if(!show) hidden++;
            });
            const vis = cards.length - hidden;
            const fc = document.getElementById('filteredCount');
            const vc = document.getElementById('visibleCount');
            if(fc) fc.textContent = String(hidden);
            if(vc) vc.textContent = String(vis);
          }
          function clear(){
            const cards = document.querySelectorAll('.card-item, .game-card');
            cards.forEach(function(card){ card.style.display=''; });
            if(edgeMin) edgeMin.value = '0';
            if(confMin) confMin.value = '0';
            if(overEmpMin) overEmpMin.value = '0';
            if(atsEmpMin) atsEmpMin.value = '0';
            if(onlyMarket) onlyMarket.checked = false;
            const fc = document.getElementById('filteredCount');
            const vc = document.getElementById('visibleCount');
            if(fc) fc.textContent = '0';
            if(vc) vc.textContent = String(cards.length);
          }
          if(applyBtn) applyBtn.addEventListener('click', apply);
          if(clearBtn) clearBtn.addEventListener('click', clear);
          if(presetStrongEdges) presetStrongEdges.addEventListener('click', function(){ if(edgeMin) edgeMin.value='5'; apply(); });
          if(presetModEdges) presetModEdges.addEventListener('click', function(){ if(edgeMin) edgeMin.value='3'; apply(); });
          if(presetHighConf) presetHighConf.addEventListener('click', function(){ if(confMin) confMin.value='60'; apply(); });
          if(presetMarketAvail) presetMarketAvail.addEventListener('click', function(){ if(onlyMarket) { onlyMarket.checked=true; } apply(); });
          // Toast on clear
          if(clearBtn){ clearBtn.addEventListener('click', function(){ showToast('Filters cleared', 'neutral'); }); }
        })();
        function start(){ if(timer) clearInterval(timer); timer = setInterval(poll, 30000); poll(); }
        function stop(){ if(timer) { clearInterval(timer); timer=null; } }
        if(chk){
          try{
            const saved = localStorage.getItem('autoRefreshCards');
            if(saved === '1'){ chk.checked = true; }
          }catch(e){}
          const apply = ()=>{ try{ localStorage.setItem('autoRefreshCards', chk.checked ? '1' : '0'); }catch(e){}; if(chk.checked) start(); else stop(); };
          chk.addEventListener('change', apply);
          // apply on load
          apply();
        }
        if(closeBtn){ closeBtn.addEventListener('click', ()=>{ if(modal) modal.style.display='none'; }); }
        if(modal){
          modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; } });
          document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ modal.style.display='none'; } });
        }
        // Global summary updater used by sort/group/search actions
        window.updateFilterSummary = function(){
          try{
            var grid = document.getElementById('cardsGrid') || document.getElementById('gamesGrid');
            if(!grid) return;
            var cards = Array.from(grid.querySelectorAll('.game-card'));
            var visible = cards.filter(function(c){ return c.style.display !== 'none'; }).length;
            var hidden = cards.length - visible;
            var fc = document.getElementById('filteredCount');
            var vc = document.getElementById('visibleCount');
            if(fc) fc.textContent = String(hidden);
            if(vc) vc.textContent = String(visible);
            var btn = document.getElementById('exportVisible');
            if(btn){ btn.textContent = 'Export Visible'+(visible?(' ('+visible+')'):''); }
            var btnJ = document.getElementById('exportVisibleJson');
            if(btnJ){ btnJ.textContent = 'Export JSON'+(visible?(' ('+visible+')'):'' ); }
          }catch(e){}
        }
        // Initialize export count
        try{ window.updateFilterSummary && window.updateFilterSummary(); }catch(e){}
      })();
    </script>
    {% if pipeline_stats and (pipeline_stats.using_blended_predictions or pipeline_stats.prefer_cal_effective) %}
      <div class="mb8 flex-row-wrap">
        {% if pipeline_stats.using_blended_predictions %}
          <span class="pill" title="Blended predictions active (segmented + baseline)">Blended Active</span>
        {% endif %}
        {% if pipeline_stats.prefer_cal_effective %}
          <span class="pill" title="Calibrated predictions prioritized for display">Cal Prioritized</span>
        {% endif %}
        {% if pipeline_stats.blend_weight_median is defined %}
          <span class="pill" title="Blend weight median (min–max)">Wmed {{ '%.2f' % pipeline_stats.blend_weight_median }} ({{ '%.2f' % pipeline_stats.blend_weight_min }}–{{ '%.2f' % pipeline_stats.blend_weight_max }})</span>
        {% endif %}
        {% if pipeline_stats.seg_n_rows_median is defined %}
          <span class="pill" title="Segment sample size median (min–max)">Nmed {{ '%.0f' % pipeline_stats.seg_n_rows_median }} ({{ '%.0f' % pipeline_stats.seg_n_rows_min }}–{{ '%.0f' % pipeline_stats.seg_n_rows_max }})</span>
        {% endif %}
        {% if pipeline_stats.edge_total_z_median is defined %}
          <span class="pill" title="Z-score of total edges (median)">Ztot~ {{ '%.2f' % pipeline_stats.edge_total_z_median }}</span>
        {% endif %}
        {% if pipeline_stats.edge_ats_z_median is defined %}
          <span class="pill" title="Z-score of ATS edges (median)">ZATS~ {{ '%.2f' % pipeline_stats.edge_ats_z_median }}</span>
        {% endif %}
      </div>
    {% endif %}
    <form method="get" class="filters">
      <label class="muted">Date:
        <input type="date" name="date" value="{{ date_val or '' }}" />
      </label>
      <label class="muted ml8">Time:
        <select id="tzMode">
          <option value="server">Site Time{% if pipeline_stats and pipeline_stats.display_tz_used %} ({{ pipeline_stats.display_tz_used }}){% endif %}</option>
          <option value="local">My Time (Browser)</option>
        </select>
        <button type="button" class="pill" id="btnSetSiteTz" title="Set site/server timezone to your browser timezone">Set Site=My TZ</button>
      </label>
      <label class="muted"><input type="checkbox" name="use_daily" value="1" {% if request.args.get('use_daily') in ['1','true','yes'] %}checked{% endif %}/> Use daily results</label>
      <button type="submit" class="pill">Apply</button>
      {% if date_val %}<a class="pill" href="/">Clear</a>{% endif %}
  {% if date_val %}<button type="button" class="pill" id="btnFinalize" data-date="{{ date_val }}">Finalize Results</button>{% endif %}
  <label class="muted ml8"><input type="checkbox" id="autoRefreshChk" /> Auto-refresh</label>
      {% if show_bootstrap %}
        <a class="pill accent" href="{{ bootstrap_url }}" title="Run minimal pipeline to generate today's games and predictions">Generate Today's Predictions</a>
      {% endif %}
      {% if show_diag %}
        <a class="pill warn" href="{{ diag_url }}" title="Live fetch ESPN+NCAA to compare counts">Schedule Diagnostics</a>
        {% if fused_bootstrap_url %}
          <a class="pill accent" href="{{ fused_bootstrap_url }}" title="Fetch both providers (cache bypass) and rebuild slate">Fused Bootstrap</a>
        {% endif %}
      {% endif %}
    </form>
    <div class="meta">{{ total_rows }} rows{% if date_val %} ({{ date_val }}){% endif %}
      {% if coverage %}
        <span class="pill">Odds Full: {{ coverage.full }}</span>
        <span class="pill">Partial: {{ coverage.partial }}</span>
        <span class="pill">None: {{ coverage.none }}</span>
      {% endif %}
    </div>
    {% if archive_dates and date_val %}
      {% set prev_date = None %}
      {% set next_date = None %}
      {% for d in archive_dates %}
        {% if d == date_val %}
          {% if loop.index0 > 0 %}{% set prev_date = archive_dates[loop.index0 - 1] %}{% endif %}
          {% if loop.index0 + 1 < archive_dates|length %}{% set next_date = archive_dates[loop.index0 + 1] %}{% endif %}
        {% endif %}
      {% endfor %}
      <div class="archive-stepper">
        {% if prev_date %}<a class="pill" href="/?date={{ prev_date }}&use_daily=1">◀ Prev</a>{% endif %}
        {% if next_date %}<a class="pill" href="/?date={{ next_date }}&use_daily=1">Next ▶</a>{% endif %}
      </div>
    {% endif %}
    {% if archive_dates %}
      <div class="archive-nav">
        <details>
          <summary class="pill">Archive Dates ({{ archive_dates|length }})</summary>
          <div class="dates-list">
            {# Quick picker: search by typing, jump to latest #}
            <div class="muted m4v8">
              <input type="text" id="archiveSearch" placeholder="Filter dates (YYYY-MM-DD)" class="pill archive-search" />
              {% set latest = archive_dates[-1] if archive_dates|length > 0 else None %}
              {% if latest %}<a class="pill accent" href="/?date={{ latest }}&use_daily=1" title="Jump to latest archive">Latest: {{ latest }}</a>{% endif %}
            </div>
            <div id="archiveList" class="dates-list">
              {% for d in archive_dates[-60:] %}
                <a class="pill small{% if d == date_val %} active{% endif %}" data-date="{{ d }}" href="/?date={{ d }}&use_daily=1">{{ d }}</a>
              {% endfor %}
            </div>
          </div>
        </details>
      </div>
      <script>
        (function(){
          var input = document.getElementById('archiveSearch');
          var list = document.getElementById('archiveList');
          if(!input||!list) return;
          input.addEventListener('input', function(){
            var q = (input.value||'').trim().toLowerCase();
            list.querySelectorAll('a[data-date]').forEach(function(a){
              var d = (a.getAttribute('data-date')||'').toLowerCase();
              a.style.display = (!q || d.indexOf(q) !== -1) ? 'inline-block' : 'none';
            });
          });
        })();
      </script>
    {% endif %}
    {% if uniform_note %}
      <div class="card mb8"><div class="muted">{{ uniform_note }}</div></div>
    {% endif %}
    {% if coverage_note %}
      <div class="card mb8"><div class="muted">{{ coverage_note }}</div></div>
    {% endif %}
    {% if pipeline_stats %}
      <div class="card mb8">
        <details open>
          <summary class="pill">Diagnostics</summary>
          <div class="muted m4v8">
            Date: {{ pipeline_stats.date_param or date_val or 'n/a' }} · Rows: {{ pipeline_stats.final_rows or total_rows }} · Predictions Loaded: {{ pipeline_stats.preds_load_rows }} · Model Rows: {{ pipeline_stats.model_preds_load_rows }}
          </div>
          <div class="diag-grid flex-row-wrap">
            {% if pipeline_stats.corr_pred_total_model_market is defined %}<span class="pill" title="Correlation between model totals and market totals">Corr(model,market): {{ '%.3f' % pipeline_stats.corr_pred_total_model_market }}</span>{% endif %}
            {% if pipeline_stats.mae_pred_total_model_vs_pred_total is defined %}<span class="pill" title="MAE between model total and heuristic/synthetic pred_total">MAE(model vs pred): {{ '%.2f' % pipeline_stats.mae_pred_total_model_vs_pred_total }}</span>{% endif %}
            {% if pipeline_stats.pred_equal_market_count is defined %}<span class="pill" title="Count of games where pred_total ~= market_total (rounded .1)">Pred==Market: {{ pipeline_stats.pred_equal_market_count }}</span>{% endif %}
            {% if pipeline_stats.low_pred_count_lt115 is defined %}<span class="pill" title="Pred totals below 115 (post-adjustment)">LowPred&lt;115: {{ pipeline_stats.low_pred_count_lt115 }}</span>{% endif %}
            {% if pipeline_stats.synthetic_market_total_count is defined %}<span class="pill" title="Synthetic market totals filled from pred/derived">Synthetic Totals: {{ pipeline_stats.synthetic_market_total_count }}</span>{% endif %}
            {% if pipeline_stats.synthetic_spread_home_count is defined %}<span class="pill" title="Synthetic spreads from pred_margin">Synthetic Spreads: {{ pipeline_stats.synthetic_spread_home_count }}</span>{% endif %}
            {% if pipeline_stats.missing_market_total_rows is defined %}<span class="pill" title="Games lacking market_total & closing_total">Missing Totals: {{ pipeline_stats.missing_market_total_rows }}</span>{% endif %}
            {% if pipeline_stats.missing_pred_total_rows is defined %}<span class="pill" title="Games lacking pred_total">Missing Preds: {{ pipeline_stats.missing_pred_total_rows }}</span>{% endif %}
          </div>
          {% if pipeline_stats.pred_total_basis_counts %}
            <div class="muted mt4">Basis Distribution:
              {% for k,v in pipeline_stats.pred_total_basis_counts.items() %}<span class="pill small" title="{{ k }} basis count">{{ k }}={{ v }}</span>{% endfor %}
            </div>
          {% endif %}
          {% if pipeline_stats.pred_equal_market_sample %}
            <div class="muted mt4">Sample Pred==Market IDs: {{ pipeline_stats.pred_equal_market_sample|join(', ') }}</div>
          {% endif %}
          {% if pipeline_stats.low_pred_game_ids %}
            <div class="muted mt4">Low Pred IDs (&lt;115): {{ pipeline_stats.low_pred_game_ids|join(', ') }}</div>
          {% endif %}
          {% if pipeline_stats.missing_odds_game_ids %}
            <div class="muted mt4">Missing Odds IDs: {{ pipeline_stats.missing_odds_game_ids|join(', ') }}</div>
          {% endif %}
        </details>
      </div>
      {% if pipeline_stats.recalibration_ingested %}
        <div class="card mb8">
          <details open>
            <summary class="pill">Model Health</summary>
            <div class="muted m4v8">
              Recalibration Needed: {% if pipeline_stats.recalibration_needed %}<span class="pill bad" title="Thresholds exceeded – retraining advised">Yes</span>{% else %}<span class="pill ok" title="Within thresholds">No</span>{% endif %}
            </div>
            {% if pipeline_stats.recalibration_reasons %}
              <div class="muted mt4">Reasons:
                {% for rsn in pipeline_stats.recalibration_reasons %}<span class="pill small" title="Trigger reason">{{ rsn }}</span>{% endfor %}
              </div>
            {% endif %}
            {# Surface key drift metrics dynamically (any pipeline_stats starting with recalib_) #}
            <div class="diag-grid flex-row-wrap mt4">
              {% for k,v in pipeline_stats.items() %}
                {% if k.startswith('recalib_') and v is not none %}
                  <span class="pill" title="{{ k }}">{{ k[8:] }}: {% if v is number %}{{ '%.3f' % v }}{% else %}{{ v }}{% endif %}</span>
                {% endif %}
              {% endfor %}
            </div>
            {% if pipeline_stats.reliability_trend_rows %}
              <div class="muted mt8">Rolling 7-Day Reliability:
                {% if pipeline_stats.ece_total_roll7 is defined %}<span class="pill small" title="7-day mean ECE total">ECE Total7={{ '%.3f' % pipeline_stats.ece_total_roll7 }}</span>{% endif %}
                {% if pipeline_stats.ece_margin_roll7 is defined %}<span class="pill small" title="7-day mean ECE margin">ECE Margin7={{ '%.3f' % pipeline_stats.ece_margin_roll7 }}</span>{% endif %}
                {% if pipeline_stats.sharpness_total_roll7 is defined %}<span class="pill small" title="7-day sharpness total">Sharp Total7={{ '%.2f' % pipeline_stats.sharpness_total_roll7 }}</span>{% endif %}
                {% if pipeline_stats.sharpness_margin_roll7 is defined %}<span class="pill small" title="7-day sharpness margin">Sharp Margin7={{ '%.2f' % pipeline_stats.sharpness_margin_roll7 }}</span>{% endif %}
              </div>
            {% endif %}
          </details>
        </div>
      {% endif %}
    {% endif %}
    {% if removed_empty_rows is defined and removed_empty_rows and removed_empty_rows > 0 %}
      <div class="card mb8"><div class="muted">Filtered {{ removed_empty_rows }} empty game{% if removed_empty_rows>1 %}s{% endif %} (no odds or predictions).</div></div>
    {% endif %}
    <div class="cards">
      {% for r in rows %}
        {% set _edge = (r.edge_total if (r.edge_total is defined and r.edge_total is not none and r.edge_total == r.edge_total) else None) %}
        {% set _conf = (r.edge_confidence_pct if (r.edge_confidence_pct is defined and r.edge_confidence_pct is not none and r.edge_confidence_pct == r.edge_confidence_pct) else None) %}
        {% set _has_total = (
          (r.market_total is defined and r.market_total is not none and r.market_total == r.market_total)
          or (r.closing_total is defined and r.closing_total is not none and r.closing_total == r.closing_total)
        ) %}
        {% set _has_spread = (
          (r.spread_home is defined and r.spread_home is not none and r.spread_home == r.spread_home)
          or (r.closing_spread_home is defined and r.closing_spread_home is not none and r.closing_spread_home == r.closing_spread_home)
        ) %}
        {% set _has_ml = (r.ml_home is defined and r.ml_home is not none) %}
        {% set _market_avail = (1 if (_has_total or _has_spread or _has_ml) else 0) %}
        <div class="card game-card" role="article" tabindex="0" aria-label="Game card {{ r.away_team }} at {{ r.home_team }}" data-live="{{ '1' if (r.live is defined and r.live) else '0' }}" data-edge="{{ ('%.2f' % _edge) if _edge is not none else '' }}" data-confidence="{{ ('%.0f' % _conf) if _conf is not none else '' }}" data-market-available="{{ _market_avail }}" data-fair-price="{{ (r.fair_price if (r.fair_price is defined and r.fair_price is not none) else '') }}" data-ev="{{ ('%.3f' % r.ev) if (r.ev is defined and r.ev is not none and r.ev == r.ev) else '' }}" data-implied-prob="{{ ('%.4f' % r.implied_prob) if (r.implied_prob is defined and r.implied_prob is not none and r.implied_prob == r.implied_prob) else '' }}" data-market="{{ r.market_basis if (r.market_basis is defined and r.market_basis) else '' }}" data-book="{{ r.book_name if (r.book_name is defined and r.book_name) else '' }}" data-market-price="{{ (r.ml_home if (r.ml_home is defined and r.ml_home is not none and r.ml_home == r.ml_home) else (r.ml_away if (r.ml_away is defined and r.ml_away is not none and r.ml_away == r.ml_away) else '')) }}" data-quote-ts="{{ r.quote_ts if (r.quote_ts is defined and r.quote_ts) else '' }}" data-has-odds="{{ '1' if (r.has_odds is defined and r.has_odds) else '0' }}" data-has-actuals="{{ '1' if (r.has_actuals is defined and r.has_actuals) else '0' }}" data-has-derivatives="{{ '1' if (r.has_derivatives is defined and r.has_derivatives) else '0' }}" data-p-over-emp="{{ ('%.4f' % r.p_over_emp) if (r.p_over_emp is defined and r.p_over_emp is not none and r.p_over_emp == r.p_over_emp) else '' }}" data-p-home-cover-emp="{{ ('%.4f' % r.p_home_cover_emp) if (r.p_home_cover_emp is defined and r.p_home_cover_emp is not none and r.p_home_cover_emp == r.p_home_cover_emp) else '' }}">
          <div class="game-header">
            <div class="teams-row">
              <div class="badge-team away" data-bg="{{ r.away_color or '' }}">
                {% if r.away_logo %}
                  <img class="logo" src="{{ r.away_logo }}" alt="{{ r.away_team or 'Away' }} logo" />
                {% endif %}
                {% set use_short = (compact_mode is defined and compact_mode) %}
                {% set away_header = r.away_team %}
                {% if use_short %}
                  {% if r.away_short is defined and r.away_short %}
                    {% set away_header = r.away_short %}
                  {% else %}
                    {% set parts2h = (r.away_team or '') .split(' ') %}
                    {% if parts2h|length > 1 %}{% set away_header = ' '.join(parts2h[:-1]) %}{% endif %}
                  {% endif %}
                {% endif %}
                <span class="name" data-tx="{{ r.away_color_text or '' }}">{{ away_header or 'Away' }}</span>
                {% if r.away_rank is defined and r.away_rank %}<span class="rank">#{{ r.away_rank }}</span>{% endif %}
              </div>
              <div class="vs sep">@</div>
              <div class="badge-team home" data-bg="{{ r.home_color or '' }}">
                {% if r.home_logo %}
                  <img class="logo" src="{{ r.home_logo }}" alt="{{ r.home_team or 'Home' }} logo" />
                {% endif %}
                {% set home_header = r.home_team %}
                {% if use_short %}
                  {% if r.home_short is defined and r.home_short %}
                    {% set home_header = r.home_short %}
                  {% else %}
                    {% set parts1h = (r.home_team or '') .split(' ') %}
                    {% if parts1h|length > 1 %}{% set home_header = ' '.join(parts1h[:-1]) %}{% endif %}
                  {% endif %}
                {% endif %}
                <span class="name" data-tx="{{ r.home_color_text or '' }}">{{ home_header or 'Home' }}</span>
                {% if r.home_rank is defined and r.home_rank %}<span class="rank">#{{ r.home_rank }}</span>{% endif %}
              </div>
            </div>
            <div class="meta-row">
              {# Single card-level CAL badge (header). Show once per card, not per metric. #}
              {% set is_cal_card = (r.pred_total_basis in ['model_calibrated','model_calibrated_bias','cal']) or (r.pred_margin_basis in ['model_calibrated','model_calibrated_bias','cal']) %}
              {% if is_cal_card %}
                <span class="badge cal" title="Calibrated predictions">CAL</span>
              {% endif %}
              {# Meta diagnostics badges: volatility and edge confidence if available #}
              {% if r.volatility_tag is defined and r.volatility_tag %}
                <span class="badge detailed-only" title="Volatility class from meta diagnostics">Vol {{ r.volatility_tag }}</span>
              {% endif %}
              {% if r.edge_conf_tag is defined and r.edge_conf_tag %}
                <span class="badge detailed-only" title="Edge confidence tag from meta">Conf {{ r.edge_conf_tag }}</span>
              {% endif %}
              {# Hard lock: render only server-provided CST display_time_str; no client conversion #}
              {% set disp_date = (r.display_date if (r.display_date is defined and r.display_date) else (r.date if (r.date is defined and r.date) else '')) %}
              {% set is_rollover = (r.display_date is defined and r.date is defined and r.display_date and r.date and r.display_date != r.date) %}
              {% if r.display_time_str is defined and r.display_time_str %}
                <span class="pill time-local{% if is_rollover %} rollover{% endif %}" data-iso="" data-slate="{{ disp_date }}" data-rollover="{{ '1' if is_rollover else '0' }}" title="Time shown in Central Time">{{ r.display_time_str }}</span>
                <button type="button" class="pill small copy-time" title="Copy time details" aria-label="Copy time details">Copy</button>
              {% endif %}
              {% set venue = (r.venue_full or r.venue or r.arena or r.stadium or r.site_name or r.location or r.city) if (r is defined) else None %}
              {% if venue %}<span class="pill venue">{{ venue }}{% if r.city and r.state %} – {{ r.city }}, {{ r.state }}{% elif r.city %} – {{ r.city }}{% endif %}</span>{% endif %}
              {% if r.neutral_site %}<span class="pill neutral">Neutral Site</span>{% endif %}
            </div>
          </div>
          <div class="kpi">
            {% if r.pred_synthetic_hidden %}
              <div class="pill accent" title="Awaiting real model predictions ingestion for this date">Predictions Pending</div>
            {% endif %}
            {# Compact Signals row: Edge | EV | Imp% | ΔOU (shown in Standard/Compact modes) #}
            {% set _edge_s = (r.edge_total if (r.edge_total is defined and r.edge_total is not none and r.edge_total == r.edge_total) else None) %}
            {% set _ev_s = (r.ev if (r.ev is defined and r.ev is not none and r.ev == r.ev) else None) %}
            {% set _imp_s = (r.implied_prob if (r.implied_prob is defined and r.implied_prob is not none and r.implied_prob == r.implied_prob) else None) %}
            {% set _pt_s = (r.pred_total if (r.pred_total is not none and r.pred_total == r.pred_total) else None) %}
            {% set _mt_s = (r.market_total if (r.market_total is not none and r.market_total == r.market_total) else None) %}
            {% set _d_ou_s = (_pt_s - _mt_s) if (_pt_s is not none and _mt_s is not none) else None %}
            <div class="pill signals-row">
              {% if _edge_s is not none %}<span>Edge {{ '%.1f' % _edge_s }}</span>{% endif %}
              {% if _ev_s is not none %}<span>EV {{ '%.3f' % _ev_s }}</span>{% endif %}
              {% if _imp_s is not none %}<span>Imp {{ '%.1f' % (_imp_s*100) }}%</span>{% endif %}
              {% if _d_ou_s is not none %}<span>ΔOU {{ '%.1f' % _d_ou_s }}</span>{% endif %}
              {% if r.p_over_emp is defined and r.p_over_emp is not none and r.p_over_emp == r.p_over_emp %}<span title="Empirical probability of Over">Over% {{ '%.0f' % (r.p_over_emp*100) }}</span>{% endif %}
              {% if r.p_home_cover_emp is defined and r.p_home_cover_emp is not none and r.p_home_cover_emp == r.p_home_cover_emp %}<span title="Empirical probability of home cover (ATS)">ATS% {{ '%.0f' % (r.p_home_cover_emp*100) }}</span>{% endif %}
            </div>
            {% if r.pred_total_p10 is defined and r.pred_total_p10 is not none and r.pred_total_p10 == r.pred_total_p10 and r.pred_total_p90 is defined and r.pred_total_p90 is not none and r.pred_total_p90 == r.pred_total_p90 %}
              <div class="pill detailed-only" title="Empirical interval for total from residual quantiles">Total p10–p90: {{ '%.1f' % r.pred_total_p10 }}–{{ '%.1f' % r.pred_total_p90 }}</div>
            {% endif %}
            {% if r.pred_margin_p10 is defined and r.pred_margin_p10 is not none and r.pred_margin_p10 == r.pred_margin_p10 and r.pred_margin_p90 is defined and r.pred_margin_p90 is not none and r.pred_margin_p90 == r.pred_margin_p90 %}
              <div class="pill detailed-only" title="Empirical interval for margin from residual quantiles">Margin p10–p90: {{ '%.1f' % r.pred_margin_p10 }}–{{ '%.1f' % r.pred_margin_p90 }}</div>
            {% endif %}
            {% if r.sigma_total_emp is defined and r.sigma_total_emp is not none and r.sigma_total_emp == r.sigma_total_emp %}
              <span class="badge detailed-only" title="Empirical sigma for totals">σT {{ '%.2f' % r.sigma_total_emp }}</span>
            {% endif %}
            {% if r.sigma_margin_emp is defined and r.sigma_margin_emp is not none and r.sigma_margin_emp == r.sigma_margin_emp %}
              <span class="badge detailed-only" title="Empirical sigma for margins">σM {{ '%.2f' % r.sigma_margin_emp }}</span>
            {% endif %}
            {# Unified coverage label produced server-side: r.coverage_label #}
            {% if r.coverage_label %}
              {% if r.coverage_label == 'Odds Available' %}
                {# Suppress positive pill to reduce noise; uncomment to show #}
                {# <div class="pill good">Odds Available</div> #}
              {% elif 'Exhibition' in r.coverage_label %}
                <div class="pill bad">{{ r.coverage_label }}</div>
              {% elif 'Unposted' in r.coverage_label %}
                <div class="pill neutral">{{ r.coverage_label }}</div>
              {% elif 'No Data' in r.coverage_label %}
                <div class="pill bad">{{ r.coverage_label }}</div>
              {% else %}
                <div class="pill neutral">{{ r.coverage_label }}</div>
              {% endif %}
            {% endif %}
            {% if r.neutral_site %}
              <div class="pill">Neutral Site</div>
            {% endif %}
            {# Calibrated/raw/adjustment badges with interactive toggle #}
            {% set is_cal = r.pred_total_basis in ['model_calibrated','model_calibrated_bias','cal'] %}
            {% set is_raw = r.pred_total_basis in ['model_raw','model','model_v1'] %}
            {% set _pt = r.pred_total %}
            {% set _pt_valid = (_pt is not none and _pt == _pt) %} {# treat NaN as invalid (NaN != NaN) #}
            {% set _mt = r.market_total if (r.market_total is defined) else None %}
            {% set _mt_valid = (_mt is not none and _mt == _mt) %}
            <div class="pill">Total: {{ '%.1f' % _pt if _pt_valid else ( '%.1f' % _mt if _mt_valid else '–') }}
              {% if r.pred_total_adjusted %}<span class="badge adj detailed-only" title="Low-total blend adjustment applied">Adj</span>{% endif %}
              {% if r.pred_total_model_raw is defined and r.pred_total_model_raw is not none and r.pred_total_model_raw == r.pred_total_model_raw and is_cal and _pt_valid %}
                <span class="badge toggle-raw detailed-only" data-raw="{{ '%.1f' % r.pred_total_model_raw }}" data-cal="{{ '%.1f' % _pt }}" onclick="toggleRaw(this)" title="Click to toggle raw vs calibrated">↔</span>
              {% endif %}
              {% if _pt_valid and _mt_valid %}
                {% set _delta_tot = (_pt - _mt) %}
                <span class="badge" title="Model total minus market total (OU)">ΔOU {{ '%.1f' % _delta_tot }}</span>
              {% endif %}
              {% if r.blend_effective is defined and r.blend_effective and r.blend_weight is not none and r.blend_weight > 0 %}<span class="badge weight detailed-only" title="Blend weight (segmented vs baseline)">W={{ '%.2f' % r.blend_weight }}</span>{% endif %}
              {% if r.blend_effective is defined and r.blend_effective and r.seg_n_rows_orig is defined and r.seg_n_rows_orig is not none and r.seg_n_rows_orig > 0 %}<span class="badge sample detailed-only" title="Segment sample size contributing to blended prediction (rows)">N={{ '%.0f' % r.seg_n_rows_orig }}</span>{% endif %}
              {% if r.book_name is defined and r.book_name %}<span class="badge" title="Primary book source">Book: {{ r.book_name }}</span>{% endif %}
              {% if r.market_basis is defined and r.market_basis %}<span class="badge" title="Market basis (median/last/etc)">Basis: {{ r.market_basis }}</span>{% endif %}
            </div>
            <div class="pill">
              {% if r.pred_margin is not none %}
                {% if r.favored_side == 'Home' %}Margin: {{ r.home_team or '–' }} by {{ '%.1f' % (r.favored_by or 0) }}{% elif r.favored_side == 'Away' %}Margin: {{ r.away_team or '–' }} by {{ '%.1f' % (r.favored_by or 0) }}{% else %}Margin: Even{% endif %}
              {% else %}Margin: –{% endif %}
              {# ATS delta (model margin vs market spread) #}
              {% if r.pred_margin is not none and ((r.spread_home is defined and r.spread_home is not none and r.spread_home == r.spread_home) or (r.closing_spread_home is defined and r.closing_spread_home is not none and r.closing_spread_home == r.closing_spread_home)) %}
                {% set _spr = (r.spread_home if (r.spread_home is defined and r.spread_home is not none and r.spread_home == r.spread_home) else r.closing_spread_home) %}
                {% if _spr is not none %}
                  {% set _delta_ats = (r.pred_margin - _spr) %}
                  <span class="badge" title="Model margin minus market spread (ATS)">ΔATS {{ '%.1f' % _delta_ats }}</span>
                {% endif %}
              {% endif %}
            </div>
            {% if (r.proj_home is not none and r.proj_home == r.proj_home) and (r.proj_away is not none and r.proj_away == r.proj_away) %}
              {% set _ph_valid = (r.proj_home is not none and r.proj_home == r.proj_home) %}
              {% set _pa_valid = (r.proj_away is not none and r.proj_away == r.proj_away) %}
              {% if _ph_valid and _pa_valid %}
                <div class="pill detailed-only">Projected: {{ '%.1f' % r.proj_away }} - {{ '%.1f' % r.proj_home }}</div>
              {% endif %}
            {% endif %}
            {% if r.market_total is defined and r.market_total is not none and r.market_total == r.market_total %}
              {% if r.market_basis == 'last' %}
              {# Meta & Stability panels: show when artifacts ingested #}
              {% if pipeline_stats.meta_probs_ingested or pipeline_stats.prob_stability_ingested or pipeline_stats.auto_refresh_calibration_ingested %}
                {% if pipeline_stats.meta_probs_ingested %}
                  <div class="card mb8">
                    <details open>
                      <summary class="pill">Meta Probabilities</summary>
                      <div class="diag-grid flex-row-wrap mt4">
                        {% if pipeline_stats.meta_auc_total is defined %}<span class="pill" title="Meta AUC for total">AUC Total: {{ '%.3f' % pipeline_stats.meta_auc_total }}</span>{% endif %}
                        {% if pipeline_stats.meta_brier_total is defined %}<span class="pill" title="Meta Brier score for total">Brier Total: {{ '%.3f' % pipeline_stats.meta_brier_total }}</span>{% endif %}
                        {% if pipeline_stats.meta_auc_ats is defined %}<span class="pill" title="Meta AUC for ATS">AUC ATS: {{ '%.3f' % pipeline_stats.meta_auc_ats }}</span>{% endif %}
                        {% if pipeline_stats.meta_brier_ats is defined %}<span class="pill" title="Meta Brier score for ATS">Brier ATS: {{ '%.3f' % pipeline_stats.meta_brier_ats }}</span>{% endif %}
                        {% if pipeline_stats.meta_n_rows is defined %}<span class="pill" title="Rows contributing to meta metrics">Rows: {{ pipeline_stats.meta_n_rows }}</span>{% endif %}
                      </div>
                    </details>
                  </div>
                {% endif %}
                {% if pipeline_stats.prob_stability_ingested %}
                  <div class="card mb8">
                    <details open>
                      <summary class="pill">Probability Stability</summary>
                      <div class="diag-grid flex-row-wrap mt4">
                        {% if pipeline_stats.prob_stability_mean is defined %}<span class="pill" title="Mean stability across methods">Mean: {{ '%.3f' % pipeline_stats.prob_stability_mean }}</span>{% endif %}
                        {% if pipeline_stats.prob_stability_q10 is defined %}<span class="pill" title="Lower tail stability (q10)">q10: {{ '%.3f' % pipeline_stats.prob_stability_q10 }}</span>{% endif %}
                        {% if pipeline_stats.prob_stability_q90 is defined %}<span class="pill" title="Upper tail stability (q90)">q90: {{ '%.3f' % pipeline_stats.prob_stability_q90 }}</span>{% endif %}
                        {% if pipeline_stats.prob_stability_n_rows is defined %}<span class="pill" title="Rows contributing to stability metrics">Rows: {{ pipeline_stats.prob_stability_n_rows }}</span>{% endif %}
                      </div>
                    </details>
                  </div>
                {% endif %}
                {% if pipeline_stats.auto_refresh_calibration_ingested %}
                  <div class="card mb8">
                    <details open>
                      <summary class="pill">Auto Calibration</summary>
                      <div class="diag-grid flex-row-wrap mt4">
                        {% if pipeline_stats.auto_cal_refresh_hint is defined %}<span class="pill" title="Auto-refresh hint status">Hint: {{ pipeline_stats.auto_cal_refresh_hint }}</span>{% endif %}
                        {% if pipeline_stats.auto_cal_last_refresh_dt is defined %}<span class="pill" title="Last calibration refresh datetime">Last: {{ pipeline_stats.auto_cal_last_refresh_dt }}</span>{% endif %}
                        {% if pipeline_stats.auto_cal_due is defined %}<span class="pill" title="Calibration due flag">Due: {{ 'Yes' if pipeline_stats.auto_cal_due else 'No' }}</span>{% endif %}
                      </div>
                    </details>
                  </div>
                {% endif %}
              {% endif %}
              {% if r.has_odds is defined and r.has_odds %}
                <div class="pill section-odds">Last (pre-tip): {{ '%.1f' % r.market_total }}</div>
              {% endif %}
              {% else %}
                {% if r.has_odds is defined and r.has_odds %}
                <div class="pill section-odds">Market Total: {{ '%.1f' % r.market_total }}
                  {% if r.quotes_count is defined and r.quotes_count is not none %}
                    {% if r.quotes_count >= 2 %}
                      <span class="badge" title="Number of bookmaker totals aggregated for market total median">Q={{ r.quotes_count }}</span>
                    {% elif r.quotes_count == 1 %}
                      <span class="badge badge-warn" title="Low market depth (only 1 bookmaker quote aggregated)">Q=1</span>
                    {% elif r.quotes_count == 0 %}
                      <span class="badge badge-warn" title="Low market depth (no bookmaker totals aggregated)">Q=0</span>
                    {% endif %}
                  {% endif %}
                </div>
                {% endif %}
              {% endif %}
              {% if r.quote_ts is defined and r.quote_ts %}
                <div class="pill quote-local" data-iso="{{ r.quote_ts }}" title="Quote (UTC): {{ r.quote_ts }}">Quote: {{ r.quote_ts }}</div>
              {% endif %}
              {% if r.edge_total is defined and r.edge_total is not none and r.edge_total == r.edge_total %}
                {% set abs_et = r.edge_total|abs %}
                {% set cls_et = (
                  'edge-zero' if abs_et < 0.1 else
                  'edge-weak' if abs_et < 1.0 else
                  'edge-mod' if abs_et < 2.0 else
                  'edge-strong' if abs_et < 3.5 else
                  'edge-extreme'
                ) %}
                <div class="pill {{ cls_et }}">Total Edge: {{ '%.1f' % r.edge_total }}</div>
                {% if _conf is not none %}
                  <span class="badge" title="Edge confidence">Conf {{ '%.0f' % _conf }}%</span>
                {% endif %}
                {% if r.fair_price is defined and r.fair_price is not none %}
                  <span class="badge" title="Model fair price">Fair {{ r.fair_price }}</span>
                  {# Fair vs Market delta for moneyline when available #}
                  {% set mlh = r.ml_home if (r.ml_home is defined) else None %}
                  {% set mla = r.ml_away if (r.ml_away is defined) else None %}
                  {% set has_mlh = (mlh is not none and mlh == mlh) %}
                  {% set has_mla = (mla is not none and mla == mla) %}
                  {% if has_mlh or has_mla %}
                    {% if has_mlh and (r.fair_price is not none) %}
                      {% set delta_h = (r.fair_price - mlh) %}
                      <span class="badge detailed-only" title="Fair minus Home ML">ΔFair(H) {{ '%+d' % delta_h }}</span>
                    {% endif %}
                    {% if has_mla and (r.fair_price is not none) %}
                      {% set delta_a = (r.fair_price - mla) %}
                      <span class="badge detailed-only" title="Fair minus Away ML">ΔFair(A) {{ '%+d' % delta_a }}</span>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% if r.edge_total_z is defined and r.edge_total_z is not none and r.edge_total_z == r.edge_total_z %}
                  <span class="badge" title="Total edge z-score">Z={{ '%.2f' % r.edge_total_z }}</span>
                {% endif %}
              {% endif %}
              {% if r.lean_ou_side is defined and r.lean_ou_side %}
                <div class="pill">OU Lean: {{ r.lean_ou_side }} {% if r.lean_ou_edge_abs is not none %}(+{{ '%.1f' % r.lean_ou_edge_abs }}){% endif %}</div>
              {% endif %}
            {% endif %}
            {# Closing line pills removed per request #}
          </div>
          {# Picks section intentionally removed #}
          <div class="section">
            {# Compact mode short name derivation #}
            {% set use_short = (compact_mode is defined and compact_mode) %}
            {% set home_disp = r.home_team %}
            {% set away_disp = r.away_team %}
            {% if use_short %}
              {% if r.home_short is defined and r.home_short %}
                {% set home_disp = r.home_short %}
              {% else %}
                {% set parts = (r.home_team or '') .split(' ') %}
                {% if parts|length > 1 %}{% set home_disp = ' '.join(parts[:-1]) %}{% endif %}
              {% endif %}
              {% if r.away_short is defined and r.away_short %}
                {% set away_disp = r.away_short %}
              {% else %}
                {% set parts2 = (r.away_team or '') .split(' ') %}
                {% if parts2|length > 1 %}{% set away_disp = ' '.join(parts2[:-1]) %}{% endif %}
              {% endif %}
            {% endif %}
            <div class="title">Full Game</div>
            <div class="line-row preds-row">
              <div class="seg label">Predictions</div>
              <div class="seg">ATS: {% if r.pred_margin is not none %}{% set imp = (r.pred_margin * -1) %}{% if imp < 0 %}{{ home_disp or '–' }} {{ '%.1f' % imp }}{% elif imp > 0 %}{{ away_disp or '–' }} -{{ '%.1f' % imp }}{% else %}Pick{% endif %}{% else %}–{% endif %}
                {# Compute Edge and ΔATS inline from pred_margin and available spread to avoid stale CSV fields #}
                {% set _spr = (r.spread_home if (r.spread_home is not none and r.spread_home == r.spread_home) else (r.closing_spread_home if (r.closing_spread_home is not none and r.closing_spread_home == r.closing_spread_home) else none)) %}
                {% if (r.pred_margin is not none and r.pred_margin == r.pred_margin) and (_spr is not none) %}
                  {% set _edge_ats = ((r.pred_margin * -1) - _spr) %}
                  <span class="badge" title="ATS edge vs spread (predicted spread − market spread)">Edge={{ '%.1f' % _edge_ats }}</span>
                  <span class="badge" title="Predicted spread minus market spread (ATS)">ΔATS {{ '%.1f' % _edge_ats }}</span>
                {% endif %}
                {% if r.edge_ats_z is defined and r.edge_ats_z is not none and r.edge_ats_z == r.edge_ats_z %}
                  <span class="badge" title="ATS edge z-score">Z={{ '%.2f' % r.edge_ats_z }}</span>
                {% endif %}
              </div>
              <div class="seg">Winner: {% if r.pred_margin is not none %}{% if r.pred_margin > 0 %}{{ home_disp }}{% elif r.pred_margin < 0 %}{{ away_disp }}{% else %}Even{% endif %}{% else %}–{% endif %}</div>
              <div class="seg">Team Totals: {% if (r.proj_home is not none and r.proj_home == r.proj_home) and (r.proj_away is not none and r.proj_away == r.proj_away) %}{{ away_disp or '–' }} {{ '%.1f' % r.proj_away }} / {{ home_disp or '–' }} {{ '%.1f' % r.proj_home }}{% else %}–{% endif %}</div>
              <div class="seg">Overall: {% if r.pred_total is not none %}{{ '%.1f' % r.pred_total }}{% else %}–{% endif %}</div>
            </div>
            {% set spread_full = r.spread_home if (r.spread_home is not none and r.spread_home == r.spread_home) else None %}
            {% set total_full = r.market_total if (r.market_total is not none and r.market_total == r.market_total) else None %}
            {% if r.has_odds is defined and r.has_odds %}
            <div class="line-row odds-row section-odds">
              <div class="seg label">Odds</div>
              <div class="seg">ATS: {% if spread_full is not none %}{% if spread_full < 0 %}{{ home_disp or '–' }} {{ '%.1f' % spread_full }}{% elif spread_full > 0 %}{{ away_disp or '–' }} -{{ '%.1f' % spread_full }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
              <div class="seg">
                {% if r.kelly_frac_spread is defined and r.kelly_frac_spread is not none and r.kelly_frac_spread == r.kelly_frac_spread %}
                  <span class="badge" title="Kelly fraction suggestion for ATS using calibrated K and -110 price">Kelly: {{ '%.1f' % (r.kelly_frac_spread * 100) }}% {{ r.kelly_side_spread or '' }}</span>
                {% else %}
                  <span class="badge" title="Kelly fraction suggestion unavailable">Kelly: –</span>
                {% endif %}
              </div>
              {% if spread_full is not none %}
                <div class="seg">Winner: {% if spread_full < 0 %}{{ home_disp or '–' }}{% elif spread_full > 0 %}{{ away_disp or '–' }}{% else %}Even{% endif %}</div>
              {% else %}
                {% set mlh = r.ml_home if (r.ml_home is defined) else None %}
                {% set mla = r.ml_away if (r.ml_away is defined) else None %}
                {% set has_mlh = (mlh is not none and mlh == mlh) %}
                {% set has_mla = (mla is not none and mla == mla) %}
                {% if has_mlh or has_mla %}
                  {% set winner_ml = None %}
                  {% if has_mlh and has_mla %}
                    {% if mlh < 0 and (mla >= 0 or (0-mlh) > (0-mla)) %}
                      {% set winner_ml = r.home_team or '–' %}
                    {% elif mla < 0 and (mlh >= 0 or (0-mla) > (0-mlh)) %}
                      {% set winner_ml = r.away_team or '–' %}
                    {% else %}
                      {# Avoid abs filter: decide by American odds rules #}
                      {% if mlh >= 0 and mla >= 0 %}
                        {% set winner_ml = (r.home_team if mlh <= mla else r.away_team) %}
                      {% elif mlh < 0 and mla < 0 %}
                        {# More negative already handled above; on tie or unclear, default home #}
                        {% set winner_ml = r.home_team or '–' %}
                      {% else %}
                        {# Mixed signs: negative is favorite #}
                        {% set winner_ml = (r.home_team if mlh < mla else r.away_team) %}
                      {% endif %}
                    {% endif %}
                  {% elif has_mlh %}
                    {% set winner_ml = r.home_team or '–' %}
                  {% elif has_mla %}
                    {% set winner_ml = r.away_team or '–' %}
                  {% endif %}
                  <div class="seg">Winner: {{ winner_ml }}</div>
                {% else %}
                  <div class="seg">Winner: –</div>
                {% endif %}
              {% endif %}
              <div class="seg">Team Totals: {% if total_full is not none and spread_full is not none %}{% set home_imp_full = (total_full / 2) - (spread_full / 2) %}{% set away_imp_full = total_full - home_imp_full %}{{ away_disp or '–' }} {{ '%.1f' % away_imp_full }} / {{ home_disp or '–' }} {{ '%.1f' % home_imp_full }}{% else %}–{% endif %}</div>
              <div class="seg">Overall: {% if total_full is not none %}{{ '%.1f' % total_full }}{% else %}–{% endif %}</div>
            </div>
            {% endif %}
            {% if r.has_actuals is defined and r.has_actuals %}
            <div class="line-row actuals-row section-actuals">
              <div class="seg label">Actuals</div>
              {% set cls_ats_full = 'neutral' if (r.ats_result == 'Push') else ('ok' if r.eval_ats_ok else ('bad' if r.ats_result else 'neutral')) %}
              {# Coerce ats_result to string to avoid TypeError when NaN/float #}
              {% set ats_text = (r.ats_result ~ '') %}
              {% set ats_team_full = (home_disp if ('Home' in ats_text) else (away_disp if ('Away' in ats_text) else ('Push' if ats_text == 'Push' else None))) %}
              <div class="seg {{ cls_ats_full }}">ATS: {% if ats_team_full == 'Push' %}Push{% elif ats_team_full %}{{ ats_team_full }} Cover{% else %}–{% endif %}</div>
              {# Safe ML winner extraction: coerce ml_result to string to avoid TypeError on NaN/None #}
              {% set ml_text = (r.ml_result ~ '') %}
              {% set winner_team = home_disp if 'Home' in ml_text else (away_disp if 'Away' in ml_text else ('Push' if ml_text == 'Push' else None)) %}
              {% set cls_ml_full = 'neutral' if (winner_team == 'Push') else ('ok' if r.eval_ml_ok else ('bad' if winner_team else 'neutral')) %}
              <div class="seg {{ cls_ml_full }}">Winner: {{ winner_team or '–' }}</div>
              <div class="seg">Team Totals: {% if r.home_score is not none and r.away_score is not none %}{{ away_disp or '–' }} {{ r.away_score }} / {{ home_disp or '–' }} {{ r.home_score }}{% else %}–{% endif %}</div>
              {% set ou_actual = ( 'Over' if (r.actual_total is not none and r.market_total is not none and r.actual_total > r.market_total) else ( 'Under' if (r.actual_total is not none and r.market_total is not none and r.actual_total < r.market_total) else ('Push' if (r.actual_total is not none and r.market_total is not none and r.actual_total == r.market_total) else None))) %}
              {% set ou_cls = 'neutral' if (ou_actual == 'Push' or ou_actual is none) else ( 'ok' if (r.lean_ou_side is defined and r.lean_ou_side == ou_actual) else ('bad' if (r.lean_ou_side is defined and r.lean_ou_side and ou_actual and r.lean_ou_side != ou_actual) else 'neutral')) %}
              {% set tooltip = '' %}
              {% if r.actual_total is not none and r.market_total is not none %}
                {% set tooltip = 'vs Market: ' ~ (ou_actual or '–') ~ ' | Market: ' ~ ('%.1f' % r.market_total) ~ ( ' | Model Lean: ' ~ (r.lean_ou_side or '–') ) %}
              {% endif %}
              <div class="seg {{ ou_cls }}" title="{{ tooltip }}">Overall: {% if r.actual_total is defined and r.actual_total is not none %}{{ '%.0f' % r.actual_total }}{% else %}–{% endif %}</div>
              {# Removed half basis badges from Full Game Actuals; now shown in Derivatives Odds rows #}
            </div>
            {% endif %}
          </div>
          <div class="actions">
            {% if show_bootstrap and bootstrap_url %}
            <a class="btn btn-sm btn-outline-primary" href="{{ bootstrap_url }}" target="_blank">Bootstrap Slate</a>
            {% endif %}
            {% if show_diag and diag_url %}
            <a class="btn btn-sm btn-outline-secondary" href="{{ diag_url }}" target="_blank">Diagnostics</a>
            {% endif %}
            {% if fused_bootstrap_url %}
            <a class="btn btn-sm btn-outline-warning" href="{{ fused_bootstrap_url }}" target="_blank">Fused Bootstrap</a>
            {% endif %}
          </div>
          {% if r.has_derivatives is defined and r.has_derivatives %}
          <div class="section section-derivatives">
            <div class="title">Derivatives</div>
            <div class="half-lines">
              {# Full Game block removed from Derivatives per request #}
              <div class="deriv-group">
                <div class="group-title">1st Half</div>
                <div class="line-row">
                  <div class="seg label">Predictions</div>
                  <div class="seg">ATS: {% if r.pred_margin_1h is not none %}{% set imp1 = (r.pred_margin_1h * -1) %}{% if imp1 < 0 %}{{ home_disp or '–' }} {{ '%.1f' % imp1 }}{% elif imp1 > 0 %}{{ away_disp or '–' }} -{{ '%.1f' % imp1 }}{% else %}Pick{% endif %}{% else %}–{% endif %}
                    {% set _spr1 = (
                      (r.spread_home_1h if (r.spread_home_1h is not none and r.spread_home_1h == r.spread_home_1h) else none)
                      if (r.spread_home_1h is defined) else none
                    ) %}
                    {% if _spr1 is none and (r.closing_spread_home_1h is defined) %}
                      {% set _spr1 = (r.closing_spread_home_1h if (r.closing_spread_home_1h is not none and r.closing_spread_home_1h == r.closing_spread_home_1h) else none) %}
                    {% endif %}
                    {% if (r.pred_margin_1h is not none and r.pred_margin_1h == r.pred_margin_1h) and (_spr1 is not none) %}
                      {% set _edge_ats_1h = ((r.pred_margin_1h * -1) - _spr1) %}
                      <span class="badge" title="ATS edge vs spread (predicted 1H spread − market 1H spread)">Edge={{ '%.1f' % _edge_ats_1h }}</span>
                      <span class="badge" title="Predicted 1H spread minus market 1H spread (ATS)">ΔATS {{ '%.1f' % _edge_ats_1h }}</span>
                    {% endif %}
                  </div>
                  <div class="seg">Winner: {% if r.pred_margin_1h is not none %}{% if r.pred_margin_1h > 0 %}{{ home_disp }}{% elif r.pred_margin_1h < 0 %}{{ away_disp }}{% else %}Even{% endif %}{% else %}–{% endif %}</div>
                  <div class="seg">Team Totals: {% if r.proj_home_1h is not none and r.proj_away_1h is not none %}{{ away_disp or '–' }} {{ '%.1f' % r.proj_away_1h }} / {{ home_disp or '–' }} {{ '%.1f' % r.proj_home_1h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if r.pred_total_1h is not none %}{{ '%.1f' % r.pred_total_1h }}{% else %}–{% endif %}</div>
                </div>
                <div class="line-row odds-row">
                  <div class="seg label">Odds</div>
                  {% set spread_1h = r.spread_home_1h if (r.spread_home_1h is not none and r.spread_home_1h == r.spread_home_1h) else None %}
                  {% set total_1h = r.market_total_1h if (r.market_total_1h is not none and r.market_total_1h == r.market_total_1h) else None %}
                  <div class="seg">ATS: {% if spread_1h is not none %}{% if spread_1h < 0 %}{{ home_disp or '–' }} {{ '%.1f' % spread_1h }}{% elif spread_1h > 0 %}{{ away_disp or '–' }} -{{ '%.1f' % spread_1h }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
                  {% if spread_1h is not none %}
                    <div class="seg">Winner: {% if spread_1h < 0 %}{{ home_disp or '–' }}{% elif spread_1h > 0 %}{{ away_disp or '–' }}{% else %}Even{% endif %}</div>
                  {% else %}
                    {% set mlh1 = r.ml_home_1h %}
                    {% set mla1 = r.ml_away_1h %}
                    {% set has_mlh1 = (mlh1 is not none and mlh1 == mlh1) %}
                    {% set has_mla1 = (mla1 is not none and mla1 == mla1) %}
                    {% if has_mlh1 or has_mla1 %}
                      {% set winner_1h_ml = None %}
                      {% if has_mlh1 and has_mla1 %}
                        {% if mlh1 < 0 and (mla1 >= 0 or (0-mlh1) > (0-mla1)) %}
                          {% set winner_1h_ml = r.home_team or '–' %}
                        {% elif mla1 < 0 and (mlh1 >= 0 or (0-mla1) > (0-mlh1)) %}
                          {% set winner_1h_ml = r.away_team or '–' %}
                        {% else %}
                          {# Avoid abs filter: decide by American odds rules #}
                          {% if mlh1 >= 0 and mla1 >= 0 %}
                            {% set winner_1h_ml = (r.home_team if mlh1 <= mla1 else r.away_team) %}
                          {% elif mlh1 < 0 and mla1 < 0 %}
                            {% set winner_1h_ml = r.home_team or '–' %}
                          {% else %}
                            {% set winner_1h_ml = (r.home_team if mlh1 < mla1 else r.away_team) %}
                          {% endif %}
                        {% endif %}
                      {% elif has_mlh1 %}
                        {% set winner_1h_ml = (r.home_team if mlh1 < 0 else r.away_team) %}
                      {% elif has_mla1 %}
                        {% set winner_1h_ml = (r.away_team if mla1 < 0 else r.home_team) %}
                      {% endif %}
                      <div class="seg">Winner: {{ winner_1h_ml }}</div>
                    {% else %}
                      <div class="seg">Winner: –</div>
                    {% endif %}
                  {% endif %}
                  <div class="seg">Team Totals: {% if total_1h is not none and spread_1h is not none %}{% set home_imp_1h = (total_1h / 2) - (spread_1h / 2) %}{% set away_imp_1h = total_1h - home_imp_1h %}{{ away_disp or '–' }} {{ '%.1f' % away_imp_1h }} / {{ home_disp or '–' }} {{ '%.1f' % home_imp_1h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if total_1h is not none %}{{ '%.1f' % total_1h }}{% else %}–{% endif %}</div>
                  {% if total_1h is not none and r.market_total_1h_basis is defined and r.market_total_1h_basis %}
                    <div class="seg">
                      <span class="basis-badge {% if r.market_total_1h_basis == 'derived' %}basis-derived{% else %}basis-provider{% endif %}" title="1H total basis: {{ r.market_total_1h_basis }}">{% if r.market_total_1h_basis == 'derived' %}D{% else %}P{% endif %}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="line-row">
                  <div class="seg label">Actuals</div>
                  {% set cls_ats_1h = 'neutral' if (r.ats_result_1h == 'Push') else ('ok' if r.eval_ats_1h_ok else ('bad' if r.ats_result_1h else 'neutral')) %}
                  {# Safe 1H ATS team extraction #}
                  {% set ats_text_1h = (r.ats_result_1h ~ '') %}
                  {% set ats_team_1h = (r.home_team if 'Home' in ats_text_1h else (r.away_team if 'Away' in ats_text_1h else ('Push' if ats_text_1h == 'Push' else None))) %}
                  <div class="seg {{ cls_ats_1h }}">ATS: {% if ats_team_1h == 'Push' %}Push{% elif ats_team_1h %}{{ (home_disp if 'Home' in ats_text_1h else (away_disp if 'Away' in ats_text_1h else ats_team_1h)) }} Cover{% else %}–{% endif %}</div>
                  {# Compute 1H margin from scores (keys actual_margin_1h may be absent) #}
                    {% set h1_ok = (r.home_score_1h is not none and r.home_score_1h == r.home_score_1h) %}
                    {% set a1_ok = (r.away_score_1h is not none and r.away_score_1h == r.away_score_1h) %}
                    {% set margin_1h = (r.home_score_1h - r.away_score_1h) if (h1_ok and a1_ok) else None %}
                    {% set winner_team_1h = (r.home_team if (margin_1h is not none and margin_1h>0) else (r.away_team if (margin_1h is not none and margin_1h<0) else ('Push' if (margin_1h is not none and margin_1h == margin_1h and margin_1h == 0) else None))) %}
                  {% set cls_win_1h = 'neutral' if (winner_team_1h == 'Push') else ('ok' if r.eval_winner_1h_ok else ('bad' if winner_team_1h else 'neutral')) %}
                  <div class="seg {{ cls_win_1h }}">Winner: {{ (home_disp if winner_team_1h==r.home_team else (away_disp if winner_team_1h==r.away_team else winner_team_1h)) or '–' }}</div>
                    <div class="seg">Team Totals: {% if h1_ok and a1_ok %}{{ away_disp or '–' }} {{ r.away_score_1h }} / {{ home_disp or '–' }} {{ r.home_score_1h }}{% else %}–{% endif %}</div>
                    {% set at1_ok = (r.actual_total_1h is not none and r.actual_total_1h == r.actual_total_1h) %}
                    <div class="seg">Overall: {% if at1_ok %}{{ '%.0f' % r.actual_total_1h }}{% else %}–{% endif %}</div>
                </div>
              </div>
              <div class="deriv-group">
                <div class="group-title">2nd Half</div>
                <div class="line-row">
                  <div class="seg label">Predictions</div>
                  <div class="seg">ATS: {% if r.pred_margin_2h is not none %}{% set imp2 = (r.pred_margin_2h * -1) %}{% if imp2 < 0 %}{{ home_disp or '–' }} {{ '%.1f' % imp2 }}{% elif imp2 > 0 %}{{ away_disp or '–' }} -{{ '%.1f' % imp2 }}{% else %}Pick{% endif %}{% else %}–{% endif %}
                    {% set _spr2 = (
                      (r.spread_home_2h if (r.spread_home_2h is not none and r.spread_home_2h == r.spread_home_2h) else none)
                      if (r.spread_home_2h is defined) else none
                    ) %}
                    {% if _spr2 is none and (r.closing_spread_home_2h is defined) %}
                      {% set _spr2 = (r.closing_spread_home_2h if (r.closing_spread_home_2h is not none and r.closing_spread_home_2h == r.closing_spread_home_2h) else none) %}
                    {% endif %}
                    {% if (r.pred_margin_2h is not none and r.pred_margin_2h == r.pred_margin_2h) and (_spr2 is not none) %}
                      {% set _edge_ats_2h = ((r.pred_margin_2h * -1) - _spr2) %}
                      <span class="badge" title="ATS edge vs spread (predicted 2H spread − market 2H spread)">Edge={{ '%.1f' % _edge_ats_2h }}</span>
                      <span class="badge" title="Predicted 2H spread minus market 2H spread (ATS)">ΔATS {{ '%.1f' % _edge_ats_2h }}</span>
                    {% endif %}
                  </div>
                  <div class="seg">Winner: {% if r.pred_margin_2h is not none %}{% if r.pred_margin_2h > 0 %}{{ home_disp }}{% elif r.pred_margin_2h < 0 %}{{ away_disp }}{% else %}Even{% endif %}{% else %}–{% endif %}</div>
                  <div class="seg">Team Totals: {% if r.proj_home_2h is not none and r.proj_away_2h is not none %}{{ away_disp or '–' }} {{ '%.1f' % r.proj_away_2h }} / {{ home_disp or '–' }} {{ '%.1f' % r.proj_home_2h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if r.pred_total_2h is not none %}{{ '%.1f' % r.pred_total_2h }}{% else %}–{% endif %}</div>
                </div>
                <div class="line-row odds-row">
                  <div class="seg label">Odds</div>
                  {% set spread_2h = r.spread_home_2h if (r.spread_home_2h is not none and r.spread_home_2h == r.spread_home_2h) else None %}
                  {% set total_2h = r.market_total_2h if (r.market_total_2h is not none and r.market_total_2h == r.market_total_2h) else None %}
                  <div class="seg">ATS: {% if spread_2h is not none %}{% if spread_2h < 0 %}{{ home_disp or '–' }} {{ '%.1f' % spread_2h }}{% elif spread_2h > 0 %}{{ away_disp or '–' }} -{{ '%.1f' % spread_2h }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
                  {% if spread_2h is not none %}
                    <div class="seg">Winner: {% if spread_2h < 0 %}{{ home_disp or '–' }}{% elif spread_2h > 0 %}{{ away_disp or '–' }}{% else %}Even{% endif %}</div>
                  {% else %}
                    {% set mlh2 = r.ml_home_2h %}
                    {% set mla2 = r.ml_away_2h %}
                    {% set has_mlh2 = (mlh2 is not none and mlh2 == mlh2) %}
                    {% set has_mla2 = (mla2 is not none and mla2 == mla2) %}
                    {% if has_mlh2 or has_mla2 %}
                      {% set winner_2h_ml = None %}
                      {% if has_mlh2 and has_mla2 %}
                        {% if mlh2 < 0 and (mla2 >= 0 or (0-mlh2) > (0-mla2)) %}
                          {% set winner_2h_ml = r.home_team or '–' %}
                        {% elif mla2 < 0 and (mlh2 >= 0 or (0-mla2) > (0-mlh2)) %}
                          {% set winner_2h_ml = r.away_team or '–' %}
                        {% else %}
                          {% set winner_2h_ml = (r.home_team if (mlh2|abs) >= (mla2|abs) else r.away_team) %}
                        {% endif %}
                      {% elif has_mlh2 %}
                        {% set winner_2h_ml = (r.home_team if mlh2 < 0 else r.away_team) %}
                      {% elif has_mla2 %}
                        {% set winner_2h_ml = (r.away_team if mla2 < 0 else r.home_team) %}
                      {% endif %}
                      <div class="seg">Winner: {{ winner_2h_ml }}</div>
                    {% else %}
                      <div class="seg">Winner: –</div>
                    {% endif %}
                  {% endif %}
                  <div class="seg">Team Totals: {% if total_2h is not none and spread_2h is not none %}{% set home_imp_2h = (total_2h / 2) - (spread_2h / 2) %}{% set away_imp_2h = total_2h - home_imp_2h %}{{ away_disp or '–' }} {{ '%.1f' % away_imp_2h }} / {{ home_disp or '–' }} {{ '%.1f' % home_imp_2h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if total_2h is not none %}{{ '%.1f' % total_2h }}{% else %}–{% endif %}</div>
                  {% if total_2h is not none and r.market_total_2h_basis is defined and r.market_total_2h_basis %}
                    <div class="seg">
                      <span class="basis-badge {% if r.market_total_2h_basis == 'derived' %}basis-derived{% else %}basis-provider{% endif %}" title="2H total basis: {{ r.market_total_2h_basis }}">{% if r.market_total_2h_basis == 'derived' %}D{% else %}P{% endif %}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="line-row">
                  <div class="seg label">Actuals</div>
                  {% set cls_ats_2h = 'neutral' if (r.ats_result_2h == 'Push') else ('ok' if r.eval_ats_2h_ok else ('bad' if r.ats_result_2h else 'neutral')) %}
                  {# Safe 2H ATS team extraction #}
                  {% set ats_text_2h = (r.ats_result_2h ~ '') %}
                  {% set ats_team_2h = (r.home_team if 'Home' in ats_text_2h else (r.away_team if 'Away' in ats_text_2h else ('Push' if ats_text_2h == 'Push' else None))) %}
                  <div class="seg {{ cls_ats_2h }}">ATS: {% if ats_team_2h == 'Push' %}Push{% elif ats_team_2h %}{{ (home_disp if 'Home' in ats_text_2h else (away_disp if 'Away' in ats_text_2h else ats_team_2h)) }} Cover{% else %}–{% endif %}</div>
                  {# Compute 2H margin from second-half scores (avoid missing actual_margin_2h key) #}
                  {% set hs_ok = (r.home_score is not none and r.home_score == r.home_score) %}
                  {% set as_ok = (r.away_score is not none and r.away_score == r.away_score) %}
                  {% set h1_ok2 = (r.home_score_1h is not none and r.home_score_1h == r.home_score_1h) %}
                  {% set a1_ok2 = (r.away_score_1h is not none and r.away_score_1h == r.away_score_1h) %}
                  {% set home_2h = (r.home_score - r.home_score_1h) if (hs_ok and h1_ok2) else None %}
                  {% set away_2h = (r.away_score - r.away_score_1h) if (as_ok and a1_ok2) else None %}
                  {% set margin_2h = (home_2h - away_2h) if (home_2h is not none and home_2h == home_2h and away_2h is not none and away_2h == away_2h) else None %}
                  {% set winner_team_2h = (r.home_team if (margin_2h is not none and margin_2h>0) else (r.away_team if (margin_2h is not none and margin_2h<0) else ('Push' if (margin_2h is not none and margin_2h == margin_2h and margin_2h == 0) else None))) %}
                  {% set cls_win_2h = 'neutral' if (winner_team_2h == 'Push') else ('ok' if r.eval_winner_2h_ok else ('bad' if winner_team_2h else 'neutral')) %}
                  <div class="seg {{ cls_win_2h }}">Winner: {{ (home_disp if winner_team_2h==r.home_team else (away_disp if winner_team_2h==r.away_team else winner_team_2h)) or '–' }}</div>
                  <div class="seg">Team Totals: {% if hs_ok and as_ok and h1_ok2 and a1_ok2 %}{{ away_disp or '–' }} {{ r.away_score - r.away_score_1h }} / {{ home_disp or '–' }} {{ r.home_score - r.home_score_1h }}{% else %}–{% endif %}</div>
                  {% set at2_ok = (r.actual_total_2h is not none and r.actual_total_2h == r.actual_total_2h) %}
                  <div class="seg">Overall: {% if at2_ok %}{{ '%.0f' % r.actual_total_2h }}{% else %}–{% endif %}</div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% if r.home_score is not none and r.away_score is not none %}
            {% set hs = r.get('home_score') if r.get('home_score') is not none else 0 %}
            {% set as = r.get('away_score') if r.get('away_score') is not none else 0 %}
            {% set act_tot = r.get('actual_total') if r.get('actual_total') is not none else (hs + as) %}
            <div class="section">
              <div class="title">Final</div>
              <div class="kpi">
                <div class="pill">Total: {{ '%.0f' % act_tot if act_tot is not none and act_tot > 0 else '–' }}</div>
                {% if r.get('pred_total') is not none and act_tot is not none and act_tot > 0 %}
                  <div class="pill">Model Error: {{ '%.1f' % (act_tot - r.get('pred_total')) }}</div>
                {% endif %}
                {% if r.get('market_total') is not none and act_tot is not none and act_tot > 0 %}
                  {% set ou = 'Over' if act_tot > r.get('market_total') else ('Under' if act_tot < r.get('market_total') else 'Push') %}
                  {% set cls = 'neutral' if ou == 'Push' else ('ok' if r.get('eval_ou_ok') else 'bad') %}
                  <div class="pill {{ cls }}">vs {{ 'Last' if r.get('market_basis') == 'last' else 'Market' }}: {{ ou }}</div>
                {% endif %}
                {# Closing spread and total comparison pills removed; no UI elements for closing totals #}
                {% if r.ats_result is defined and r.ats_result %}
                  {% set cls3 = 'neutral' if r.ats_result == 'Push' else ('ok' if r.get('eval_ats_ok') else 'bad') %}
                  <div class="pill {{ cls3 }}">ATS: {{ r.ats_result }}</div>
                {% endif %}
                {% if r.ml_result is defined and r.ml_result %}
                  {% set cls5 = 'neutral' if r.ml_result == 'Push' else ('ok' if r.get('eval_ml_ok') else 'bad') %}
                  <div class="pill {{ cls5 }}">ML: {{ r.ml_result }}</div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          {% if r._odds_list %}
            <div class="kpi mt8">
              {% for o in r._odds_list %}
                <div class="pill">{{ o.book }}: {{ '%.1f' % o.total if o.total is not none else '–' }}</div>
              {% endfor %}
            </div>
          {% endif %}
          {# ATS / Moneyline section removed to reduce duplication #}
        </div>
      {% endfor %}
    </div>
  </div>
  <script>
  (function(){
    document.querySelectorAll('.badge-team').forEach(function(el){
      var bg = el.getAttribute('data-bg');
      if(bg){ el.style.background = bg; }
      var name = el.querySelector('.name');
      if(name){
        var tx = name.getAttribute('data-tx');
        if(tx){ name.style.color = tx; }
      }
    });
    // Render start times in server or user's local timezone with short TZ label.
    // Preference persisted in localStorage ('server' default). Only convert tz-aware ISO.
    try {
      var fmtLocal = new Intl.DateTimeFormat(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', timeZoneName:'short'});
      function formatLocalISO(iso){
        try{
          if(!iso) return null;
          iso = String(iso);
          // normalize space-separated to ISO 'T'
          if(iso.indexOf(' ')>=0 && iso.indexOf('T')<0){ iso = iso.replace(' ', 'T'); }
          // Only convert when ISO has explicit timezone info (Z or +/-HH:MM)
          var hasTz = /Z|[\+\-]\d{2}:?\d{2}$/.test(iso);
          if(!hasTz) return null;
          var d = new Date(iso);
          if(isNaN(d)) return null;
          return {dateObj:d, text: fmtLocal.format(d), title: d.toISOString()};
        }catch(e){ return null; }
      }
      // Fallback: parse server-rendered "YYYY-MM-DD HH:MM TZ" to local
      function parseServerTimeToLocal(txt){
        try{
          if(!txt) return null;
          var m = String(txt).match(/(\d{4}-\d{2}-\d{2})[, ]\s*(\d{2}:\d{2})\s*(?:AM|PM)?\s*([A-Z]{2,4})?/);
          if(!m) return null;
          var date = m[1], time = m[2], tz = (m[3]||'').toUpperCase();
          var tzMap = { 'UTC': 0, 'Z': 0, 'HST': -10, 'AKST': -9, 'PST': -8, 'PDT': -7, 'MST': -7, 'MDT': -6, 'CST': -6, 'CDT': -5, 'EST': -5, 'EDT': -4 };
          var off = tzMap.hasOwnProperty(tz) ? tzMap[tz] : null;
          if(off === null) return null;
          var iso = date + 'T' + time + ':00' + (off===0 ? 'Z' : (off>0? '+' : '-') + String(Math.abs(off)).padStart(2,'0') + ':00');
          return formatLocalISO(iso);
        }catch(e){ return null; }
      }
      function applyTzMode(mode){
        // Hard lock: do NOT convert server-rendered Central times.
        // Preserve server text; only set informative titles.
        var tzName = '';
        try { tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || ''; } catch(e){}
        document.querySelectorAll('.time-local').forEach(function(el){
          var serverText = (el.textContent || '').trim();
          el.dataset.server = serverText;
          // Keep displayed text exactly as provided by server (Central).
          // Build a debug title showing browser timezone for context.
          var iso = el.getAttribute('data-iso') || '';
          var dbg = 'Server: ' + serverText + (iso ? (' | ISO: ' + iso) : '') + (tzName ? (' | Browser TZ: ' + tzName) : '');
          el.title = dbg;
        });
              // Helper to add days in YYYY-MM-DD
              function _addDays(ymd, delta){
                try{
                  var parts = ymd.split('-');
                  var d = new Date(Date.UTC(parseInt(parts[0],10), parseInt(parts[1],10)-1, parseInt(parts[2],10)));
                  d.setUTCDate(d.getUTCDate()+delta);
                  var mm = (d.getUTCMonth()+1).toString().padStart(2,'0');
                  var dd = d.getUTCDate().toString().padStart(2,'0');
                  return d.getUTCFullYear()+'-'+mm+'-'+dd;
                }catch(e){ return ymd; }
              }
        // Convert quote timestamps to local short format (always)
        document.querySelectorAll('.quote-local').forEach(function(el){
          var iso = el.getAttribute('data-iso');
          var out = formatLocalISO(iso);
          if(out){
            el.textContent = 'Quote: ' + out.text;
            el.title = 'Quote (UTC): ' + (iso||'') + (tzName ? (' | Local TZ: ' + tzName) : '');
          }
        });
      }
      var selTz = document.getElementById('tzMode');
      var prefKey = 'ncaab:tzMode';
      // Force server timezone display; dropdown is informational only.
      var pref = 'server';
      try{ localStorage.setItem(prefKey, pref); }catch(e){}
      if(selTz){ selTz.value = 'server'; }
      applyTzMode('server');
      if(selTz){
        selTz.addEventListener('change', function(){
          // Store preference but do not change rendering (server-locked)
          try{ localStorage.setItem(prefKey, selTz.value); }catch(e){}
          applyTzMode('server');
        });
      }
    } catch(e) { /* noop */ }
    // Auto-set site/server timezone cookie to browser TZ on first visit
    try {
      var tzCookie = document.cookie.split('; ').find(function(x){ return x.startsWith('display_tz='); });
      var tzSetKey = 'ncaab:tzCookieSet';
      if(!tzCookie && !localStorage.getItem(tzSetKey)){
        var tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || '').trim();
        if(tz){
          fetch('/api/set_tz?json=1&tz=' + encodeURIComponent(tz))
            .then(function(){ localStorage.setItem(tzSetKey, '1'); })
            .catch(function(){});
        }
      }
      var btnSetSite = document.getElementById('btnSetSiteTz');
      if(btnSetSite){
        btnSetSite.addEventListener('click', function(){
          var tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || '').trim();
          if(!tz){ return; }
          btnSetSite.disabled = true;
          var txt = btnSetSite.textContent;
          btnSetSite.textContent = 'Setting…';
          fetch('/api/set_tz?json=1&tz=' + encodeURIComponent(tz))
            .then(function(){ btnSetSite.textContent = 'Set Site=My TZ'; btnSetSite.disabled = false; location.reload(); })
            .catch(function(){ btnSetSite.textContent = txt; btnSetSite.disabled = false; });
        });
      }
    } catch(e) { /* noop */ }
    // Optional auto-refresh every 60s (user-controlled); indicate live with title dot if not enabled
    var hasLive = document.querySelector('[data-live="1"]') !== null;
    var chk = document.getElementById('autoRefreshChk');
    var key = 'ncaab:autoRefresh';
    var saved = (localStorage.getItem(key) === '1');
    if (chk) {
      chk.checked = saved;
      chk.addEventListener('change', function(){
        localStorage.setItem(key, chk.checked ? '1' : '0');
      });
    }
    if(saved){
      setTimeout(function(){ location.reload(); }, 60000);
    } else if (hasLive) {
      document.title = '• ' + document.title;
    }
    // Guarded Finalize via AJAX (POST + confirm)
    var btn = document.getElementById('btnFinalize');
    if(btn){
      btn.addEventListener('click', function(){
        var dateVal = btn.getAttribute('data-date');
        if(!dateVal){ return; }
        var proceed = confirm('Finalize ' + dateVal + '? This closes out results.');
        if(!proceed){ return; }
        btn.disabled = true;
        var prevText = btn.textContent;
        btn.textContent = 'Finalizing…';
        fetch('/api/finalize-day', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateVal, confirm: true })
        })
          .then(function(r){ return r.json(); })
          .then(function(j){
            btn.textContent = prevText;
            btn.disabled = false;
            var ok = j && (j.ok || j.status === 'ok');
            showToast(ok ? ('Finalized ' + dateVal) : ('Finalize failed: ' + (j && j.error ? j.error : 'Unknown')),
              ok ? 'ok' : 'bad');
            if(ok){ setTimeout(function(){ location.reload(); }, 800); }
          })
          .catch(function(e){
            btn.textContent = prevText;
            btn.disabled = false;
            showToast('Finalize failed', 'bad');
          });
      });
    }
    function showToast(msg, kind){
      var t = document.createElement('div');
      t.className = 'toast ' + (kind||'');
      t.textContent = msg;
      document.body.appendChild(t);
      requestAnimationFrame(function(){ t.classList.add('show'); });
      setTimeout(function(){ t.classList.remove('show'); setTimeout(function(){ t.remove(); }, 300); }, 2200);
    }
  })();
  // Toggle raw vs calibrated total inline without reloading
  function toggleRaw(el){
    if(!el) return;
    var cal = el.getAttribute('data-cal');
    var raw = el.getAttribute('data-raw');
    var parent = el.parentElement;
    if(!parent) return;
    var showingRaw = el.getAttribute('data-state') === 'raw';
    var newVal = showingRaw ? cal : raw;
    // Replace first numeric occurrence after 'Total:' (simple heuristic)
    var re = /Total:\s*[0-9]+(\.[0-9])?/;
    parent.innerHTML = parent.innerHTML.replace(re, 'Total: ' + newVal);
    el.setAttribute('data-state', showingRaw ? 'cal' : 'raw');
    el.title = showingRaw ? 'Click to show raw model' : 'Click to show calibrated';
  }
  </script>
  <style>
    .notify-host{position:fixed;top:8px;right:8px;z-index:5000;display:flex;flex-direction:column;gap:6px;max-width:320px;}
    .notify-item{background:#222;color:#eee;padding:8px 12px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.4);font-size:14px;line-height:1.3;position:relative;opacity:.95;transition:opacity .25s,transform .25s;}
    .notify-item.notify-success{border-left:4px solid #2e8b57;}
    .notify-item.notify-warn{border-left:4px solid #b8860b;}
    .notify-item.notify-error{border-left:4px solid #b22222;}
    .notify-item.notify-info{border-left:4px solid #4682b4;}
    .notify-item.hide{opacity:0;transform:translateX(40px);}    
    .notify-close{background:transparent;border:none;color:#bbb;cursor:pointer;position:absolute;top:4px;right:6px;font-size:16px;line-height:14px;padding:2px;}
    .notify-close:hover{color:#fff;}
  </style>
  <script>
    (function(){
      async function loadStatus(){
        try{ const r = await fetch('/api/status'); return await r.json(); }catch(e){ return {}; }
      }
      function computeStake(edgePct, risk){
        if(!(risk && typeof edgePct === 'number' && isFinite(edgePct))) return null;
        var kcap = (risk.kelly_cap && isFinite(risk.kelly_cap)) ? Number(risk.kelly_cap) : 0.2;
        var expCap = (risk.exposure_cap_units && isFinite(risk.exposure_cap_units)) ? Number(risk.exposure_cap_units) : 2.0;
        var units = kcap * (edgePct/100) * 10;
        if(!isFinite(units)) return null;
        units = Math.max(0, Math.min(expCap, units));
        var lo = Math.max(0, units*0.75), hi = units*1.25;
        return {units: units, band: [lo, hi]};
      }
      function renderStakePills(risk){
        var cards = document.querySelectorAll('.game-card');
        cards.forEach(function(card){
          var e = parseFloat(card.getAttribute('data-edge')||'NaN');
          var stake = computeStake(e, risk);
          if(stake){
            var kpi = card.querySelector('.kpi');
            if(kpi){
              var pill = document.createElement('div');
              pill.className = 'pill';
              pill.textContent = 'Suggested Stake: ' + stake.units.toFixed(2) + 'u (' + stake.band[0].toFixed(2) + '–' + stake.band[1].toFixed(2) + 'u)';
              kpi.appendChild(pill);
            }
          }
        });
      }
      loadStatus().then(function(s){ renderStakePills(s && s.risk ? s.risk : null); });
    })();
  </script>
    <script>
      (function(){
        // Attach copy handlers: copy the time pill's debug title to clipboard
        function wireCopyButtons(){
          document.querySelectorAll('.game-card').forEach(function(card){
            var pill = card.querySelector('.time-local');
            var btn = card.querySelector('.copy-time');
            if(pill && btn && !btn.__wired){
              btn.__wired = true;
              btn.addEventListener('click', async function(){
                var txt = pill.title || (pill.textContent||'').trim();
                // Try modern clipboard API first
                try{
                  if(navigator.clipboard && navigator.clipboard.writeText){
                    await navigator.clipboard.writeText(txt);
                    try{ (window.showToast||function(){})('Time details copied', 'ok'); }catch(e){}
                    return;
                  }
                }catch(e){ /* fall through to legacy */ }
                // Legacy fallback using a temporary textarea
                try{
                  var ta = document.createElement('textarea');
                  ta.value = txt;
                  ta.setAttribute('readonly','');
                  ta.style.position = 'absolute';
                  ta.style.left = '-9999px';
                  document.body.appendChild(ta);
                  ta.select();
                  var ok = false;
                  try{ ok = document.execCommand('copy'); }catch(_e){ ok = false; }
                  ta.remove();
                  if(ok){ try{ (window.showToast||function(){})('Time details copied', 'ok'); }catch(e){} }
                  else{ try{ (window.showToast||function(){})('Copy failed', 'bad'); }catch(_){} }
                }catch(e){ try{ (window.showToast||function(){})('Copy failed', 'bad'); }catch(_){} }
              });
            }
          });
        }
        document.addEventListener('DOMContentLoaded', wireCopyButtons);
        // rewire on sorts/grouping as DOM changes
        document.addEventListener('click', function(e){
          var id = (e.target && e.target.id) || '';
          if(['sortByEdge','sortByConf','sortByFairDelta','applyFiltersBtn','clearFiltersBtn','presetStrongEdges','presetModEdges','presetHighConf','presetMarketAvail'].includes(id)){
            setTimeout(wireCopyButtons, 50);
          }
        });
      })();
    </script>
    <script>
      // Hide empty sections (Odds/Actuals/Derivatives) based on data flags
      document.addEventListener('DOMContentLoaded', function(){
        var cards = document.querySelectorAll('.game-card');
        cards.forEach(function(card){
          var hasOdds = card.getAttribute('data-has-odds') === '1';
          var hasActuals = card.getAttribute('data-has-actuals') === '1';
          var hasDeriv = card.getAttribute('data-has-derivatives') === '1';
          var secOdds = card.querySelector('.section-odds');
          var secActuals = card.querySelector('.section-actuals');
          var secDeriv = card.querySelector('.section-derivatives');
          if(secOdds && !hasOdds) secOdds.classList.add('hidden');
          if(secActuals && !hasActuals) secActuals.classList.add('hidden');
          if(secDeriv && !hasDeriv) secDeriv.classList.add('hidden');
        });
      });
    </script>
  <script>
    // Keyboard navigation across game cards (ArrowUp/Down/Page keys)
    (function(){
      var cards = Array.from(document.querySelectorAll('.game-card'));
      function focusCard(i){
        if(i<0||i>=cards.length) return;
        cards[i].focus({preventScroll:false});
        cards[i].scrollIntoView({behavior:'smooth', block:'center'});
        current = i;
      }
      var current = 0;
      document.addEventListener('keydown', function(e){
        if(!cards.length) return;
        if(e.key==='ArrowDown'){ e.preventDefault(); focusCard(Math.min(cards.length-1, current+1)); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); focusCard(Math.max(0, current-1)); }
        else if(e.key==='PageDown'){ e.preventDefault(); focusCard(Math.min(cards.length-1, current+5)); }
        else if(e.key==='PageUp'){ e.preventDefault(); focusCard(Math.max(0, current-5)); }
      });
    })();
  </script>
  <script>
    // Lazy-render disabled: load all cards immediately (user request)
    (function(){
      var container = document.querySelector('.cards');
      if(!container) return;
      var all = Array.from(container.children);
      // Ensure previously hidden cards (if any) are shown
      all.forEach(function(el){ el.style.display=''; });
      // Provide toggle hook (set localStorage 'cardsLazy' === '1' to re-enable old behavior)
      try {
        if(localStorage.getItem('cardsLazy') === '1') {
          // Optional: if user explicitly re-enables, fall back to simple chunk reveal
          var idx = 0;
          function revealNext(){
            var end = Math.min(all.length, idx + 50);
            for(var i=idx;i<end;i++){ all[i].style.display=''; }
            idx = end;
            if(idx >= all.length && sentinel){ observer.disconnect(); sentinel.remove(); }
          }
          all.forEach(function(el){ el.style.display='none'; });
            revealNext();
          var sentinel = document.createElement('div');
          sentinel.className = 'sentinel';
          sentinel.setAttribute('aria-hidden','true');
          container.appendChild(sentinel);
          var observer = new IntersectionObserver(function(entries){
            entries.forEach(function(ent){ if(ent.isIntersecting){ revealNext(); } });
          });
          observer.observe(sentinel);
        }
      } catch(e) { /* ignore */ }
    })();
  </script>
</body>
</html>
