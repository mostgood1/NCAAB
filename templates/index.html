<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NCAAB Betting – Cards</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
  <style>
    .basis-badge{display:inline-block;padding:0 4px;margin-left:4px;border-radius:3px;font-size:10px;line-height:14px;vertical-align:middle;}
    .basis-derived{background:#663399;color:#fff;}
    .basis-provider{background:#1b6d85;color:#fff;}
    .badge{display:inline-block;padding:0 4px;margin-left:4px;border-radius:3px;font-size:10px;line-height:14px;background:#444;color:#fff;vertical-align:middle;cursor:default;}
    .badge.cal{background:#0b7285;}
    .badge.raw{background:#5c940d;}
    .badge.adj{background:#d9480f;}
    .badge.toggle-raw{background:#495057;cursor:pointer;}
    .badge.toggle-raw:hover,.badge:hover{opacity:0.85;}
  </style>
</head>
<body>
  {# Dynamic CSS removed; will apply colors via data attributes and a script to avoid template/CSS lint conflicts #}
  <div class="container">
    {# Removed top picks and season summary for declutter #}
    <div class="row header">
      <h1>NCAAB – Cards</h1>
      <div class="spacer"></div>
      <nav class="nav-links">
        <a href="/home">Dashboard</a>
        <a href="/finals">Final Scores</a>
        <a href="/recommendations">Recommendations</a>
        <a href="/stake-sheet">Stake Sheet</a>
        <a href="/coverage">Coverage</a>
        <a href="/calibration">Calibration</a>
      </nav>
    </div>
    {% if status %}
      <div class="mb8 flex-row-wrap" id="statusStrip">
        {% if status.finalize %}
          {% if status.finalize.ready %}
            <span class="pill ok" title="All games finalized for {{ status.finalize.date }}">Finalize Ready</span>
            <a class="pill accent" href="/finalize?date={{ status.finalize.date }}" title="Trigger finalize for this date">Trigger Finalize</a>
          {% else %}
            <span class="pill warn" title="Finalized {{ status.finalize.final }} of {{ status.finalize.rows }}; {{ status.finalize.pending }} pending">Finalize: {{ status.finalize.final }}/{{ status.finalize.rows }}</span>
          {% endif %}
        {% endif %}
        {% if status.results_latest %}
          <a class="pill" title="Open results for date" href="/finals?date={{ status.results_latest }}">Results: {{ status.results_latest }}</a>
        {% endif %}
        {% if status.stake_latest %}
          <a class="pill" title="Open stake sheet for date" href="/stake-sheet?date={{ status.stake_latest }}">Stake: {{ status.stake_latest }}</a>
        {% endif %}
        {% if status.display_hash %}
          <span class="pill" title="Display hash present; alignment verified">Display Hash ✓</span>
        {% endif %}
        {% if status.providers %}
          <span class="pill provider-pill" title="ONNX providers available (click for details)">Providers: {{ status.ep_hint or 'n/a' }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.basis_share_total_cal is defined %}
          <span class="pill" title="Calibrated basis share (totals)">Cal%T {{ '%.0f' % (pipeline_stats.basis_share_total_cal * 100) }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.drift_total_delta_vs_median is defined %}
          <span class="pill" title="Delta vs 7-day median calibrated share (totals)">ΔCal7T {{ '%.1f' % (pipeline_stats.drift_total_delta_vs_median * 100) }}%</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.basis_share_margin_cal is defined %}
          <span class="pill" title="Calibrated basis share (margin)">Cal%M {{ '%.0f' % (pipeline_stats.basis_share_margin_cal * 100) }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.drift_margin_delta_vs_median is defined %}
          <span class="pill" title="Delta vs 7-day median calibrated share (margin)">ΔCal7M {{ '%.1f' % (pipeline_stats.drift_margin_delta_vs_median * 100) }}%</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.ece_total_roll7 is defined %}
          <span class="pill" title="7-day mean ECE total">ECE7T {{ '%.3f' % pipeline_stats.ece_total_roll7 }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.ece_margin_roll7 is defined %}
          <span class="pill" title="7-day mean ECE margin">ECE7M {{ '%.3f' % pipeline_stats.ece_margin_roll7 }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.sharpness_total_roll7 is defined %}
          <span class="pill" title="7-day sharpness total">Sharp7T {{ '%.2f' % pipeline_stats.sharpness_total_roll7 }}</span>
        {% endif %}
        {% if pipeline_stats and pipeline_stats.sharpness_margin_roll7 is defined %}
          <span class="pill" title="7-day sharpness margin">Sharp7M {{ '%.2f' % pipeline_stats.sharpness_margin_roll7 }}</span>
        {% endif %}
        <button type="button" id="btnCopyProviders" class="pill">Copy Providers</button>
        <button type="button" id="btnExportStatus" class="pill">Export Status</button>
      </div>
    {% endif %}
    <div id="providersModal" class="modal providers-modal hidden">
      <div class="modal-content providers-modal-content">
        <h3 class="providers-modal-title">ONNX Runtime Providers</h3>
        <div id="providersList" class="muted providers-modal-list">Loading...</div>
        <div class="mt12"><button id="closeProvidersModal" class="pill">Close</button><div class="close-hint">Press Esc to close</div></div>
      </div>
    </div>
    <script>
      (function(){
        const chk = document.getElementById('autoRefreshChk');
        let timer = null;
        const modal = document.getElementById('providersModal');
        const modalList = document.getElementById('providersList');
        const closeBtn = document.getElementById('closeProvidersModal');
        function renderStatus(data){
          const el = document.getElementById('statusStrip');
          if(!el||!data) return;
          const parts = [];
          if(data.finalize){
            if(data.finalize.ready){ parts.push('<span class="pill ok" title="All games finalized for '+data.finalize.date+'">Finalize Ready</span>'); parts.push('<a class="pill accent" href="/finalize?date='+data.finalize.date+'" title="Trigger finalize for this date">Trigger Finalize</a>'); }
            else { parts.push('<span class="pill warn" title="Finalized '+data.finalize.final+' of '+data.finalize.rows+'; '+data.finalize.pending+' pending">Finalize: '+data.finalize.final+'/'+data.finalize.rows+'</span>'); }
          }
          if(data.results_latest){ parts.push('<a class="pill" title="Open results for date" href="/finals?date='+data.results_latest+'">Results: '+data.results_latest+'</a>'); }
          if(data.stake_latest){ parts.push('<a class="pill" title="Open stake sheet for date" href="/stake-sheet?date='+data.stake_latest+'">Stake: '+data.stake_latest+'</a>'); }
          if(data.display_hash){ parts.push('<span class="pill" title="Display hash present; alignment verified">Display Hash ✓</span>'); }
          if(Array.isArray(data.providers) && data.providers.length){
            const hint = (data.ep_hint||'n/a');
            parts.push('<span class="pill provider-pill" title="ONNX providers available (click for details)">Providers: '+hint+'</span>');
          }
          if(typeof data.basis_share_total_cal === 'number'){ parts.push('<span class="pill" title="Calibrated basis share (totals)">Cal%T '+Math.round(data.basis_share_total_cal*100)+'</span>'); }
          if(typeof data.drift_total_delta_vs_median === 'number'){ parts.push('<span class="pill" title="Delta vs 7-day median calibrated share (totals)">ΔCal7T '+(data.drift_total_delta_vs_median*100).toFixed(1)+'%</span>'); }
          if(typeof data.basis_share_margin_cal === 'number'){ parts.push('<span class="pill" title="Calibrated basis share (margin)">Cal%M '+Math.round(data.basis_share_margin_cal*100)+'</span>'); }
          if(typeof data.drift_margin_delta_vs_median === 'number'){ parts.push('<span class="pill" title="Delta vs 7-day median calibrated share (margin)">ΔCal7M '+(data.drift_margin_delta_vs_median*100).toFixed(1)+'%</span>'); }
          if(typeof data.ece_total_roll7 === 'number'){ parts.push('<span class="pill" title="7-day mean ECE total">ECE7T '+data.ece_total_roll7.toFixed(3)+'</span>'); }
          if(typeof data.ece_margin_roll7 === 'number'){ parts.push('<span class="pill" title="7-day mean ECE margin">ECE7M '+data.ece_margin_roll7.toFixed(3)+'</span>'); }
          if(typeof data.sharpness_total_roll7 === 'number'){ parts.push('<span class="pill" title="7-day sharpness total">Sharp7T '+data.sharpness_total_roll7.toFixed(2)+'</span>'); }
          if(typeof data.sharpness_margin_roll7 === 'number'){ parts.push('<span class="pill" title="7-day sharpness margin">Sharp7M '+data.sharpness_margin_roll7.toFixed(2)+'</span>'); }
          el.innerHTML = parts.join(' ');
          const provPill = el.querySelector('.provider-pill');
          if(provPill){
            provPill.addEventListener('click', async ()=>{
              if(modal){
                modal.style.display='block';
                if(modalList) modalList.textContent='Loading...';
                try {
                  const r = await fetch('/api/ort-providers');
                  const j = await r.json();
                  if(modalList) modalList.textContent = JSON.stringify(j, null, 2);
                } catch(e){ if(modalList) modalList.textContent='Error loading providers'; }
              }
            });
          }
        }
        async function poll(){
          try{
            const r = await fetch('/api/status');
            const j = await r.json();
            renderStatus(j);
            window.__lastStatusPayload = j;
            // Adjust polling cadence based on server timestamp proximity
            try {
              const ts = j && j.server_timestamp ? Date.parse(j.server_timestamp) : null;
              if(ts){
                const now = Date.now();
                const skewMs = Math.abs(now - ts);
                // If skew is high or finalize suggested, poll faster
                const base = (j.finalize_suggested || (j.finalize && j.finalize.ready)) ? 15000 : 30000;
                const fast = (skewMs > 120000) ? 15000 : base;
                if(timer){ clearInterval(timer); }
                timer = setInterval(poll, fast);
              }
            } catch(e){}
          }catch(e){/*silent*/}
        }
                // Diagnostics controls: copy providers, export status JSON
                (function(){
                  const copyBtn = document.getElementById('btnCopyProviders');
                  const exportBtn = document.getElementById('btnExportStatus');
                  if(copyBtn){
                    copyBtn.addEventListener('click', async ()=>{
                      try{
                        const r = await fetch('/api/ort-providers');
                        const j = await r.json();
                        const txt = JSON.stringify(j, null, 2);
                        await navigator.clipboard.writeText(txt);
                        showToast('Providers copied', 'ok');
                      }catch(e){ showToast('Copy failed', 'bad'); }
                    });
                  }
                  if(exportBtn){
                    exportBtn.addEventListener('click', ()=>{
                      const data = (window.__lastStatusPayload || {});
                      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      const dt = (data && data.server_timestamp) ? String(data.server_timestamp).replace(/[:]/g,'-') : 'status';
                      a.href = url; a.download = `status_${dt}.json`; a.click();
                      setTimeout(()=>URL.revokeObjectURL(url), 500);
                    });
                  }
                })();
        function start(){ if(timer) clearInterval(timer); timer = setInterval(poll, 30000); poll(); }
        function stop(){ if(timer) { clearInterval(timer); timer=null; } }
        if(chk){
          try{
            const saved = localStorage.getItem('autoRefreshCards');
            if(saved === '1'){ chk.checked = true; }
          }catch(e){}
          const apply = ()=>{ try{ localStorage.setItem('autoRefreshCards', chk.checked ? '1' : '0'); }catch(e){}; if(chk.checked) start(); else stop(); };
          chk.addEventListener('change', apply);
          // apply on load
          apply();
        }
        if(closeBtn){ closeBtn.addEventListener('click', ()=>{ if(modal) modal.style.display='none'; }); }
        if(modal){
          modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; } });
          document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ modal.style.display='none'; } });
        }
      })();
    </script>
    {% if pipeline_stats and (pipeline_stats.using_blended_predictions or pipeline_stats.prefer_cal_effective) %}
      <div class="mb8 flex-row-wrap">
        {% if pipeline_stats.using_blended_predictions %}
          <span class="pill" title="Blended predictions active (segmented + baseline)">Blended Active</span>
        {% endif %}
        {% if pipeline_stats.prefer_cal_effective %}
          <span class="pill" title="Calibrated predictions prioritized for display">Cal Prioritized</span>
        {% endif %}
        {% if pipeline_stats.blend_weight_median is defined %}
          <span class="pill" title="Blend weight median (min–max)">Wmed {{ '%.2f' % pipeline_stats.blend_weight_median }} ({{ '%.2f' % pipeline_stats.blend_weight_min }}–{{ '%.2f' % pipeline_stats.blend_weight_max }})</span>
        {% endif %}
        {% if pipeline_stats.seg_n_rows_median is defined %}
          <span class="pill" title="Segment sample size median (min–max)">Nmed {{ '%.0f' % pipeline_stats.seg_n_rows_median }} ({{ '%.0f' % pipeline_stats.seg_n_rows_min }}–{{ '%.0f' % pipeline_stats.seg_n_rows_max }})</span>
        {% endif %}
        {% if pipeline_stats.edge_total_z_median is defined %}
          <span class="pill" title="Z-score of total edges (median)">Ztot~ {{ '%.2f' % pipeline_stats.edge_total_z_median }}</span>
        {% endif %}
        {% if pipeline_stats.edge_ats_z_median is defined %}
          <span class="pill" title="Z-score of ATS edges (median)">ZATS~ {{ '%.2f' % pipeline_stats.edge_ats_z_median }}</span>
        {% endif %}
      </div>
    {% endif %}
    <form method="get" class="filters">
      <label class="muted">Date:
        <input type="date" name="date" value="{{ date_val or '' }}" />
      </label>
      <label class="muted ml8">Time:
        <select id="tzMode">
          <option value="server">Site Time{% if pipeline_stats and pipeline_stats.display_tz_used %} ({{ pipeline_stats.display_tz_used }}){% endif %}</option>
          <option value="local">My Time (Browser)</option>
        </select>
        <button type="button" class="pill" id="btnSetSiteTz" title="Set site/server timezone to your browser timezone">Set Site=My TZ</button>
      </label>
      <label class="muted"><input type="checkbox" name="use_daily" value="1" {% if request.args.get('use_daily') in ['1','true','yes'] %}checked{% endif %}/> Use daily results</label>
      <button type="submit" class="pill">Apply</button>
      {% if date_val %}<a class="pill" href="/">Clear</a>{% endif %}
  {% if date_val %}<button type="button" class="pill" id="btnFinalize" data-date="{{ date_val }}">Finalize Results</button>{% endif %}
  <label class="muted ml8"><input type="checkbox" id="autoRefreshChk" /> Auto-refresh</label>
      {% if show_bootstrap %}
        <a class="pill accent" href="{{ bootstrap_url }}" title="Run minimal pipeline to generate today's games and predictions">Generate Today's Predictions</a>
      {% endif %}
      {% if show_diag %}
        <a class="pill warn" href="{{ diag_url }}" title="Live fetch ESPN+NCAA to compare counts">Schedule Diagnostics</a>
        {% if fused_bootstrap_url %}
          <a class="pill accent" href="{{ fused_bootstrap_url }}" title="Fetch both providers (cache bypass) and rebuild slate">Fused Bootstrap</a>
        {% endif %}
      {% endif %}
    </form>
    <div class="meta">{{ total_rows }} rows{% if date_val %} ({{ date_val }}){% endif %}
      {% if coverage %}
        <span class="pill">Odds Full: {{ coverage.full }}</span>
        <span class="pill">Partial: {{ coverage.partial }}</span>
        <span class="pill">None: {{ coverage.none }}</span>
      {% endif %}
    </div>
    {% if archive_dates and date_val %}
      {% set prev_date = None %}
      {% set next_date = None %}
      {% for d in archive_dates %}
        {% if d == date_val %}
          {% if loop.index0 > 0 %}{% set prev_date = archive_dates[loop.index0 - 1] %}{% endif %}
          {% if loop.index0 + 1 < archive_dates|length %}{% set next_date = archive_dates[loop.index0 + 1] %}{% endif %}
        {% endif %}
      {% endfor %}
      <div class="archive-stepper">
        {% if prev_date %}<a class="pill" href="/?date={{ prev_date }}&use_daily=1">◀ Prev</a>{% endif %}
        {% if next_date %}<a class="pill" href="/?date={{ next_date }}&use_daily=1">Next ▶</a>{% endif %}
      </div>
    {% endif %}
    {% if archive_dates %}
      <div class="archive-nav">
        <details>
          <summary class="pill">Archive Dates ({{ archive_dates|length }})</summary>
          <div class="dates-list">
            {# Quick picker: search by typing, jump to latest #}
            <div class="muted m4v8">
              <input type="text" id="archiveSearch" placeholder="Filter dates (YYYY-MM-DD)" class="pill archive-search" />
              {% set latest = archive_dates[-1] if archive_dates|length > 0 else None %}
              {% if latest %}<a class="pill accent" href="/?date={{ latest }}&use_daily=1" title="Jump to latest archive">Latest: {{ latest }}</a>{% endif %}
            </div>
            <div id="archiveList" class="dates-list">
              {% for d in archive_dates[-60:] %}
                <a class="pill small{% if d == date_val %} active{% endif %}" data-date="{{ d }}" href="/?date={{ d }}&use_daily=1">{{ d }}</a>
              {% endfor %}
            </div>
          </div>
        </details>
      </div>
      <script>
        (function(){
          var input = document.getElementById('archiveSearch');
          var list = document.getElementById('archiveList');
          if(!input||!list) return;
          input.addEventListener('input', function(){
            var q = (input.value||'').trim().toLowerCase();
            list.querySelectorAll('a[data-date]').forEach(function(a){
              var d = (a.getAttribute('data-date')||'').toLowerCase();
              a.style.display = (!q || d.indexOf(q) !== -1) ? 'inline-block' : 'none';
            });
          });
        })();
      </script>
    {% endif %}
    {% if uniform_note %}
      <div class="card mb8"><div class="muted">{{ uniform_note }}</div></div>
    {% endif %}
    {% if coverage_note %}
      <div class="card mb8"><div class="muted">{{ coverage_note }}</div></div>
    {% endif %}
    {% if pipeline_stats %}
      <div class="card mb8">
        <details open>
          <summary class="pill">Diagnostics</summary>
          <div class="muted m4v8">
            Date: {{ pipeline_stats.date_param or date_val or 'n/a' }} · Rows: {{ pipeline_stats.final_rows or total_rows }} · Predictions Loaded: {{ pipeline_stats.preds_load_rows }} · Model Rows: {{ pipeline_stats.model_preds_load_rows }}
          </div>
          <div class="diag-grid flex-row-wrap">
            {% if pipeline_stats.corr_pred_total_model_market is defined %}<span class="pill" title="Correlation between model totals and market totals">Corr(model,market): {{ '%.3f' % pipeline_stats.corr_pred_total_model_market }}</span>{% endif %}
            {% if pipeline_stats.mae_pred_total_model_vs_pred_total is defined %}<span class="pill" title="MAE between model total and heuristic/synthetic pred_total">MAE(model vs pred): {{ '%.2f' % pipeline_stats.mae_pred_total_model_vs_pred_total }}</span>{% endif %}
            {% if pipeline_stats.pred_equal_market_count is defined %}<span class="pill" title="Count of games where pred_total ~= market_total (rounded .1)">Pred==Market: {{ pipeline_stats.pred_equal_market_count }}</span>{% endif %}
            {% if pipeline_stats.low_pred_count_lt115 is defined %}<span class="pill" title="Pred totals below 115 (post-adjustment)">LowPred&lt;115: {{ pipeline_stats.low_pred_count_lt115 }}</span>{% endif %}
            {% if pipeline_stats.synthetic_market_total_count is defined %}<span class="pill" title="Synthetic market totals filled from pred/derived">Synthetic Totals: {{ pipeline_stats.synthetic_market_total_count }}</span>{% endif %}
            {% if pipeline_stats.synthetic_spread_home_count is defined %}<span class="pill" title="Synthetic spreads from pred_margin">Synthetic Spreads: {{ pipeline_stats.synthetic_spread_home_count }}</span>{% endif %}
            {% if pipeline_stats.missing_market_total_rows is defined %}<span class="pill" title="Games lacking market_total & closing_total">Missing Totals: {{ pipeline_stats.missing_market_total_rows }}</span>{% endif %}
            {% if pipeline_stats.missing_pred_total_rows is defined %}<span class="pill" title="Games lacking pred_total">Missing Preds: {{ pipeline_stats.missing_pred_total_rows }}</span>{% endif %}
          </div>
          {% if pipeline_stats.pred_total_basis_counts %}
            <div class="muted mt4">Basis Distribution:
              {% for k,v in pipeline_stats.pred_total_basis_counts.items() %}<span class="pill small" title="{{ k }} basis count">{{ k }}={{ v }}</span>{% endfor %}
            </div>
          {% endif %}
          {% if pipeline_stats.pred_equal_market_sample %}
            <div class="muted mt4">Sample Pred==Market IDs: {{ pipeline_stats.pred_equal_market_sample|join(', ') }}</div>
          {% endif %}
          {% if pipeline_stats.low_pred_game_ids %}
            <div class="muted mt4">Low Pred IDs (&lt;115): {{ pipeline_stats.low_pred_game_ids|join(', ') }}</div>
          {% endif %}
          {% if pipeline_stats.missing_odds_game_ids %}
            <div class="muted mt4">Missing Odds IDs: {{ pipeline_stats.missing_odds_game_ids|join(', ') }}</div>
          {% endif %}
        </details>
      </div>
      {% if pipeline_stats.recalibration_ingested %}
        <div class="card mb8">
          <details open>
            <summary class="pill">Model Health</summary>
            <div class="muted m4v8">
              Recalibration Needed: {% if pipeline_stats.recalibration_needed %}<span class="pill bad" title="Thresholds exceeded – retraining advised">Yes</span>{% else %}<span class="pill ok" title="Within thresholds">No</span>{% endif %}
            </div>
            {% if pipeline_stats.recalibration_reasons %}
              <div class="muted mt4">Reasons:
                {% for rsn in pipeline_stats.recalibration_reasons %}<span class="pill small" title="Trigger reason">{{ rsn }}</span>{% endfor %}
              </div>
            {% endif %}
            {# Surface key drift metrics dynamically (any pipeline_stats starting with recalib_) #}
            <div class="diag-grid flex-row-wrap mt4">
              {% for k,v in pipeline_stats.items() %}
                {% if k.startswith('recalib_') and v is not none %}
                  <span class="pill" title="{{ k }}">{{ k[8:] }}: {% if v is number %}{{ '%.3f' % v }}{% else %}{{ v }}{% endif %}</span>
                {% endif %}
              {% endfor %}
            </div>
            {% if pipeline_stats.reliability_trend_rows %}
              <div class="muted mt8">Rolling 7-Day Reliability:
                {% if pipeline_stats.ece_total_roll7 is defined %}<span class="pill small" title="7-day mean ECE total">ECE Total7={{ '%.3f' % pipeline_stats.ece_total_roll7 }}</span>{% endif %}
                {% if pipeline_stats.ece_margin_roll7 is defined %}<span class="pill small" title="7-day mean ECE margin">ECE Margin7={{ '%.3f' % pipeline_stats.ece_margin_roll7 }}</span>{% endif %}
                {% if pipeline_stats.sharpness_total_roll7 is defined %}<span class="pill small" title="7-day sharpness total">Sharp Total7={{ '%.2f' % pipeline_stats.sharpness_total_roll7 }}</span>{% endif %}
                {% if pipeline_stats.sharpness_margin_roll7 is defined %}<span class="pill small" title="7-day sharpness margin">Sharp Margin7={{ '%.2f' % pipeline_stats.sharpness_margin_roll7 }}</span>{% endif %}
              </div>
            {% endif %}
          </details>
        </div>
      {% endif %}
    {% endif %}
    {% if removed_empty_rows is defined and removed_empty_rows and removed_empty_rows > 0 %}
      <div class="card mb8"><div class="muted">Filtered {{ removed_empty_rows }} empty game{% if removed_empty_rows>1 %}s{% endif %} (no odds or predictions).</div></div>
    {% endif %}
    <div class="cards">
      {% for r in rows %}
        <div class="card" data-live="{{ '1' if (r.live is defined and r.live) else '0' }}">
          <div class="game-header">
            <div class="teams-row">
              <div class="badge-team away" data-bg="{{ r.away_color or '' }}">
                {% if r.away_logo %}
                  <img class="logo" src="{{ r.away_logo }}" alt="{{ r.away_team or 'Away' }} logo" />
                {% endif %}
                <span class="name" data-tx="{{ r.away_color_text or '' }}">{{ r.away_team or 'Away' }}</span>
                {% if r.away_rank is defined and r.away_rank %}<span class="rank">#{{ r.away_rank }}</span>{% endif %}
              </div>
              <div class="vs sep">@</div>
              <div class="badge-team home" data-bg="{{ r.home_color or '' }}">
                {% if r.home_logo %}
                  <img class="logo" src="{{ r.home_logo }}" alt="{{ r.home_team or 'Home' }} logo" />
                {% endif %}
                <span class="name" data-tx="{{ r.home_color_text or '' }}">{{ r.home_team or 'Home' }}</span>
                {% if r.home_rank is defined and r.home_rank %}<span class="rank">#{{ r.home_rank }}</span>{% endif %}
              </div>
            </div>
            <div class="meta-row">
              {# Single card-level CAL badge (header). Show once per card, not per metric. #}
              {% set is_cal_card = (r.pred_total_basis in ['model_calibrated','model_calibrated_bias','cal']) or (r.pred_margin_basis in ['model_calibrated','model_calibrated_bias','cal']) %}
              {% if is_cal_card %}
                <span class="badge cal" title="Calibrated predictions">CAL</span>
              {% endif %}
              {# Meta diagnostics badges: volatility and edge confidence if available #}
              {% if r.volatility_tag is defined and r.volatility_tag %}
                <span class="badge" title="Volatility class from meta diagnostics">Vol {{ r.volatility_tag }}</span>
              {% endif %}
              {% if r.edge_conf_tag is defined and r.edge_conf_tag %}
                <span class="badge" title="Edge confidence tag from meta">Conf {{ r.edge_conf_tag }}</span>
              {% endif %}
              {# Prefer server-provided ISO-UTC for stable JS conversion; fallback to raw start_time #}
              {% set iso = (r.start_time_iso if (r.start_time_iso is defined and r.start_time_iso) else (r.start_time if (r.start_time is defined) else None)) %}
              {# Display preference: dedicated display string -> legacy local -> raw start_time -> ISO #}
              {% set disp = (r.start_time_display if (r.start_time_display is defined and r.start_time_display) else (r.start_time_local if (r.start_time_local is defined and r.start_time_local) else (r.start_time if (r.start_time is defined and r.start_time) else (r.start_time_iso if (r.start_time_iso is defined and r.start_time_iso) else None)))) %}
              {% set tzabbr = (r.start_tz_abbr if (r.start_tz_abbr is defined and r.start_tz_abbr) else None) %}
              {% if iso or disp %}
                <span class="pill time-local" data-iso="{{ iso or '' }}">{{ disp or '' }}{% if tzabbr %} {{ tzabbr }}{% endif %}</span>
              {% endif %}
              {% set venue = (r.venue_full or r.venue or r.arena or r.stadium or r.site_name or r.location or r.city) if (r is defined) else None %}
              {% if venue %}<span class="pill venue">{{ venue }}{% if r.city and r.state %} – {{ r.city }}, {{ r.state }}{% elif r.city %} – {{ r.city }}{% endif %}</span>{% endif %}
              {% if r.neutral_site %}<span class="pill neutral">Neutral Site</span>{% endif %}
            </div>
          </div>
          <div class="kpi">
            {% if r.pred_synthetic_hidden %}
              <div class="pill accent" title="Awaiting real model predictions ingestion for this date">Predictions Pending</div>
            {% endif %}
            {# Odds coverage badge: show when odds are missing or partial #}
            {# Treat market_total/spread_home/ml as coverage signals #}
            {% set has_total = (
              (r.market_total is defined and r.market_total is not none and r.market_total == r.market_total)
              or (r.closing_total is defined and r.closing_total is not none and r.closing_total == r.closing_total)
            ) %}
            {% set has_spread = (
              (r.spread_home is defined and r.spread_home is not none and r.spread_home == r.spread_home)
              or (r.closing_spread_home is defined and r.closing_spread_home is not none and r.closing_spread_home == r.closing_spread_home)
            ) %}
            {% set has_ml = (r.ml_home is defined and r.ml_home is not none) %}
            {% if not has_total and not has_spread and not has_ml %}
              <div class="pill bad">No Odds Coverage</div>
            {% elif not has_total or not has_spread or not has_ml %}
              <div class="pill neutral">Partial Odds Coverage</div>
            {% endif %}
            {% if r.neutral_site %}
              <div class="pill">Neutral Site</div>
            {% endif %}
            {# Calibrated/raw/adjustment badges with interactive toggle #}
            {% set is_cal = r.pred_total_basis in ['model_calibrated','model_calibrated_bias','cal'] %}
            {% set is_raw = r.pred_total_basis in ['model_raw','model','model_v1'] %}
            {% set _pt = r.pred_total %}
            {% set _pt_valid = (_pt is not none and _pt == _pt) %} {# treat NaN as invalid (NaN != NaN) #}
            {% set _mt = r.market_total if (r.market_total is defined) else None %}
            {% set _mt_valid = (_mt is not none and _mt == _mt) %}
            <div class="pill">Total: {{ '%.1f' % _pt if _pt_valid else ( '%.1f' % _mt if _mt_valid else '–') }}
              {% if r.pred_total_adjusted %}<span class="badge adj" title="Low-total blend adjustment applied">Adj</span>{% endif %}
              {% if r.pred_total_model_raw is defined and r.pred_total_model_raw is not none and r.pred_total_model_raw == r.pred_total_model_raw and is_cal and _pt_valid %}
                <span class="badge toggle-raw" data-raw="{{ '%.1f' % r.pred_total_model_raw }}" data-cal="{{ '%.1f' % _pt }}" onclick="toggleRaw(this)" title="Click to toggle raw vs calibrated">↔</span>
              {% endif %}
              {% if r.blend_effective is defined and r.blend_effective and r.blend_weight is not none and r.blend_weight > 0 %}<span class="badge weight" title="Blend weight (segmented vs baseline)">W={{ '%.2f' % r.blend_weight }}</span>{% endif %}
              {% if r.blend_effective is defined and r.blend_effective and r.seg_n_rows_orig is defined and r.seg_n_rows_orig is not none and r.seg_n_rows_orig > 0 %}<span class="badge sample" title="Segment sample size contributing to blended prediction (rows)">N={{ '%.0f' % r.seg_n_rows_orig }}</span>{% endif %}
            </div>
            <div class="pill">
              {% if r.pred_margin is not none %}
                {% if r.favored_side == 'Home' %}Margin: {{ r.home_team or '–' }} by {{ '%.1f' % (r.favored_by or 0) }}{% elif r.favored_side == 'Away' %}Margin: {{ r.away_team or '–' }} by {{ '%.1f' % (r.favored_by or 0) }}{% else %}Margin: Even{% endif %}
              {% else %}Margin: –{% endif %}
            </div>
            {% if (r.proj_home is not none and r.proj_home == r.proj_home) and (r.proj_away is not none and r.proj_away == r.proj_away) %}
              {# Suppress projection pill when values are NaN (NaN != NaN) or missing #}
              {% set _ph_valid = (r.proj_home is not none and r.proj_home == r.proj_home) %}
              {% set _pa_valid = (r.proj_away is not none and r.proj_away == r.proj_away) %}
              {% if _ph_valid and _pa_valid %}
                <div class="pill">Projected: {{ '%.1f' % r.proj_away }} - {{ '%.1f' % r.proj_home }}</div>
              {% endif %}
            {% endif %}
            {% if r.market_total is defined and r.market_total is not none and r.market_total == r.market_total %}
              {% if r.market_basis == 'last' %}
              {# Meta & Stability panels: show when artifacts ingested #}
              {% if pipeline_stats.meta_probs_ingested or pipeline_stats.prob_stability_ingested or pipeline_stats.auto_refresh_calibration_ingested %}
                {% if pipeline_stats.meta_probs_ingested %}
                  <div class="card mb8">
                    <details open>
                      <summary class="pill">Meta Probabilities</summary>
                      <div class="diag-grid flex-row-wrap mt4">
                        {% if pipeline_stats.meta_auc_total is defined %}<span class="pill" title="Meta AUC for total">AUC Total: {{ '%.3f' % pipeline_stats.meta_auc_total }}</span>{% endif %}
                        {% if pipeline_stats.meta_brier_total is defined %}<span class="pill" title="Meta Brier score for total">Brier Total: {{ '%.3f' % pipeline_stats.meta_brier_total }}</span>{% endif %}
                        {% if pipeline_stats.meta_auc_ats is defined %}<span class="pill" title="Meta AUC for ATS">AUC ATS: {{ '%.3f' % pipeline_stats.meta_auc_ats }}</span>{% endif %}
                        {% if pipeline_stats.meta_brier_ats is defined %}<span class="pill" title="Meta Brier score for ATS">Brier ATS: {{ '%.3f' % pipeline_stats.meta_brier_ats }}</span>{% endif %}
                        {% if pipeline_stats.meta_n_rows is defined %}<span class="pill" title="Rows contributing to meta metrics">Rows: {{ pipeline_stats.meta_n_rows }}</span>{% endif %}
                      </div>
                    </details>
                  </div>
                {% endif %}
                {% if pipeline_stats.prob_stability_ingested %}
                  <div class="card mb8">
                    <details open>
                      <summary class="pill">Probability Stability</summary>
                      <div class="diag-grid flex-row-wrap mt4">
                        {% if pipeline_stats.prob_stability_mean is defined %}<span class="pill" title="Mean stability across methods">Mean: {{ '%.3f' % pipeline_stats.prob_stability_mean }}</span>{% endif %}
                        {% if pipeline_stats.prob_stability_q10 is defined %}<span class="pill" title="Lower tail stability (q10)">q10: {{ '%.3f' % pipeline_stats.prob_stability_q10 }}</span>{% endif %}
                        {% if pipeline_stats.prob_stability_q90 is defined %}<span class="pill" title="Upper tail stability (q90)">q90: {{ '%.3f' % pipeline_stats.prob_stability_q90 }}</span>{% endif %}
                        {% if pipeline_stats.prob_stability_n_rows is defined %}<span class="pill" title="Rows contributing to stability metrics">Rows: {{ pipeline_stats.prob_stability_n_rows }}</span>{% endif %}
                      </div>
                    </details>
                  </div>
                {% endif %}
                {% if pipeline_stats.auto_refresh_calibration_ingested %}
                  <div class="card mb8">
                    <details open>
                      <summary class="pill">Auto Calibration</summary>
                      <div class="diag-grid flex-row-wrap mt4">
                        {% if pipeline_stats.auto_cal_refresh_hint is defined %}<span class="pill" title="Auto-refresh hint status">Hint: {{ pipeline_stats.auto_cal_refresh_hint }}</span>{% endif %}
                        {% if pipeline_stats.auto_cal_last_refresh_dt is defined %}<span class="pill" title="Last calibration refresh datetime">Last: {{ pipeline_stats.auto_cal_last_refresh_dt }}</span>{% endif %}
                        {% if pipeline_stats.auto_cal_due is defined %}<span class="pill" title="Calibration due flag">Due: {{ 'Yes' if pipeline_stats.auto_cal_due else 'No' }}</span>{% endif %}
                      </div>
                    </details>
                  </div>
                {% endif %}
              {% endif %}
                <div class="pill">Last (pre-tip): {{ '%.1f' % r.market_total }}</div>
              {% else %}
                <div class="pill">Market Total: {{ '%.1f' % r.market_total }}
                  {% if r.quotes_count is defined and r.quotes_count is not none %}
                    {% if r.quotes_count >= 2 %}
                      <span class="badge" title="Number of bookmaker totals aggregated for market total median">Q={{ r.quotes_count }}</span>
                    {% elif r.quotes_count == 1 %}
                      <span class="badge badge-warn" title="Low market depth (only 1 bookmaker quote aggregated)">Q=1</span>
                    {% elif r.quotes_count == 0 %}
                      <span class="badge badge-warn" title="Low market depth (no bookmaker totals aggregated)">Q=0</span>
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
              {% if r.edge_total is defined and r.edge_total is not none and r.edge_total == r.edge_total %}
                {% set abs_et = r.edge_total|abs %}
                {% set cls_et = (
                  'edge-zero' if abs_et < 0.1 else
                  'edge-weak' if abs_et < 1.0 else
                  'edge-mod' if abs_et < 2.0 else
                  'edge-strong' if abs_et < 3.5 else
                  'edge-extreme'
                ) %}
                <div class="pill {{ cls_et }}">Total Edge: {{ '%.1f' % r.edge_total }}</div>
                {% if r.edge_total_z is defined and r.edge_total_z is not none and r.edge_total_z == r.edge_total_z %}
                  <span class="badge" title="Total edge z-score">Z={{ '%.2f' % r.edge_total_z }}</span>
                {% endif %}
              {% endif %}
              {% if r.lean_ou_side is defined and r.lean_ou_side %}
                <div class="pill">OU Lean: {{ r.lean_ou_side }} {% if r.lean_ou_edge_abs is not none %}(+{{ '%.1f' % r.lean_ou_edge_abs }}){% endif %}</div>
              {% endif %}
            {% endif %}
            {# Closing line pills removed per request #}
          </div>
          {# Picks section intentionally removed #}
          <div class="section">
            <div class="title">Full Game</div>
            <div class="line-row preds-row">
              <div class="seg label">Predictions</div>
              <div class="seg">ATS: {% if r.pred_margin is not none %}{% set imp = (r.pred_margin * -1) %}{% if imp < 0 %}{{ r.home_team or '–' }} {{ '%.1f' % imp }}{% elif imp > 0 %}{{ r.away_team or '–' }} -{{ '%.1f' % imp }}{% else %}Pick{% endif %}{% else %}–{% endif %}
                {% if r.edge_ats is defined and r.edge_ats is not none and r.edge_ats == r.edge_ats %}
                  <span class="badge" title="ATS edge vs spread (pred_margin + spread)">Edge={{ '%.1f' % r.edge_ats }}</span>
                  {% if r.edge_ats_z is defined and r.edge_ats_z is not none and r.edge_ats_z == r.edge_ats_z %}
                    <span class="badge" title="ATS edge z-score">Z={{ '%.2f' % r.edge_ats_z }}</span>
                  {% endif %}
                {% endif %}
              </div>
              <div class="seg">Winner: {% if r.pred_margin is not none %}{% if r.pred_margin > 0 %}{{ r.home_team }}{% elif r.pred_margin < 0 %}{{ r.away_team }}{% else %}Even{% endif %}{% else %}–{% endif %}</div>
              <div class="seg">Team Totals: {% if (r.proj_home is not none and r.proj_home == r.proj_home) and (r.proj_away is not none and r.proj_away == r.proj_away) %}{{ r.away_team or '–' }} {{ '%.1f' % r.proj_away }} / {{ r.home_team or '–' }} {{ '%.1f' % r.proj_home }}{% else %}–{% endif %}</div>
                {% set _ph_valid = (r.proj_home is not none and r.proj_home == r.proj_home) %}
                {% set _pa_valid = (r.proj_away is not none and r.proj_away == r.proj_away) %}
                <div class="seg">Team Totals: {% if _ph_valid and _pa_valid %}{{ r.away_team or '–' }} {{ '%.1f' % r.proj_away }} / {{ r.home_team or '–' }} {{ '%.1f' % r.proj_home }}{% else %}–{% endif %}</div>
              <div class="seg">Overall: {% if r.pred_total is not none %}{{ '%.1f' % r.pred_total }}{% else %}–{% endif %}</div>
            </div>
            {% set spread_full = r.spread_home if (r.spread_home is not none and r.spread_home == r.spread_home) else None %}
            {% set total_full = r.market_total if (r.market_total is not none and r.market_total == r.market_total) else None %}
            <div class="line-row odds-row">
              <div class="seg label">Odds</div>
              <div class="seg">ATS: {% if spread_full is not none %}{% if spread_full < 0 %}{{ r.home_team or '–' }} {{ '%.1f' % spread_full }}{% elif spread_full > 0 %}{{ r.away_team or '–' }} -{{ '%.1f' % spread_full }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
              <div class="seg">
                {% if r.kelly_frac_spread is defined and r.kelly_frac_spread is not none and r.kelly_frac_spread == r.kelly_frac_spread %}
                  <span class="badge" title="Kelly fraction suggestion for ATS using calibrated K and -110 price">Kelly: {{ '%.1f' % (r.kelly_frac_spread * 100) }}% {{ r.kelly_side_spread or '' }}</span>
                {% else %}
                  <span class="badge" title="Kelly fraction suggestion unavailable">Kelly: –</span>
                {% endif %}
              </div>
              {% if spread_full is not none %}
                <div class="seg">Winner: {% if spread_full < 0 %}{{ r.home_team or '–' }}{% elif spread_full > 0 %}{{ r.away_team or '–' }}{% else %}Even{% endif %}</div>
              {% else %}
                {% set mlh = r.ml_home if (r.ml_home is defined) else None %}
                {% set mla = r.ml_away if (r.ml_away is defined) else None %}
                {% set has_mlh = (mlh is not none and mlh == mlh) %}
                {% set has_mla = (mla is not none and mla == mla) %}
                {% if has_mlh or has_mla %}
                  {% set winner_ml = None %}
                  {% if has_mlh and has_mla %}
                    {% if mlh < 0 and (mla >= 0 or (0-mlh) > (0-mla)) %}
                      {% set winner_ml = r.home_team or '–' %}
                    {% elif mla < 0 and (mlh >= 0 or (0-mla) > (0-mlh)) %}
                      {% set winner_ml = r.away_team or '–' %}
                    {% else %}
                      {# Avoid abs filter: decide by American odds rules #}
                      {% if mlh >= 0 and mla >= 0 %}
                        {% set winner_ml = (r.home_team if mlh <= mla else r.away_team) %}
                      {% elif mlh < 0 and mla < 0 %}
                        {# More negative already handled above; on tie or unclear, default home #}
                        {% set winner_ml = r.home_team or '–' %}
                      {% else %}
                        {# Mixed signs: negative is favorite #}
                        {% set winner_ml = (r.home_team if mlh < mla else r.away_team) %}
                      {% endif %}
                    {% endif %}
                  {% elif has_mlh %}
                    {% set winner_ml = r.home_team or '–' %}
                  {% elif has_mla %}
                    {% set winner_ml = r.away_team or '–' %}
                  {% endif %}
                  <div class="seg">Winner: {{ winner_ml }}</div>
                {% else %}
                  <div class="seg">Winner: –</div>
                {% endif %}
              {% endif %}
              <div class="seg">Team Totals: {% if total_full is not none and spread_full is not none %}{% set home_imp_full = (total_full / 2) - (spread_full / 2) %}{% set away_imp_full = total_full - home_imp_full %}{{ r.away_team or '–' }} {{ '%.1f' % away_imp_full }} / {{ r.home_team or '–' }} {{ '%.1f' % home_imp_full }}{% else %}–{% endif %}</div>
              <div class="seg">Overall: {% if total_full is not none %}{{ '%.1f' % total_full }}{% else %}–{% endif %}</div>
            </div>
            <div class="line-row actuals-row">
              <div class="seg label">Actuals</div>
              {% set cls_ats_full = 'neutral' if (r.ats_result == 'Push') else ('ok' if r.eval_ats_ok else ('bad' if r.ats_result else 'neutral')) %}
              {# Coerce ats_result to string to avoid TypeError when NaN/float #}
              {% set ats_text = (r.ats_result ~ '') %}
              {% set ats_team_full = (r.home_team if ('Home' in ats_text) else (r.away_team if ('Away' in ats_text) else ('Push' if ats_text == 'Push' else None))) %}
              <div class="seg {{ cls_ats_full }}">ATS: {% if ats_team_full == 'Push' %}Push{% elif ats_team_full %}{{ ats_team_full }} Cover{% else %}–{% endif %}</div>
              {# Safe ML winner extraction: coerce ml_result to string to avoid TypeError on NaN/None #}
              {% set ml_text = (r.ml_result ~ '') %}
              {% set winner_team = r.home_team if 'Home' in ml_text else (r.away_team if 'Away' in ml_text else ('Push' if ml_text == 'Push' else None)) %}
              {% set cls_ml_full = 'neutral' if (winner_team == 'Push') else ('ok' if r.eval_ml_ok else ('bad' if winner_team else 'neutral')) %}
              <div class="seg {{ cls_ml_full }}">Winner: {{ winner_team or '–' }}</div>
              <div class="seg">Team Totals: {% if r.home_score is not none and r.away_score is not none %}{{ r.away_team or '–' }} {{ r.away_score }} / {{ r.home_team or '–' }} {{ r.home_score }}{% else %}–{% endif %}</div>
              {% set ou_actual = ( 'Over' if (r.actual_total is not none and r.market_total is not none and r.actual_total > r.market_total) else ( 'Under' if (r.actual_total is not none and r.market_total is not none and r.actual_total < r.market_total) else ('Push' if (r.actual_total is not none and r.market_total is not none and r.actual_total == r.market_total) else None))) %}
              {% set ou_cls = 'neutral' if (ou_actual == 'Push' or ou_actual is none) else ( 'ok' if (r.lean_ou_side is defined and r.lean_ou_side == ou_actual) else ('bad' if (r.lean_ou_side is defined and r.lean_ou_side and ou_actual and r.lean_ou_side != ou_actual) else 'neutral')) %}
              {% set tooltip = '' %}
              {% if r.actual_total is not none and r.market_total is not none %}
                {% set tooltip = 'vs Market: ' ~ (ou_actual or '–') ~ ' | Market: ' ~ ('%.1f' % r.market_total) ~ ( ' | Model Lean: ' ~ (r.lean_ou_side or '–') ) %}
              {% endif %}
              <div class="seg {{ ou_cls }}" title="{{ tooltip }}">Overall: {% if r.actual_total is defined and r.actual_total is not none %}{{ '%.0f' % r.actual_total }}{% else %}–{% endif %}</div>
              {# Removed half basis badges from Full Game Actuals; now shown in Derivatives Odds rows #}
            </div>
          </div>
          <div class="actions">
            {% if show_bootstrap and bootstrap_url %}
            <a class="btn btn-sm btn-outline-primary" href="{{ bootstrap_url }}" target="_blank">Bootstrap Slate</a>
            {% endif %}
            {% if show_diag and diag_url %}
            <a class="btn btn-sm btn-outline-secondary" href="{{ diag_url }}" target="_blank">Diagnostics</a>
            {% endif %}
            {% if fused_bootstrap_url %}
            <a class="btn btn-sm btn-outline-warning" href="{{ fused_bootstrap_url }}" target="_blank">Fused Bootstrap</a>
            {% endif %}
          </div>
          <div class="section">
            <div class="title">Derivatives</div>
            <div class="half-lines">
              {# Full Game block removed from Derivatives per request #}
              <div class="deriv-group">
                <div class="group-title">1st Half</div>
                <div class="line-row">
                  <div class="seg label">Predictions</div>
                  <div class="seg">ATS: {% if r.pred_margin_1h is not none %}{% set imp1 = (r.pred_margin_1h * -1) %}{% if imp1 < 0 %}{{ r.home_team or '–' }} {{ '%.1f' % imp1 }}{% elif imp1 > 0 %}{{ r.away_team or '–' }} -{{ '%.1f' % imp1 }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
                  <div class="seg">Winner: {% if r.pred_margin_1h is not none %}{% if r.pred_margin_1h > 0 %}{{ r.home_team }}{% elif r.pred_margin_1h < 0 %}{{ r.away_team }}{% else %}Even{% endif %}{% else %}–{% endif %}</div>
                  <div class="seg">Team Totals: {% if r.proj_home_1h is not none and r.proj_away_1h is not none %}{{ r.away_team or '–' }} {{ '%.1f' % r.proj_away_1h }} / {{ r.home_team or '–' }} {{ '%.1f' % r.proj_home_1h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if r.pred_total_1h is not none %}{{ '%.1f' % r.pred_total_1h }}{% else %}–{% endif %}</div>
                </div>
                <div class="line-row odds-row">
                  <div class="seg label">Odds</div>
                  {% set spread_1h = r.spread_home_1h if (r.spread_home_1h is not none and r.spread_home_1h == r.spread_home_1h) else None %}
                  {% set total_1h = r.market_total_1h if (r.market_total_1h is not none and r.market_total_1h == r.market_total_1h) else None %}
                  <div class="seg">ATS: {% if spread_1h is not none %}{% if spread_1h < 0 %}{{ r.home_team or '–' }} {{ '%.1f' % spread_1h }}{% elif spread_1h > 0 %}{{ r.away_team or '–' }} -{{ '%.1f' % spread_1h }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
                  {% if spread_1h is not none %}
                    <div class="seg">Winner: {% if spread_1h < 0 %}{{ r.home_team or '–' }}{% elif spread_1h > 0 %}{{ r.away_team or '–' }}{% else %}Even{% endif %}</div>
                  {% else %}
                    {% set mlh1 = r.ml_home_1h %}
                    {% set mla1 = r.ml_away_1h %}
                    {% set has_mlh1 = (mlh1 is not none and mlh1 == mlh1) %}
                    {% set has_mla1 = (mla1 is not none and mla1 == mla1) %}
                    {% if has_mlh1 or has_mla1 %}
                      {% set winner_1h_ml = None %}
                      {% if has_mlh1 and has_mla1 %}
                        {% if mlh1 < 0 and (mla1 >= 0 or (0-mlh1) > (0-mla1)) %}
                          {% set winner_1h_ml = r.home_team or '–' %}
                        {% elif mla1 < 0 and (mlh1 >= 0 or (0-mla1) > (0-mlh1)) %}
                          {% set winner_1h_ml = r.away_team or '–' %}
                        {% else %}
                          {# Avoid abs filter: decide by American odds rules #}
                          {% if mlh1 >= 0 and mla1 >= 0 %}
                            {% set winner_1h_ml = (r.home_team if mlh1 <= mla1 else r.away_team) %}
                          {% elif mlh1 < 0 and mla1 < 0 %}
                            {% set winner_1h_ml = r.home_team or '–' %}
                          {% else %}
                            {% set winner_1h_ml = (r.home_team if mlh1 < mla1 else r.away_team) %}
                          {% endif %}
                        {% endif %}
                      {% elif has_mlh1 %}
                        {% set winner_1h_ml = (r.home_team if mlh1 < 0 else r.away_team) %}
                      {% elif has_mla1 %}
                        {% set winner_1h_ml = (r.away_team if mla1 < 0 else r.home_team) %}
                      {% endif %}
                      <div class="seg">Winner: {{ winner_1h_ml }}</div>
                    {% else %}
                      <div class="seg">Winner: –</div>
                    {% endif %}
                  {% endif %}
                  <div class="seg">Team Totals: {% if total_1h is not none and spread_1h is not none %}{% set home_imp_1h = (total_1h / 2) - (spread_1h / 2) %}{% set away_imp_1h = total_1h - home_imp_1h %}{{ r.away_team or '–' }} {{ '%.1f' % away_imp_1h }} / {{ r.home_team or '–' }} {{ '%.1f' % home_imp_1h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if total_1h is not none %}{{ '%.1f' % total_1h }}{% else %}–{% endif %}</div>
                  {% if total_1h is not none and r.market_total_1h_basis is defined and r.market_total_1h_basis %}
                    <div class="seg">
                      <span class="basis-badge {% if r.market_total_1h_basis == 'derived' %}basis-derived{% else %}basis-provider{% endif %}" title="1H total basis: {{ r.market_total_1h_basis }}">{% if r.market_total_1h_basis == 'derived' %}D{% else %}P{% endif %}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="line-row">
                  <div class="seg label">Actuals</div>
                  {% set cls_ats_1h = 'neutral' if (r.ats_result_1h == 'Push') else ('ok' if r.eval_ats_1h_ok else ('bad' if r.ats_result_1h else 'neutral')) %}
                  {# Safe 1H ATS team extraction #}
                  {% set ats_text_1h = (r.ats_result_1h ~ '') %}
                  {% set ats_team_1h = (r.home_team if 'Home' in ats_text_1h else (r.away_team if 'Away' in ats_text_1h else ('Push' if ats_text_1h == 'Push' else None))) %}
                  <div class="seg {{ cls_ats_1h }}">ATS: {% if ats_team_1h == 'Push' %}Push{% elif ats_team_1h %}{{ ats_team_1h }} Cover{% else %}–{% endif %}</div>
                  {# Compute 1H margin from scores (keys actual_margin_1h may be absent) #}
                    {% set h1_ok = (r.home_score_1h is not none and r.home_score_1h == r.home_score_1h) %}
                    {% set a1_ok = (r.away_score_1h is not none and r.away_score_1h == r.away_score_1h) %}
                    {% set margin_1h = (r.home_score_1h - r.away_score_1h) if (h1_ok and a1_ok) else None %}
                    {% set winner_team_1h = (r.home_team if (margin_1h is not none and margin_1h>0) else (r.away_team if (margin_1h is not none and margin_1h<0) else ('Push' if (margin_1h is not none and margin_1h == margin_1h and margin_1h == 0) else None))) %}
                  {% set cls_win_1h = 'neutral' if (winner_team_1h == 'Push') else ('ok' if r.eval_winner_1h_ok else ('bad' if winner_team_1h else 'neutral')) %}
                  <div class="seg {{ cls_win_1h }}">Winner: {{ winner_team_1h or '–' }}</div>
                    <div class="seg">Team Totals: {% if h1_ok and a1_ok %}{{ r.away_team or '–' }} {{ r.away_score_1h }} / {{ r.home_team or '–' }} {{ r.home_score_1h }}{% else %}–{% endif %}</div>
                    {% set at1_ok = (r.actual_total_1h is not none and r.actual_total_1h == r.actual_total_1h) %}
                    <div class="seg">Overall: {% if at1_ok %}{{ '%.0f' % r.actual_total_1h }}{% else %}–{% endif %}</div>
                </div>
              </div>
              <div class="deriv-group">
                <div class="group-title">2nd Half</div>
                <div class="line-row">
                  <div class="seg label">Predictions</div>
                  <div class="seg">ATS: {% if r.pred_margin_2h is not none %}{% set imp2 = (r.pred_margin_2h * -1) %}{% if imp2 < 0 %}{{ r.home_team or '–' }} {{ '%.1f' % imp2 }}{% elif imp2 > 0 %}{{ r.away_team or '–' }} -{{ '%.1f' % imp2 }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
                  <div class="seg">Winner: {% if r.pred_margin_2h is not none %}{% if r.pred_margin_2h > 0 %}{{ r.home_team }}{% elif r.pred_margin_2h < 0 %}{{ r.away_team }}{% else %}Even{% endif %}{% else %}–{% endif %}</div>
                  <div class="seg">Team Totals: {% if r.proj_home_2h is not none and r.proj_away_2h is not none %}{{ r.away_team or '–' }} {{ '%.1f' % r.proj_away_2h }} / {{ r.home_team or '–' }} {{ '%.1f' % r.proj_home_2h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if r.pred_total_2h is not none %}{{ '%.1f' % r.pred_total_2h }}{% else %}–{% endif %}</div>
                </div>
                <div class="line-row odds-row">
                  <div class="seg label">Odds</div>
                  {% set spread_2h = r.spread_home_2h if (r.spread_home_2h is not none and r.spread_home_2h == r.spread_home_2h) else None %}
                  {% set total_2h = r.market_total_2h if (r.market_total_2h is not none and r.market_total_2h == r.market_total_2h) else None %}
                  <div class="seg">ATS: {% if spread_2h is not none %}{% if spread_2h < 0 %}{{ r.home_team or '–' }} {{ '%.1f' % spread_2h }}{% elif spread_2h > 0 %}{{ r.away_team or '–' }} -{{ '%.1f' % spread_2h }}{% else %}Pick{% endif %}{% else %}–{% endif %}</div>
                  {% if spread_2h is not none %}
                    <div class="seg">Winner: {% if spread_2h < 0 %}{{ r.home_team or '–' }}{% elif spread_2h > 0 %}{{ r.away_team or '–' }}{% else %}Even{% endif %}</div>
                  {% else %}
                    {% set mlh2 = r.ml_home_2h %}
                    {% set mla2 = r.ml_away_2h %}
                    {% set has_mlh2 = (mlh2 is not none and mlh2 == mlh2) %}
                    {% set has_mla2 = (mla2 is not none and mla2 == mla2) %}
                    {% if has_mlh2 or has_mla2 %}
                      {% set winner_2h_ml = None %}
                      {% if has_mlh2 and has_mla2 %}
                        {% if mlh2 < 0 and (mla2 >= 0 or (0-mlh2) > (0-mla2)) %}
                          {% set winner_2h_ml = r.home_team or '–' %}
                        {% elif mla2 < 0 and (mlh2 >= 0 or (0-mla2) > (0-mlh2)) %}
                          {% set winner_2h_ml = r.away_team or '–' %}
                        {% else %}
                          {% set winner_2h_ml = (r.home_team if (mlh2|abs) >= (mla2|abs) else r.away_team) %}
                        {% endif %}
                      {% elif has_mlh2 %}
                        {% set winner_2h_ml = (r.home_team if mlh2 < 0 else r.away_team) %}
                      {% elif has_mla2 %}
                        {% set winner_2h_ml = (r.away_team if mla2 < 0 else r.home_team) %}
                      {% endif %}
                      <div class="seg">Winner: {{ winner_2h_ml }}</div>
                    {% else %}
                      <div class="seg">Winner: –</div>
                    {% endif %}
                  {% endif %}
                  <div class="seg">Team Totals: {% if total_2h is not none and spread_2h is not none %}{% set home_imp_2h = (total_2h / 2) - (spread_2h / 2) %}{% set away_imp_2h = total_2h - home_imp_2h %}{{ r.away_team or '–' }} {{ '%.1f' % away_imp_2h }} / {{ r.home_team or '–' }} {{ '%.1f' % home_imp_2h }}{% else %}–{% endif %}</div>
                  <div class="seg">Overall: {% if total_2h is not none %}{{ '%.1f' % total_2h }}{% else %}–{% endif %}</div>
                  {% if total_2h is not none and r.market_total_2h_basis is defined and r.market_total_2h_basis %}
                    <div class="seg">
                      <span class="basis-badge {% if r.market_total_2h_basis == 'derived' %}basis-derived{% else %}basis-provider{% endif %}" title="2H total basis: {{ r.market_total_2h_basis }}">{% if r.market_total_2h_basis == 'derived' %}D{% else %}P{% endif %}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="line-row">
                  <div class="seg label">Actuals</div>
                  {% set cls_ats_2h = 'neutral' if (r.ats_result_2h == 'Push') else ('ok' if r.eval_ats_2h_ok else ('bad' if r.ats_result_2h else 'neutral')) %}
                  {# Safe 2H ATS team extraction #}
                  {% set ats_text_2h = (r.ats_result_2h ~ '') %}
                  {% set ats_team_2h = (r.home_team if 'Home' in ats_text_2h else (r.away_team if 'Away' in ats_text_2h else ('Push' if ats_text_2h == 'Push' else None))) %}
                  <div class="seg {{ cls_ats_2h }}">ATS: {% if ats_team_2h == 'Push' %}Push{% elif ats_team_2h %}{{ ats_team_2h }} Cover{% else %}–{% endif %}</div>
                  {# Compute 2H margin from second-half scores (avoid missing actual_margin_2h key) #}
                  {% set hs_ok = (r.home_score is not none and r.home_score == r.home_score) %}
                  {% set as_ok = (r.away_score is not none and r.away_score == r.away_score) %}
                  {% set h1_ok2 = (r.home_score_1h is not none and r.home_score_1h == r.home_score_1h) %}
                  {% set a1_ok2 = (r.away_score_1h is not none and r.away_score_1h == r.away_score_1h) %}
                  {% set home_2h = (r.home_score - r.home_score_1h) if (hs_ok and h1_ok2) else None %}
                  {% set away_2h = (r.away_score - r.away_score_1h) if (as_ok and a1_ok2) else None %}
                  {% set margin_2h = (home_2h - away_2h) if (home_2h is not none and home_2h == home_2h and away_2h is not none and away_2h == away_2h) else None %}
                  {% set winner_team_2h = (r.home_team if (margin_2h is not none and margin_2h>0) else (r.away_team if (margin_2h is not none and margin_2h<0) else ('Push' if (margin_2h is not none and margin_2h == margin_2h and margin_2h == 0) else None))) %}
                  {% set cls_win_2h = 'neutral' if (winner_team_2h == 'Push') else ('ok' if r.eval_winner_2h_ok else ('bad' if winner_team_2h else 'neutral')) %}
                  <div class="seg {{ cls_win_2h }}">Winner: {{ winner_team_2h or '–' }}</div>
                  <div class="seg">Team Totals: {% if hs_ok and as_ok and h1_ok2 and a1_ok2 %}{{ r.away_team or '–' }} {{ r.away_score - r.away_score_1h }} / {{ r.home_team or '–' }} {{ r.home_score - r.home_score_1h }}{% else %}–{% endif %}</div>
                  {% set at2_ok = (r.actual_total_2h is not none and r.actual_total_2h == r.actual_total_2h) %}
                  <div class="seg">Overall: {% if at2_ok %}{{ '%.0f' % r.actual_total_2h }}{% else %}–{% endif %}</div>
                </div>
              </div>
            </div>
          </div>
          {% if r.home_score is not none and r.away_score is not none %}
            {% set hs = r.get('home_score') if r.get('home_score') is not none else 0 %}
            {% set as = r.get('away_score') if r.get('away_score') is not none else 0 %}
            {% set act_tot = r.get('actual_total') if r.get('actual_total') is not none else (hs + as) %}
            <div class="section">
              <div class="title">Final</div>
              <div class="kpi">
                <div class="pill">Total: {{ '%.0f' % act_tot if act_tot is not none and act_tot > 0 else '–' }}</div>
                {% if r.get('pred_total') is not none and act_tot is not none and act_tot > 0 %}
                  <div class="pill">Model Error: {{ '%.1f' % (act_tot - r.get('pred_total')) }}</div>
                {% endif %}
                {% if r.get('market_total') is not none and act_tot is not none and act_tot > 0 %}
                  {% set ou = 'Over' if act_tot > r.get('market_total') else ('Under' if act_tot < r.get('market_total') else 'Push') %}
                  {% set cls = 'neutral' if ou == 'Push' else ('ok' if r.get('eval_ou_ok') else 'bad') %}
                  <div class="pill {{ cls }}">vs {{ 'Last' if r.get('market_basis') == 'last' else 'Market' }}: {{ ou }}</div>
                {% endif %}
                {# Closing spread and total comparison pills removed; no UI elements for closing totals #}
                {% if r.ats_result is defined and r.ats_result %}
                  {% set cls3 = 'neutral' if r.ats_result == 'Push' else ('ok' if r.get('eval_ats_ok') else 'bad') %}
                  <div class="pill {{ cls3 }}">ATS: {{ r.ats_result }}</div>
                {% endif %}
                {% if r.ml_result is defined and r.ml_result %}
                  {% set cls5 = 'neutral' if r.ml_result == 'Push' else ('ok' if r.get('eval_ml_ok') else 'bad') %}
                  <div class="pill {{ cls5 }}">ML: {{ r.ml_result }}</div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          {% if r._odds_list %}
            <div class="kpi mt8">
              {% for o in r._odds_list %}
                <div class="pill">{{ o.book }}: {{ '%.1f' % o.total if o.total is not none else '–' }}</div>
              {% endfor %}
            </div>
          {% endif %}
          {# ATS / Moneyline section removed to reduce duplication #}
        </div>
      {% endfor %}
    </div>
  </div>
  <script>
  (function(){
    document.querySelectorAll('.badge-team').forEach(function(el){
      var bg = el.getAttribute('data-bg');
      if(bg){ el.style.background = bg; }
      var name = el.querySelector('.name');
      if(name){
        var tx = name.getAttribute('data-tx');
        if(tx){ name.style.color = tx; }
      }
    });
    // Render start times in server or user's local timezone with short TZ label.
    // Preference persisted in localStorage ('local' default).
    try {
      var fmtLocal = new Intl.DateTimeFormat(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', timeZoneName:'short'});
      function formatLocalISO(iso){
        try{
          if(!iso) return null;
          var d = new Date(iso);
          if(isNaN(d)) return null;
          return {text: fmtLocal.format(d), title: d.toISOString()};
        }catch(e){ return null; }
      }
      function applyTzMode(mode){
        document.querySelectorAll('.time-local').forEach(function(el){
          if(!el.dataset.server){ el.dataset.server = (el.textContent || '').trim(); }
          if(mode === 'local'){
            var iso = el.getAttribute('data-iso');
            var out = formatLocalISO(iso);
            if(out){ el.textContent = out.text; el.title = out.title; }
          } else {
            if(el.dataset.server){ el.textContent = el.dataset.server; }
          }
        });
      }
      var selTz = document.getElementById('tzMode');
      var prefKey = 'ncaab:tzMode';
      var pref = localStorage.getItem(prefKey) || 'local';
      if(selTz){ selTz.value = (pref === 'server' || pref === 'local') ? pref : 'local'; }
      applyTzMode(selTz ? selTz.value : pref);
      if(selTz){
        selTz.addEventListener('change', function(){
          localStorage.setItem(prefKey, selTz.value);
          applyTzMode(selTz.value);
        });
      }
    } catch(e) { /* noop */ }
    // Auto-set site/server timezone cookie to browser TZ on first visit
    try {
      var tzCookie = document.cookie.split('; ').find(function(x){ return x.startsWith('display_tz='); });
      var tzSetKey = 'ncaab:tzCookieSet';
      if(!tzCookie && !localStorage.getItem(tzSetKey)){
        var tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || '').trim();
        if(tz){
          fetch('/api/set_tz?json=1&tz=' + encodeURIComponent(tz))
            .then(function(){ localStorage.setItem(tzSetKey, '1'); })
            .catch(function(){});
        }
      }
      var btnSetSite = document.getElementById('btnSetSiteTz');
      if(btnSetSite){
        btnSetSite.addEventListener('click', function(){
          var tz = (Intl.DateTimeFormat().resolvedOptions().timeZone || '').trim();
          if(!tz){ return; }
          btnSetSite.disabled = true;
          var txt = btnSetSite.textContent;
          btnSetSite.textContent = 'Setting…';
          fetch('/api/set_tz?json=1&tz=' + encodeURIComponent(tz))
            .then(function(){ btnSetSite.textContent = 'Set Site=My TZ'; btnSetSite.disabled = false; location.reload(); })
            .catch(function(){ btnSetSite.textContent = txt; btnSetSite.disabled = false; });
        });
      }
    } catch(e) { /* noop */ }
    // Optional auto-refresh every 60s (user-controlled); indicate live with title dot if not enabled
    var hasLive = document.querySelector('[data-live="1"]') !== null;
    var chk = document.getElementById('autoRefreshChk');
    var key = 'ncaab:autoRefresh';
    var saved = (localStorage.getItem(key) === '1');
    if (chk) {
      chk.checked = saved;
      chk.addEventListener('change', function(){
        localStorage.setItem(key, chk.checked ? '1' : '0');
      });
    }
    if(saved){
      setTimeout(function(){ location.reload(); }, 60000);
    } else if (hasLive) {
      document.title = '• ' + document.title;
    }
    // Guarded Finalize via AJAX (POST + confirm)
    var btn = document.getElementById('btnFinalize');
    if(btn){
      btn.addEventListener('click', function(){
        var dateVal = btn.getAttribute('data-date');
        if(!dateVal){ return; }
        var proceed = confirm('Finalize ' + dateVal + '? This closes out results.');
        if(!proceed){ return; }
        btn.disabled = true;
        var prevText = btn.textContent;
        btn.textContent = 'Finalizing…';
        fetch('/api/finalize-day', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateVal, confirm: true })
        })
          .then(function(r){ return r.json(); })
          .then(function(j){
            btn.textContent = prevText;
            btn.disabled = false;
            var ok = j && (j.ok || j.status === 'ok');
            showToast(ok ? ('Finalized ' + dateVal) : ('Finalize failed: ' + (j && j.error ? j.error : 'Unknown')),
              ok ? 'ok' : 'bad');
            if(ok){ setTimeout(function(){ location.reload(); }, 800); }
          })
          .catch(function(e){
            btn.textContent = prevText;
            btn.disabled = false;
            showToast('Finalize failed', 'bad');
          });
      });
    }
    function showToast(msg, kind){
      var t = document.createElement('div');
      t.className = 'toast ' + (kind||'');
      t.textContent = msg;
      document.body.appendChild(t);
      requestAnimationFrame(function(){ t.classList.add('show'); });
      setTimeout(function(){ t.classList.remove('show'); setTimeout(function(){ t.remove(); }, 300); }, 2200);
    }
  })();
  // Toggle raw vs calibrated total inline without reloading
  function toggleRaw(el){
    if(!el) return;
    var cal = el.getAttribute('data-cal');
    var raw = el.getAttribute('data-raw');
    var parent = el.parentElement;
    if(!parent) return;
    var showingRaw = el.getAttribute('data-state') === 'raw';
    var newVal = showingRaw ? cal : raw;
    // Replace first numeric occurrence after 'Total:' (simple heuristic)
    var re = /Total:\s*[0-9]+(\.[0-9])?/;
    parent.innerHTML = parent.innerHTML.replace(re, 'Total: ' + newVal);
    el.setAttribute('data-state', showingRaw ? 'cal' : 'raw');
    el.title = showingRaw ? 'Click to show raw model' : 'Click to show calibrated';
  }
  </script>
</body>
</html>
