name: CI Synthetic Harness

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * *'  # 13:00 UTC daily (~8am ET)

jobs:
  synthetic-e2e:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path 'requirements.txt') { pip install -r requirements.txt }
          if (Test-Path 'pyproject.toml') { pip install -e . }

      - name: Run synthetic harness
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          ./scripts/ci_synthetic.ps1

      - name: Evaluate thresholds and fail if breached
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $path = Join-Path $PWD 'outputs/synthetic_summary.json'
          if (!(Test-Path $path)) { Write-Host "No summary found at $path"; exit 1 }
          $json = Get-Content $path -Raw | ConvertFrom-Json
          # Example keys: auc_total, ece_total, sharp_total
          $aucT = [double]$json.auc_total
          $eceT = [double]$json.ece_total
          $sharpT = [double]$json.sharp_total
          Write-Host "AUC Total=$aucT; ECE Total=$eceT; Sharp Total=$sharpT"
          $fail = $false
          if ($aucT -lt 0.60) { Write-Warning 'AUC Total below 0.60'; $fail = $true }
          if ($eceT -gt 0.12) { Write-Warning 'ECE Total above 0.12'; $fail = $true }
          if ($sharpT -lt 0.50) { Write-Warning 'Sharpness Total below 0.50'; $fail = $true }
          if ($fail) { Write-Error 'Synthetic thresholds breached'; exit 1 }

      - name: Comment PR with summary (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const p = `${process.env.GITHUB_WORKSPACE}/outputs/synthetic_summary.json`;
            if (!fs.existsSync(p)) { core.warning('No synthetic summary found'); return; }
            const j = JSON.parse(fs.readFileSync(p, 'utf8'));
            const body = `Synthetic E2E Summary\n\n- AUC Total: ${j.auc_total}\n- ECE Total: ${j.ece_total}\n- Sharp Total: ${j.sharp_total}\n- Rows: ${j.rows || 'n/a'}\n\nWorkflow: ${process.env.GITHUB_WORKFLOW}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: synthetic-summary
          path: outputs/synthetic_summary.json
          if-no-files-found: ignore

  backtest-nightly:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path 'requirements.txt') { pip install -r requirements.txt }
          if (Test-Path 'pyproject.toml') { pip install -e . }

      - name: Run walk-forward backtest (last 28 days)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          python -m src.ncaab_model.cli backtest-walkforward

      - name: Upload backtest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-artifacts
          path: |
            outputs/backtest_summary.json
            outputs/backtest_daily.csv
          if-no-files-found: ignore

      - name: Gate minimal backtest thresholds
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $sum = Get-Content (Join-Path $PWD 'outputs/backtest_summary.json') -Raw | ConvertFrom-Json
          $hit = [double]$sum.hit_rate
          $bets = [int]$sum.total_bets
          $mae = $sum.mae_total
          $brierATS = $sum.brier_ats
          $brierOU = $sum.brier_ou
          $aucATS = $sum.auc_ats
          $aucOU = $sum.auc_ou
          $crpsTotal = $sum.crps_total
          Write-Host "Backtest hit_rate=$hit; total_bets=$bets"
          if ($bets -lt 20) { Write-Warning 'Too few bets in window'; exit 1 }
          if ($hit -lt 0.50) { Write-Warning 'Hit rate below 50%'; exit 1 }
          if ($mae -and ([double]$mae -gt 10.0)) { Write-Warning "MAE Total too high: $mae"; exit 1 }
          if ($brierATS -and ([double]$brierATS -gt 0.25)) { Write-Warning "Brier ATS too high: $brierATS"; exit 1 }
          if ($brierOU -and ([double]$brierOU -gt 0.25)) { Write-Warning "Brier OU too high: $brierOU"; exit 1 }
          if ($aucATS -and ([double]$aucATS -lt 0.55)) { Write-Warning "AUC ATS too low: $aucATS"; exit 1 }
          if ($aucOU -and ([double]$aucOU -lt 0.55)) { Write-Warning "AUC OU too low: $aucOU"; exit 1 }
          if ($crpsTotal -and ([double]$crpsTotal -gt 9.0)) { Write-Warning "CRPS Total too high: $crpsTotal"; exit 1 }
