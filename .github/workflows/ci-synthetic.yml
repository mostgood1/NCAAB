name: CI Synthetic Harness

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * *'  # 13:00 UTC daily (~8am ET)

jobs:
  synthetic-e2e:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path 'requirements.txt') { pip install -r requirements.txt }
          if (Test-Path 'pyproject.toml') { pip install -e . }

      - name: Run synthetic harness
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          ./scripts/ci_synthetic.ps1

      - name: Evaluate thresholds and fail if breached
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $path = Join-Path $PWD 'outputs/synthetic_summary.json'
          if (!(Test-Path $path)) { Write-Host "No summary found at $path"; exit 1 }
          $json = Get-Content $path -Raw | ConvertFrom-Json
          # Example keys: auc_total, ece_total, sharp_total
          $aucT = [double]$json.auc_total
          $eceT = [double]$json.ece_total
          $sharpT = [double]$json.sharp_total
          Write-Host "AUC Total=$aucT; ECE Total=$eceT; Sharp Total=$sharpT"
          $fail = $false
          if ($aucT -lt 0.60) { Write-Warning 'AUC Total below 0.60'; $fail = $true }
          if ($eceT -gt 0.12) { Write-Warning 'ECE Total above 0.12'; $fail = $true }
          if ($sharpT -lt 0.50) { Write-Warning 'Sharpness Total below 0.50'; $fail = $true }
          if ($fail) { Write-Error 'Synthetic thresholds breached'; exit 1 }

      - name: Comment PR with summary (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const p = `${process.env.GITHUB_WORKSPACE}/outputs/synthetic_summary.json`;
            if (!fs.existsSync(p)) { core.warning('No synthetic summary found'); return; }
            const j = JSON.parse(fs.readFileSync(p, 'utf8'));
            const body = `Synthetic E2E Summary\n\n- AUC Total: ${j.auc_total}\n- ECE Total: ${j.ece_total}\n- Sharp Total: ${j.sharp_total}\n- Rows: ${j.rows || 'n/a'}\n\nWorkflow: ${process.env.GITHUB_WORKFLOW}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: synthetic-summary
          path: outputs/synthetic_summary.json
          if-no-files-found: ignore
